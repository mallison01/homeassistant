# ==============================================================================
# Smart Room Lighting v5.6.0
# ==============================================================================
# Automated lighting control with flexible triggers (motion, door, entity state, 
# button, sun elevation, ambient light, time-based), optional occupancy tracking,
# scene support, night lights, manual control cooldown, turn-off-only devices,
# dynamic lighting, presence detection, override mode, and power recovery.
#
# For complete changelog and version history, see: CHANGELOG_AND_COMMENTS.md
# ==============================================================================

blueprint:
  name: "Smart Room Lighting v5.6.0"

  description: >
    ## ðŸŽ¯ What This Does

    Turns lights on and off based on motion sensors, door sensors, schedules, or other triggers.
    Two modes available: simple trigger-based or occupancy tracking with state machine.

    ---

    ## ðŸ“Œ Operating Modes

    ### Simple Mode
    Any configured trigger turns lights on. When all triggers turn off, waits for a delay period,
    then turns lights off.

    ### Occupancy Mode
    Tracks whether someone is in a room using door and motion sensors together. Uses four input_boolean
    helpers to track entry, exit, and occupancy states. Prevents lights from turning off when someone
    is in the room but not moving.

    ## ðŸ”§ Setup Requirements

    **Simple Mode:**
      - At least one binary sensor (motion, door, or schedule)
      - Lights, switches, or scenes to control
      - Optional: Manual control helper and cooldown helper for turn-off protection

    **Occupancy Mode:**
      - At least one motion sensor
      - At least one door sensor
      - Four input_boolean helpers (create in Settings â†’ Helpers)
      - Lights, switches, or scenes to control
      - Optional: Manual control helper and cooldown helper for turn-off protection


    ## ðŸ“ Setup Steps

    **1. Create Helpers** (Occupancy Mode only)
      - Go to Settings â†’ Devices & Services â†’ Helpers
      - Create four Toggle helpers:
        * [Room Name] Occupied
        * [Room Name] Entering
        * [Room Name] Entered
        * [Room Name] Exiting

    **2. Choose Mode**
      - Select Simple Mode or Occupancy Mode

    **3. Configure Sensors**
      - Simple Mode: Select trigger sensors
      - Occupancy Mode: Select motion and door sensors

    **4. Configure Lights**
      - Choose Individual Lights, Scenes, or Both
      - Select your lights/switches or scenes

    **5. Assign Helpers** (Occupancy Mode only)
      - Assign the four helpers you created

    **6. Adjust Timing** (Occupancy Mode only)
      - Entry Delay: Wait time after door opens (default: 10s)
      - Motion Timeout: Wait time after door closes â€” must be longer than sensor timeout (default: 21s)
      - Motion Gap Timeout: Idle time with door open (default: 90s)
      - Maximum Idle Time: Max time without motion when occupied (default: 15 min)

    **7. Configure Optional Features**
      - Dynamic lighting control (adaptive brightness/color)
      - Presence detection (still mode)
      - Entity state triggers (on/off transitions)
      - Push button triggers (on/off commands)
      - Sun elevation triggers (automatic dusk/dawn)
      - Ambient light triggers (lux-based on/off)
      - Time-based triggers (scheduled on/off)
      - Override mode
      - Power outage recovery
      - Illuminance sensor
      - Time restrictions
      - Night lights
      - Bypass switches
      - Device tracker
      - Manual control cooldown

  domain: automation

  input:
    mode_selection:
      name: "Operating Mode"
      icon: mdi:cog-outline
      collapsed: false
      input:
        operating_mode:
          name: "Automation Operating Mode"
          description: >
            Choose which mode this automation uses.

            **Simple Mode:**
              - Uses trigger sensors
              - Lights turn off after time delay
              - For basic motion/door activated lighting

            **Occupancy Mode:**
              - Uses motion and door sensors with state tracking
              - Requires 4 input_boolean helpers
              - Tracks room occupancy to prevent unexpected shutoffs
          selector:
            select:
              options:
                - label: Simple Mode
                  value: simple
                - label: Occupancy Mode
                  value: occupancy
              sort: false
          default: simple

    automation_behavior:
      name: "Automation Behavior (Global)"
      icon: mdi:cog-transfer
      collapsed: true
      input:
        light_control_behavior:
          name: "Light Control Behavior"
          description: >
            Choose what the automation should control:
            **Turn ON and OFF** - Full automation (lights turn on when triggered, turn off when conditions clear)
            **Only Turn ON** - Automation only turns lights on, never turns them off (useful if you want manual control of turning off)
            **Only Turn OFF** - Automation only turns lights off, never turns them on (useful for bedrooms - manually turn on lights, automation turns them off when you leave the room)
            **Examples:**
              - Bedroom: Use "Only Turn OFF" - manually turn on lights, automation turns them off when you leave the room
              - Closet: Use "Turn ON and OFF" - full automation
              - Bathroom: Use "Turn ON and OFF" with occupancy mode for intelligent control
          selector:
            select:
              options:
                - label: Turn ON and OFF (Full Automation)
                  value: on_and_off
                - label: Only Turn ON (Manual Turn Off)
                  value: only_on
                - label: Only Turn OFF (Manual Turn On)
                  value: only_off
              sort: false
          default: on_and_off


    trigger_sensor:
      name: "Trigger - Sensor (Simple Mode)"
      icon: mdi:motion-sensor
      collapsed: true
      input:
        trigger_sensor:
          name: "Trigger Sensor(s)"
          description: >
            **Simple Mode only** â€” Select sensors or schedules that trigger the automation.

              â€¢ When any trigger turns on, lights turn on
              â€¢ When all triggers turn off, timer starts
              â€¢ Supports motion sensors, door sensors, schedules, or any binary sensor

            Ignored in Occupancy Mode.
          default: []
          selector:
            entity:
              filter:
                - domain:
                    - binary_sensor
                    - schedule
              multiple: true
        time_delay:
          name: "Time Delay"
          description: >
            **Simple Mode only** â€” How long to wait after all triggers turn off before turning off lights.

            Ignored in Occupancy Mode.
          default: 5
          selector:
            number:
              min: 0.0
              max: 30.0
              step: 0.5
              unit_of_measurement: minutes
              mode: slider
        manual_control_simple_helper:
          name: Manual Control Helper (Simple Mode)
          description: >
            **Simple Mode only** â€” Helper that tracks manual light control.

            **When to use:** If you want to manually turn off lights while still in the room
            and then exit without lights turning back on as you leave.

            **How it works:**
              - You turn off lights manually while triggers are active (motion sensor still detecting)
              - External automation sets this helper to OFF
              - This blueprint detects the OFF state and starts a cooldown period
              - During cooldown, automation won't turn lights back on even if triggers fire
              - After cooldown expires, normal automation resumes

            **Setup:**
              1. Create helper: Settings â†’ Helpers â†’ Toggle â†’ Name: "[Room] Manual Control"
              2. Create separate automation that:
                 - Turns this helper ON when lights are manually turned ON
                 - Turns this helper OFF when lights are manually turned OFF
                 - Does NOT change when this automation turns lights on/off
              3. Select the helper here
              4. Configure cooldown timer below

              Leave empty to disable this feature.
          default: []
          selector:
            entity:
              domain: input_boolean
        cooldown_simple_helper:
          name: Cooldown Active Helper (Simple Mode)
          description: >
            **Simple Mode only** â€” Helper to block automation during cooldown after manual turn-off.

            **Setup:** Settings â†’ Helpers â†’ Toggle â†’ Name: "[Room] Cooldown Active"

            This blueprint manages this helper automatically. You don't need to do anything with it
            except create it and select it here.

            Required if using manual control feature. Leave empty if not using.
          default: []
          selector:
            entity:
              domain: input_boolean
        manual_control_simple_cooldown:
          name: Manual Control Cooldown (Simple Mode)
          description: >
            **Simple Mode only** â€” After manually turning off lights, wait this long before allowing
            automation to turn lights back on.

            **Purpose:** Gives you time to walk out of the room without lights turning back on
            from triggers (like motion sensors or door sensors).

            **Example scenario:**
              - You're in a closet, lights are on
              - You manually turn off the lights
              - Cooldown starts (30 seconds)
              - You walk out, motion sensor triggers as you leave
              - Lights stay OFF during cooldown (you can exit safely)
              - After 30 seconds, automation resumes normal operation

            Adjust based on how long it takes to exit your room.
          default: 30
          selector:
            number:
              min: 5.0
              max: 120.0
              unit_of_measurement: seconds
              mode: slider
              step: 5.0

    trigger_entity:
      name: "Trigger - Entity State (Simple Mode)"
      icon: mdi:cog-outline
      collapsed: true
      input:
        include_entity_state:
          name: Use The Entity State Option (Optional)
          description: >
            **Simple Mode only** â€” Trigger automation based on another entity's state changes.

              â€¢ When entity changes from OFF to ON, lights turn on
              â€¢ When entity changes from ON to OFF, lights turn off
              â€¢ Supports any entity with ON/OFF states
              â€¢ Choose ON trigger, OFF trigger, or both

            Ignored in Occupancy Mode.
          default: []
          selector:
            select:
              multiple: true
              options:
              - label: ON State
                value: entity_on
              - label: OFF State
                value: entity_off
              sort: false
              custom_value: false
        entity_input:
          name: Input Entity
          description: >
            **Simple Mode only** â€” Select an entity with ON/OFF states to monitor.

            Examples: input_boolean helpers, switches, other automations, media players, or any entity with clear ON/OFF states.

            Ignored in Occupancy Mode.
          default: []
          selector:
            entity: {}

    trigger_button:
      name: "Trigger - Push Button (Simple Mode)"
      icon: mdi:gesture-tap-button
      collapsed: true
      input:
        include_button:
          name: Use The Push Button Option (Optional)
          description: >
            **Simple Mode only** â€” Trigger automation when a button is pressed.

              â€¢ Press button to turn lights ON, OFF, or both
              â€¢ Supports physical buttons, wireless switches, or button entities
              â€¢ Each press triggers immediate action
              â€¢ Choose ON trigger, OFF trigger, or both

            Ignored in Occupancy Mode.
          default: []
          selector:
            select:
              multiple: true
              options:
              - label: Push Button ON
                value: button_on
              - label: Push Button OFF
                value: button_off
              sort: false
              custom_value: false
        button_input:
          name: Input Button Entity
          description: >
            **Simple Mode only** â€” Select button entity to monitor for presses.

            Examples: Zigbee buttons, Z-Wave switches, MQTT buttons, or input_button helpers.

            Ignored in Occupancy Mode.
          default: []
          selector:
            entity: {}

    trigger_sun:
      name: "Trigger - Sun Elevation (Simple Mode)"
      icon: mdi:weather-sunny
      collapsed: true
      input:
        include_sun:
          name: Use The Sun Option (Optional)
          description: >
            **Simple Mode only** â€” Trigger automation based on sun position (automatic dusk/dawn).

              â€¢ When sun falls below threshold, lights turn on
              â€¢ When sun rises above threshold, lights turn off
              â€¢ Perfect for automatic outdoor lights or ambient indoor lighting
              â€¢ Choose falling trigger (ON), rising trigger (OFF), or both

            Ignored in Occupancy Mode.
          default: []
          selector:
            select:
              multiple: true
              options:
              - label: Sun Elevation Falling - ON
                value: sun_falling
              - label: Sun Elevation Rising - OFF
                value: sun_rising
              sort: false
              custom_value: false
        sun_elevation:
          name: Sun Elevation Falling
          description: >
            **Simple Mode only** â€” Sun angle for turning lights ON (sunset/dusk).

            Negative values mean sun is below horizon. Examples:
              â€¢ -1.5Â° = Civil dusk (still some light)
              â€¢ -4.0Â° = Nautical dusk (darker)
              â€¢ -6.0Â° = True dusk (quite dark)

            The automation will only turn lights ON when the sun is falling below this threshold.

            Ignored in Occupancy Mode.
          default: -1.5
          selector:
            number:
              min: -10.0
              max: 5.0
              step: 0.5
              unit_of_measurement: degrees
              mode: slider
        sun_elevation_rising:
          name: Sun Elevation Rising
          description: >
            **Simple Mode only** â€” Sun angle for turning lights OFF (sunrise/dawn).

            Negative values mean sun is below horizon. Examples:
              â€¢ -6.0Â° = True dawn (still dark)
              â€¢ -4.0Â° = Nautical dawn (getting lighter)
              â€¢ -1.5Â° = Civil dawn (light enough)

            The automation will only turn lights OFF when the sun is rising above this threshold.

            Tip: Set this higher than the ON threshold for proper hysteresis (prevents rapid on/off cycling).

            Ignored in Occupancy Mode.
          default: -4.0
          selector:
            number:
              min: -10.0
              max: 5.0
              step: 0.5
              unit_of_measurement: degrees
              mode: slider

    trigger_ambient:
      name: "Trigger - Ambient (Simple Mode)"
      icon: mdi:theme-light-dark
      collapsed: true
      input:
        include_ambient:
          name: Use The Ambient Option (Optional)
          description: >
            **Simple Mode only** â€” Trigger automation based on room brightness (lux sensor).

              â€¢ When lux falls below low threshold, lights turn on
              â€¢ When lux rises above high threshold, lights turn off
              â€¢ Perfect for rooms with variable natural light
              â€¢ Choose low lux trigger (ON), high lux trigger (OFF), or both

            Ignored in Occupancy Mode.
          default: []
          selector:
            select:
              multiple: true
              options:
              - label: Low Lux Value - ON
                value: ambient_low
              - label: High Lux Value - OFF
                value: ambient_high
              sort: false
              custom_value: false
        ambient_light_sensor:
          name: Ambient Light Sensor
          description: >
            **Simple Mode only** â€” Illuminance sensor to monitor room brightness.

            Must be a sensor with device_class: illuminance, reporting lux values.

            Ignored in Occupancy Mode.
          default: []
          selector:
            entity:
              filter:
              - domain:
                - sensor
                device_class:
                - illuminance
              reorder: false
              multiple: false
        ambient_light_value:
          name: Ambient Light - Low Lux Value
          description: >
            **Simple Mode only** â€” Brightness threshold for turning lights ON.

            When room brightness falls below this value, lights turn on.
            Must be equal to or lower than the High Lux Value.

            Typical values: 20 lux = dusk, 50 lux = dim room, 100 lux = overcast day.

            Ignored in Occupancy Mode.
          default: 20
          selector:
            number:
              min: 0.0
              max: 500.0
              step: 10.0
              unit_of_measurement: lux
              mode: slider
        ambient_light_value_off:
          name: Ambient Light - High Lux Value
          description: >
            **Simple Mode only** â€” Brightness threshold for turning lights OFF.

            When room brightness rises above this value, lights turn off.
            Must be equal to or higher than the Low Lux Value.

            Typical values: 80 lux = dawn, 150 lux = bright room, 300 lux = sunny day.
            Setting higher than Low Lux Value creates hysteresis to prevent flickering.

            Ignored in Occupancy Mode.
          default: 80
          selector:
            number:
              min: 0.0
              max: 1000.0
              step: 10.0
              unit_of_measurement: lux
              mode: slider

    trigger_time:
      name: "Trigger - Time (Simple Mode)"
      icon: mdi:clock-outline
      collapsed: true
      input:
        include_time_trigger:
          name: Use The Time Options (Optional)
          description: >
            **Simple Mode only** â€” Trigger automation at specific times of day.

              â€¢ At ON Time, lights turn on
              â€¢ At OFF Time, lights turn off
              â€¢ Perfect for scheduled lighting (e.g., sunset simulation)
              â€¢ Choose ON time trigger, OFF time trigger, or both

            Ignored in Occupancy Mode.
          default: []
          selector:
            select:
              multiple: true
              options:
              - label: ON Time
                value: time_on
              - label: OFF Time
                value: time_off
              sort: false
              custom_value: false
        time_trigger_on:
          name: ON Time
          description: >
            **Simple Mode only** â€” Time of day to turn lights ON.

            Lights will turn on at this exact time if automation conditions are met.

            Ignored in Occupancy Mode.
          default: 00:00:00
          selector:
            time: {}
        time_trigger_off:
          name: OFF Time
          description: >
            **Simple Mode only** â€” Time of day to turn lights OFF.

            Lights will turn off at this exact time.

            Ignored in Occupancy Mode.
          default: 00:00:00
          selector:
            time: {}

    occupancy_settings:
      name: "Occupancy Mode Settings"
      icon: mdi:account-check-outline
      collapsed: true
      input:
        motion_sensor:
          name: "Motion Sensor(s)"
          description: >
            **Occupancy Mode only** â€” Motion sensors that detect presence.

            **Requirements:**
              â€¢ binary_sensor with device_class: motion or occupancy
              â€¢ Multiple sensors supported (any motion = presence detected)
            
              **Note:** Sensors showing 'unavailable' or 'unknown' are treated as 'off' to prevent
              automation failures. Ensure sensors are reliable and properly configured.
          default: []
          selector:
            entity:
              filter:
                - domain: binary_sensor
                  device_class:
                    - motion
                    - occupancy
              multiple: true
        door_sensor:
          name: "Door Sensor(s)"
          description: >
            **Occupancy Mode only** â€” Door/window sensors that detect entry/exit.

              **Requirements:**
              â€¢ binary_sensor with device_class: door, opening, or window
              â€¢ Multiple sensors supported (any door = entry/exit detected)
            
            **Note:** Sensors showing 'unavailable' or 'unknown' are treated as 'off' to prevent
            automation failures. Ensure sensors are reliable and properly configured.
          default: []
          selector:
            entity:
              filter:
                - domain: binary_sensor
                  device_class:
                    - door
                    - opening
                    - window
              multiple: true
        use_manual_control:
          name: "Monitor Manual Control"
          description: >
            **Occupancy Mode only** â€” Monitor when lights are turned off manually.

              **When to use:** If you want to manually turn off lights while still in the room
              and then exit without lights turning back on as you leave.

            **How it works:**
              - You're in the room with lights on (occupancy helper is ON)
              - You manually turn off lights
              - External automation sets manual control helper to OFF
              - This blueprint detects the OFF state and starts a cooldown period
              - All occupancy helpers are reset immediately
              - During cooldown, automation won't turn lights back on even if motion/door triggers fire
              - After cooldown expires, normal automation resumes
            
            **IMPORTANT LIMITATION:** Due to restart mode, if door/motion triggers fire during the
            manual control timeout period, the timeout check will restart and may not complete.
            For best results, configure the external automation to only set the manual control
            helper when you're certain manual control was intended.

            Requires a separate automation to manage the manual control helper (see below).
          default: false
          selector:
            boolean: {}
        manual_control_helper:
          name: Manual Control Helper
          description: >
            input_boolean helper that tracks manual light control.

            **Setup:**
              1. Create helper: Settings â†’ Helpers â†’ Toggle â†’ Name: "[Room] Manual Control"
              2. Create separate automation that:
                 - Turns this helper ON when lights are manually turned ON
                 - Turns this helper OFF when lights are manually turned OFF
                 - Does NOT change when this automation turns lights on/off
              3. Select the helper here

            Leave empty to disable this feature.
          default: []
          selector:
            entity:
              domain: input_boolean
        cooldown_helper:
          name: Cooldown Active Helper
          description: >
            Helper to block automation during cooldown after manual turn-off.

            **Setup:** Settings â†’ Helpers â†’ Toggle â†’ Name: "[Room] Cooldown Active"

            This blueprint manages this helper automatically. You don't need to do anything
            with it except create it and select it here.

            Required if using manual control feature. Leave empty if not using.
          default: []
          selector:
            entity:
              domain: input_boolean
        manual_control_timeout:
          name: Manual Control Timeout
          description: >
            Wait time after manually turning lights ON before checking for occupancy.

            **How it works:**
              - You manually turn lights ON (manual control helper goes ON)
              - Automation waits this amount of time
              - If occupancy is detected during wait: clears manual control flag, continues normally
              - If no occupancy detected: turns lights off (you turned them on by mistake)

            **Purpose:** Prevents lights staying on if you accidentally turned them on when no one is entering.
          default: 30
          selector:
            number:
              min: 10.0
              max: 300.0
              unit_of_measurement: seconds
              mode: slider
              step: 5.0
        manual_control_cooldown:
          name: Manual Control Cooldown
          description: >
            After manually turning off lights, wait this long before allowing automation
            to turn lights back on.

            **Purpose:** Gives you time to walk out of the room without lights turning back on
            from triggers (like motion sensors or door sensors).

            **Example scenario:**
              - You're in bathroom, lights are on, occupancy helper is ON
              - You manually turn off the lights
              - Cooldown starts (30 seconds)
              - All occupancy helpers reset immediately
              - You walk to the door, motion sensor and door sensor trigger as you leave
              - Lights stay OFF during cooldown (you can exit safely)
              - After 30 seconds, automation resumes normal operation

            Adjust based on how long it takes to exit your room.
          default: 30
          selector:
            number:
              min: 5.0
              max: 120.0
              unit_of_measurement: seconds
              mode: slider
              step: 5.0

    helpers:
      name: "Occupancy Helpers (Required for Occupancy Mode)"
      icon: mdi:home-assistant
      collapsed: true
      input:
        occupancy_helper:
          name: "Occupied Helper"
          description: >
            input_boolean that tracks if room is occupied.

              â€¢ ON = Room occupied (person inside, door closed)
              â€¢ OFF = Room empty

            **Create:** Settings â†’ Helpers â†’ Toggle â†’ Name: "[Room] Occupied"
          default: ""
          selector:
            entity:
              domain: input_boolean
        entering_helper:
          name: "Entering Helper"
          description: >
            input_boolean that tracks entry sequence.

              â€¢ ON = Entry started (door opened, waiting for motion)
              â€¢ OFF = Not in entry sequence

            **Create:** Settings â†’ Helpers â†’ Toggle â†’ Name: "[Room] Entering"
          default: ""
          selector:
            entity:
              domain: input_boolean
        entered_helper:
          name: "Entered Helper"
          description: >
            input_boolean that confirms entry (motion detected).

              â€¢ ON = Person entered, door still open
              â€¢ OFF = Entry not confirmed

            **Create:** Settings â†’ Helpers â†’ Toggle â†’ Name: "[Room] Entered"
          default: ""
          selector:
            entity:
              domain: input_boolean
        exiting_helper:
          name: "Exiting Helper"
          description: >
            input_boolean that tracks exit sequence.

              â€¢ ON = Exit started (door opened while occupied)
              â€¢ OFF = Not in exit sequence

            **Create:** Settings â†’ Helpers â†’ Toggle â†’ Name: "[Room] Exiting"
          default: ""
          selector:
            entity:
              domain: input_boolean
    timing:
      name: "Timing Settings (Occupancy Mode)"
      icon: mdi:timer-outline
      collapsed: true
      input:
        entry_delay:
          name: Entry Detection Delay
          description: >
            Wait time after door opens before turning off if no motion detected.

            Gives time for motion sensor to detect entry. If no motion: door opened but no one entered.
          default: 10
          selector:
            number:
              min: 5.0
              max: 30.0
              unit_of_measurement: seconds
              mode: slider
              step: 1.0
        motion_timeout:
          name: Motion Sensor Timeout
          description: >
            Wait time after door closes before checking motion status.

            **IMPORTANT:** Must be 1-2 seconds longer than your motion sensor's hardware timeout.

            Motion sensors have a built-in delay before reporting 'off'. If this value is too short,
            the automation thinks there's no motion when the sensor just hasn't reset yet.

            **How to find:** Trigger motion, stop moving, count how long sensor stays 'on', then add 2 seconds.
          default: 21
          selector:
            number:
              min: 15.0
              max: 60.0
              unit_of_measurement: seconds
              mode: slider
              step: 1.0
        motion_gap_timeout:
          name: Presence Detection Gap Timeout
          description: >
            Wait time after presence detection stops before clearing occupancy.
            
            Applies to BOTH motion sensors AND Presence Detection sensors (if enabled).
            
            **Use cases:**
              - Door remains open after entry and motion stops
              - Still mode sensor (pressure/mmWave) briefly loses detection
              - Debouncing for sensors with intermittent detection
              - Person temporarily gets up from chair/bed
              - Exit sequences when checking for remaining occupants
            
            This prevents occupancy from clearing due to brief detection gaps.
            Should be longer than your sensors' hardware timeout periods.
            
            **Multi-person rooms:** When someone exits (door opens then closes), waits this timeout
            before clearing occupancy. If still mode sensors detect someone remaining, occupancy stays ON.
            
            **Recommended**: 90-120 seconds for most spaces. Increase if you frequently remain still
            in the space with the door open or if still mode sensors have detection gaps.

          default: 90
          selector:
            number:
              min: 30.0
              max: 300.0
              unit_of_measurement: seconds
              mode: slider
              step: 10.0
        max_idle_time:
          name: "Maximum Idle Time"
          description: >
            **Occupancy Mode only** â€” Maximum time without motion when room is occupied and door is closed.

            Prevents lights staying on indefinitely if someone leaves without triggering the door sensor.

            In Simple Mode, use "Time Delay" instead.
          default: 15
          selector:
            number:
              min: 5.0
              max: 60.0
              unit_of_measurement: minutes
              mode: slider
              step: 1.0
    still_mode:
      name: "Presence Detection (Global)"
      icon: mdi:account-check
      collapsed: true
      input:
        use_presence_detection:
          name: Use Presence Detection
          description: >
            Enable secondary sensors to detect stationary presence.
            
            **Solves the problem:** Lights turning off when you're still but not moving.
            
            **How it works:**
              - Primary motion sensor times out (no movement detected)
              - Before turning lights off, checks secondary sensors
              - If any secondary sensor is active, keeps lights on
              - Perfect for: working at desk, watching TV, reading in bed
            
            **Timing behavior:**
              â€¢ **Occupancy Mode:** Uses Presence Detection Gap Timeout (default: 90s) as grace period
              â€¢ **Simple Mode:** Checks immediately when Time Delay expires
            
            **Good secondary sensors:**
              - mmWave presence sensors (state: on/detected/occupied)
              - Pressure sensors (chair, bed) (state: on)
              - Media player states (state: playing/on)
              - Door sensors (closed = occupied) (state: off for closed doors)
              - Person entities (state: home)
              - Any binary sensor indicating presence
            
            **Detected states:** on, playing, home, occupied, detected
            
            **Applies to:** Both Simple Mode and Occupancy Mode.
          default: false
          selector:
            boolean: {}
        presence_detection_sensors:
          name: Presence Detection Sensors
          description: >
            Select sensors that indicate stationary presence.
            
            **Examples:**
              - binary_sensor.desk_chair_occupied
              - binary_sensor.bed_occupancy  
              - binary_sensor.couch_presence
              - media_player.tv (checks for playing state)
              - binary_sensor.office_door (if closed indicates still in room)
              - person.john (if state is 'home')
            
            **Logic:** If ANY of these sensors are in states: on, playing, home, occupied, or detected,
            the automation considers the room occupied even without motion.
            
            Leave empty to disable this feature.
          default: []
          selector:
            entity:
              multiple: true

    turn_off_only_devices:
      name: "Turn OFF Only Devices (Global)"
      icon: mdi:power-plug-off-outline
      collapsed: true
      input:
        use_turn_off_only:
          name: Use Turn OFF Only Devices
          description: >
            Enable automatic turn-off of additional devices when room becomes unoccupied.
            This feature works in both **Simple Mode** and **Occupancy Mode**.

            **What it does:**
              - These devices are NEVER turned on by automation
              - They ONLY turn off when the main lights turn off
              - Perfect for fans, auxiliary lights, heaters, or any device you control manually

            **Use case example:**
              - Bathroom: Main lights automated, exhaust fan turns off when leaving
              - Bedroom: Main lights on "Only Turn OFF" mode, ceiling fan also turns off
              - Office: Desk lamp turns off with main lights

            Leave disabled if you don't need this feature.
          default: false
          selector:
            boolean: {}
        turn_off_only_entities:
          name: Turn OFF Only Devices
          description: >
            Select lights, switches, fans, or other devices to turn off when room becomes unoccupied.

            **Important:**
              - These devices will ONLY be turned off, never turned on
              - They turn off at the same time as the main lights
              - You must manually turn them on (or use another automation)
              - Multiple devices can be selected

            **Good for:**
              - Ceiling fans
              - Exhaust fans
              - Space heaters
              - Auxiliary lights
              - Humidifiers/dehumidifiers
              - Any device that shouldn't auto-activate

            Leave empty to disable this feature.
          default: {}
          selector:
            target:
              entity:
                - domain:
                    - light
                    - switch
                    - fan

    lights_settings:
      name: "Lights"
      icon: mdi:lightbulb-outline
      collapsed: true
      input:
        light_control_type:
          name: Light Control Type
          description: >
            How to control lighting:

              â€¢ **Individual Lights/Devices** â€” Control specific light entities or switches
              â€¢ **Scenes** â€” Activate a scene or script
              â€¢ **Both** â€” Control lights and activate a scene at the same time
          selector:
            select:
              options:
                - label: Individual Lights/Devices
                  value: devices
                - label: Scenes
                  value: scenes
                - label: Both (Lights + Scenes)
                  value: both
          default: devices
        light_switch:
          name: Lights / Switches
          description: >
            Select lights or switches to turn on.

            Used when "Individual Lights/Devices" or "Both" is selected.
          default: {}
          selector:
            target:
              entity:
                - domain:
                    - light
                    - switch
        on_scene:
          name: Scene or Script to Activate
          description: >
            Scene or script to activate when lights turn on.

            Used when "Scenes" or "Both" is selected.
          default: ""
          selector:
            entity:
              filter:
                - domain:
                    - scene
                    - script
        off_scene:
          name: Scene / Script for Turn OFF
          description: >
            Scene(s) or script(s) to activate when turning off.

            Leave empty to only turn off selected lights.
          default: []
          selector:
            entity:
              multiple: true
              filter:
                - domain:
                    - scene
                    - script
        boolean_scenes_scripts:
          name: Scene State Tracking Helper
          description: >
            Scenes and scripts don't have their own state. This helper tracks whether
            your scene/script is active.

            **Setup:** Settings â†’ Devices & Services â†’ Helpers â†’ Toggle

            The automation will turn this helper on when activating the scene and off when deactivating.
            
            **Note:** Scene activation may fail without warning. This helper reflects the INTENDED
            state, not necessarily the actual state. For critical scenarios, verify light states separately.
          default: ""
          selector:
            entity:
              filter:
                - domain: input_boolean

    normal_lights_settings:
      name: "Light Control Options"
      icon: mdi:lightbulb-on-outline
      collapsed: true
      input:
        include_light_control:
          name: Light Control Options
          description: >
            Select options to use for daytime lighting (night lights have separate settings).
            
            **Note:** If Dynamic Lighting Control is enabled, brightness and color temperature
            will be calculated dynamically and these fixed settings may be overridden.
          default: []
          selector:
            select:
              multiple: true
              options:
                - label: Use Brightness
                  value: use_brightness
                - label: Use Transition
                  value: use_transition
                - label: Use Effect
                  value: use_effect
        light_brightness:
          name: Brightness
          description: >
            Brightness level (1-100%).

            Only applies if "Use Brightness" is selected and Dynamic Lighting is disabled or set to Fixed.
          default: 100
          selector:
            number:
              min: 1.0
              max: 100.0
              mode: slider
              step: 1.0
              unit_of_measurement: "%"
        light_transition_on:
          name: Transition - ON
          description: >
            Fade-in time in seconds.

            Only applies if "Use Transition" is selected.
          default: 1
          selector:
            number:
              min: 0.0
              max: 5.0
              mode: slider
              step: 0.5
              unit_of_measurement: seconds
        light_transition_off:
          name: Transition - OFF
          description: >
            Fade-out time in seconds.

            Only applies if "Use Transition" is selected.
          default: 1
          selector:
            number:
              min: 0.0
              max: 30.0
              mode: slider
              step: 1.0
              unit_of_measurement: seconds
        include_light_color_control:
          name: Light Color Control
          description: >
            Select color control type:

              â€¢ **Color Temperature** â€” Warm to cool white (2000K-8000K)
              â€¢ **RGB** â€” Red, Green, Blue
              â€¢ **RGBW** â€” RGB + White channel
              â€¢ **RGBWW** â€” RGB + Cool White + Warm White
              â€¢ **Disable** â€” No color control
            
            **Note:** If Dynamic Lighting Control is enabled with Color Temperature mode,
            the color temperature will be calculated dynamically.
          default: disable_color_control
          selector:
            select:
              options:
                - label: Use Color Temperature
                  value: use_color_temperature
                - label: Use RGB Color
                  value: use_rgb_color
                - label: Use RGBW Color
                  value: use_rgbw_color
                - label: Use RGBWW Color
                  value: use_rgbww_color
                - label: Disable Color Control
                  value: disable_color_control
        light_color_temperature:
          name: Color Temperature
          description: >
            Color temperature in Kelvin. 2700K = warm white, 4000K = neutral, 6500K = cool daylight.
            
            Only used if Dynamic Lighting Color Temperature mode is set to Fixed.
          default: 5000
          selector:
            number:
              min: 2000.0
              max: 8000.0
              mode: slider
              step: 100.0
              unit_of_measurement: kelvin
        light_rgb_color:
          name: RGB Color
          description: "RGB color (Red, Green, Blue values 0-255)."
          default: [255, 255, 255]
          selector:
            color_rgb: {}
        light_rgbw_color:
          name: RGBW Color
          description: "RGBW color [Red, Green, Blue, White] â€” each value 0-255."
          default: [255, 255, 255, 255]
          selector:
            object: {}
        light_rgbww_color:
          name: RGBWW Color
          description: "RGBWW color [Red, Green, Blue, Cool White, Warm White] â€” each value 0-255."
          default: [255, 255, 255, 255, 255]
          selector:
            object: {}
        light_effect:
          name: Light Effect
          description: >
            Specify a light effect name (e.g., "colorloop", "random", "fireplace").
            
            Effect names are device-specific - check your light's capabilities in Home Assistant.
            Leave blank if not using effects.
            
            Only applies if "Use Effect" is selected in Light Control Options.
          default: ""
          selector:
            text: {}

    dynamic_lighting:
      name: "Dynamic Lighting Control"
      icon: mdi:brightness-auto
      collapsed: true
      input:
        use_dynamic_lighting:
          name: Use Dynamic Lighting Control
          description: >
            Enable adaptive brightness and color temperature that automatically adjusts throughout the day.
            
            **When enabled:**
              - Brightness and color temperature adapt to sun position, time, or room brightness
              - Creates more natural, comfortable lighting environments
              - Can be controlled independently for advanced combinations
            
            **Note:** This overrides fixed brightness and color temperature settings when active.
            Dynamic settings only apply to normal daytime lighting, not night lights mode.
            
            **Important:** If using Illuminance (Lux) modes, the same sensor is used for both
            dynamic lighting calculations AND the illuminance threshold check. Ensure your threshold
            settings don't conflict with your dynamic lighting range.
          default: false
          selector:
            boolean: {}
        brightness_mode:
          name: Brightness Mode
          description: >
            Choose how brightness is controlled:
            
            **Fixed** - Use the standard brightness setting (no dynamic control)
            
            **Sun Elevation** - Brightness follows sun position (dim at sunrise/sunset, bright at noon)
            
            **Sun Elevation (Inverted)** - Brightness inverses sun position (bright at dawn/dusk, dim at noon)
            
            **Time-Based** - Different brightness levels for morning, day, evening, and late night
            
            **Illuminance (Lux)** - Brightness based on room's ambient light level
            
            **Illuminance (Lux) Inverted** - More light when room is dark, less when bright (energy saving)
          selector:
            select:
              options:
                - label: Fixed (Use Standard Setting)
                  value: fixed
                - label: Sun Elevation
                  value: sun_elevation
                - label: Sun Elevation (Inverted)
                  value: sun_elevation_inverted
                - label: Time-Based
                  value: time_based
                - label: Illuminance (Lux)
                  value: lux
                - label: Illuminance (Lux) Inverted
                  value: lux_inverted
              sort: false
          default: fixed
        color_temp_mode:
          name: Color Temperature Mode
          description: >
            Choose how color temperature is controlled:
            
              **Fixed** - Use the standard color temperature setting (no dynamic control)
            
              **Sun Elevation** - Color follows sun position (warm at sunrise/sunset, cool at noon)
            
              **Time-Based** - Different color temperatures for morning, day, evening, and late night
          selector:
            select:
              options:
                - label: Fixed (Use Standard Setting)
                  value: fixed
                - label: Sun Elevation
                  value: sun_elevation
                - label: Time-Based
                  value: time_based
              sort: false
          default: fixed

    dynamic_lighting_sun:
      name: "Dynamic Lighting - Sun Elevation Settings"
      icon: mdi:weather-sunny
      collapsed: true
      input:
        al_min_brightness:
          name: Minimum Brightness (Sun)
          description: >
            Brightness level when sun is at sunset/sunrise elevation.
            
            Used for Sun Elevation brightness mode.
          default: 20
          selector:
            number:
              min: 1.0
              max: 100.0
              step: 1.0
              unit_of_measurement: "%"
              mode: slider
        al_max_brightness:
          name: Maximum Brightness (Sun)
          description: >
            Brightness level when sun is at noon elevation.
            
            Used for Sun Elevation brightness mode.
          default: 100
          selector:
            number:
              min: 1.0
              max: 100.0
              step: 1.0
              unit_of_measurement: "%"
              mode: slider
        al_min_kelvin:
          name: Minimum Color Temperature (Sun)
          description: >
            Warmest color temperature (at sunrise/sunset).
            
            Used for Sun Elevation color temperature mode. Typical: 2700K = warm/cozy
          default: 2700
          selector:
            number:
              min: 2000.0
              max: 8000.0
              step: 100.0
              unit_of_measurement: kelvin
              mode: slider
        al_max_kelvin:
          name: Maximum Color Temperature (Sun)
          description: >
            Coolest color temperature (at noon).
            
            Used for Sun Elevation color temperature mode. Typical: 5000K = cool/energizing
          default: 5000
          selector:
            number:
              min: 2000.0
              max: 8000.0
              step: 100.0
              unit_of_measurement: kelvin
              mode: slider
        al_sunset_elevation:
          name: Sunset/Sunrise Elevation
          description: >
            Sun angle (degrees above horizon) considered as sunset/sunrise.
            
            At this elevation, lights use minimum brightness/warmest color.
            Typical: -6Â° to 0Â°
          default: -6.0
          selector:
            number:
              min: -90.0
              max: 90.0
              step: 0.5
              unit_of_measurement: degrees
              mode: slider
        al_noon_elevation:
          name: Noon Elevation
          description: >
            Sun angle (degrees above horizon) considered as solar noon.
            
            At this elevation, lights use maximum brightness/coolest color.
            Typical: 30Â° to 70Â° depending on latitude
          default: 60.0
          selector:
            number:
              min: -90.0
              max: 90.0
              step: 1.0
              unit_of_measurement: degrees
              mode: slider

    dynamic_lighting_lux:
      name: "Dynamic Lighting - Illuminance (Lux) Settings"
      icon: mdi:brightness-6
      collapsed: true
      input:
        lux_min_brightness_pct:
          name: Minimum Brightness (Lux)
          description: >
            Brightness when lux is at "minimum brightness" threshold.
            
            For normal mode: lights dim when room is bright
            For inverted mode: lights bright when room is dark
          default: 10
          selector:
            number:
              min: 1.0
              max: 100.0
              step: 1.0
              unit_of_measurement: "%"
              mode: slider
        lux_max_brightness_pct:
          name: Maximum Brightness (Lux)
          description: >
            Brightness when lux is at "maximum brightness" threshold.
            
            For normal mode: lights bright when room is bright
            For inverted mode: lights dim when room is bright
          default: 100
          selector:
            number:
              min: 1.0
              max: 100.0
              step: 1.0
              unit_of_measurement: "%"
              mode: slider
        lux_for_min_brightness:
          name: Lux Level for Minimum Brightness
          description: >
            Ambient light level (lux) that triggers minimum brightness.
            
            For normal mode: low lux = dim lights
            For inverted mode: low lux = bright lights (energy saving)
            
            Typical: 20-50 lux = dim room, 100-200 = normal room
          default: 50
          selector:
            number:
              min: 0.0
              max: 2000.0
              step: 10.0
              unit_of_measurement: lux
              mode: slider
        lux_for_max_brightness:
          name: Lux Level for Maximum Brightness
          description: >
            Ambient light level (lux) that triggers maximum brightness.
            
            For normal mode: high lux = bright lights
            For inverted mode: high lux = dim lights (energy saving)
            
            Typical: 200-500 lux = bright room, 500+ = very bright
          default: 300
          selector:
            number:
              min: 0.0
              max: 2000.0
              step: 10.0
              unit_of_measurement: lux
              mode: slider

    dynamic_lighting_time:
      name: "Dynamic Lighting - Time-Based Settings"
      icon: mdi:clock-outline
      collapsed: true
      input:
        morning_time:
          name: Morning Start Time
          description: Morning period begins at this time.
          default: "06:00:00"
          selector:
            time: {}
        morning_brightness:
          name: Morning Brightness
          description: Brightness level during morning period.
          default: 60
          selector:
            number:
              min: 1.0
              max: 100.0
              step: 1.0
              unit_of_measurement: "%"
              mode: slider
        morning_kelvin:
          name: Morning Color Temperature
          description: >
            Color temperature during morning period.
            Typical: 3000K = warm start to the day
          default: 3000
          selector:
            number:
              min: 2000.0
              max: 8000.0
              step: 100.0
              unit_of_measurement: kelvin
              mode: slider
        day_time:
          name: Day Start Time
          description: Day period begins at this time.
          default: "09:00:00"
          selector:
            time: {}
        day_brightness:
          name: Day Brightness
          description: Brightness level during day period.
          default: 100
          selector:
            number:
              min: 1.0
              max: 100.0
              step: 1.0
              unit_of_measurement: "%"
              mode: slider
        day_kelvin:
          name: Day Color Temperature
          description: >
            Color temperature during day period.
            Typical: 5000K = cool/energizing for focus and productivity
          default: 5000
          selector:
            number:
              min: 2000.0
              max: 8000.0
              step: 100.0
              unit_of_measurement: kelvin
              mode: slider
        evening_time:
          name: Evening Start Time
          description: Evening period begins at this time.
          default: "18:00:00"
          selector:
            time: {}
        evening_brightness:
          name: Evening Brightness
          description: Brightness level during evening period.
          default: 80
          selector:
            number:
              min: 1.0
              max: 100.0
              step: 1.0
              unit_of_measurement: "%"
              mode: slider
        evening_kelvin:
          name: Evening Color Temperature
          description: >
            Color temperature during evening period.
            Typical: 3500K = warm neutral for winding down
          default: 3500
          selector:
            number:
              min: 2000.0
              max: 8000.0
              step: 100.0
              unit_of_measurement: kelvin
              mode: slider
        late_night_time:
          name: Late Night Start Time
          description: Late night period begins at this time.
          default: "22:00:00"
          selector:
            time: {}
        late_night_brightness:
          name: Late Night Brightness
          description: Brightness level during late night period.
          default: 30
          selector:
            number:
              min: 1.0
              max: 100.0
              step: 1.0
              unit_of_measurement: "%"
              mode: slider
        late_night_kelvin:
          name: Late Night Color Temperature
          description: >
            Color temperature during late night period.
            Typical: 2700K = warm/cozy for relaxation
          default: 2700
          selector:
            number:
              min: 2000.0
              max: 8000.0
              step: 100.0
              unit_of_measurement: kelvin
              mode: slider
    night_lights_trigger_settings:
      name: "Night Lights Settings"
      icon: mdi:weather-night
      collapsed: true
      input:
        include_night_lights:
          name: Use Night Lights
          description: >
            Different lighting behavior during nighttime.

            When night mode conditions are met, uses night light settings instead of normal settings.
          default: night_lights_disabled
          selector:
            select:
              options:
                - label: Enable the night lights options
                  value: night_lights_enabled
                - label: Disable the night lights options
                  value: night_lights_disabled
        night_lights_conditions:
          name: Night Lights Conditions
          description: >
            Conditions that determine when night lights are active.

            If multiple selected, all must be met.

              â€¢ **Entity state** â€” Night mode when specific entity/entities are on
              â€¢ **Time** â€” Night mode during specific hours
              â€¢ **Sun elevation** â€” Night mode when sun is below horizon
          default: []
          selector:
            select:
              multiple: true
              options:
                - label: Enable entity state option
                  value: entity_state_enabled
                - label: Enable time option
                  value: time_enabled
                - label: Enable sun elevation option
                  value: sun_enabled
        night_lights_entity_state:
          name: Night Lights - Entity State
          description: >
            Entity/entities that activate night lights when on.

            If any entity is on, night mode activates.
          default: []
          selector:
            entity:
              multiple: true
        night_lights_after_time:
          name: Night Lights - Start Time
          description: "Time when night lights mode begins. Only used if time option is enabled."
          default: "22:00:00"
          selector:
            time: {}
        night_lights_before_time:
          name: Night Lights - End Time
          description: >
            Time when night lights mode ends. Only used if time option is enabled.

            Can be before start time for overnight ranges (e.g., start 22:00, end 06:00).
          default: "06:00:00"
          selector:
            time: {}
        night_lights_sun_elevation_falling:
          name: Night Lights - Sun Elevation Falling (Sunset)
          description: >
            Sun elevation angle (degrees) below which night lights activate when sun is setting.

            When sun is going down and drops below this elevation, night mode activates.

            **Typical:** 0Â° = horizon, -1 to -3Â° = civil twilight, -4 to -6Â° = darker
          default: -1.5
          selector:
            number:
              min: -10.0
              max: 5.0
              step: 0.5
              unit_of_measurement: degrees
              mode: slider
        night_lights_sun_elevation_rising:
          name: Night Lights - Sun Elevation Rising (Sunrise)
          description: >
            Sun elevation angle (degrees) above which night lights deactivate when sun is rising.

            When sun is coming up and climbs above this elevation, night mode ends.

            Should be lower than falling value to prevent flickering.
          default: -4.0
          selector:
            number:
              min: -10.0
              max: 5.0
              step: 0.5
              unit_of_measurement: degrees
              mode: slider

    night_lights_settings:
      name: "Night Lights"
      icon: mdi:lightbulb-night-outline
      collapsed: true
      input:
        night_lights:
          name: Night Lights
          description: >
            Lights, switches, scenes, or scripts for night mode.

            Can be different fixtures or same lights with different settings.
          default: {}
          selector:
            target:
              entity:
                - domain:
                    - light
                    - switch
                    - scene
                    - script
        night_boolean_scenes_scripts:
          name: Night Lights - Scene State Tracking Helper
          description: "input_boolean helper to track night scene/script state."
          default: ""
          selector:
            entity:
              filter:
                - domain: input_boolean
        night_time_delay:
          name: Night Lights - Time Delay
          description: >
            Wait time before turning off night lights after triggers clear.

            Works in both operating modes:
              â€¢ Simple Mode: Timer after all triggers clear
              â€¢ Occupancy Mode: Replaces maximum idle time during night hours
          default: 5
          selector:
            number:
              min: 0.0
              max: 30.0
              step: 0.5
              unit_of_measurement: minutes
              mode: slider

        manual_control_turns_off_night_lights:
          name: Manual Control Turns Off Night Lights
          description: >
            **NEW in v5.2.0:** When enabled, manually turning OFF the main lights will also turn off night lights.
            
            
            **Use Case:** You manually turn on lights during night mode, then manually turn them off while exiting the room.
            Without this option, night lights remain ON (orphaned state). With this option enabled, night lights turn off too.
            
            
            **Default: Disabled** to preserve backward compatibility. Enable if you want manual control to affect night lights.
          default: false
          selector:
            boolean:

    night_lights_light_control_settings:
      name: "Night Light Control"
      icon: mdi:lightbulb-on-80
      collapsed: true
      input:
        include_night_light_control:
          name: Night Lights - Light Control Options
          description: >
            Options for night lights. Separate from daytime settings.
            
            **Cross Over Options:** When using the same lights for both normal and night modes, or when lights are already ON during mode transitions:
              - **Adjust lights when crossing over:** Properly handles transitions by turning off inactive mode lights before turning on active mode lights. Essential when using different fixtures for day/night.
              - **Use cross over time delay:** Adds buffer period after night mode ends before switching to normal lighting. Useful with motion sensors to prevent premature brightness changes.
          default: []
          selector:
            select:
              multiple: true
              options:
                - label: Use brightness
                  value: use_brightness
                - label: Use transition
                  value: use_transition
                - label: Use Effect
                  value: use_effect
                - label: If lights are ON, adjust the lights when crossing over
                  value: use_crossover_adjust
                - label: Use cross over time delay from night lights to normal lights
                  value: use_crossover_delay
        night_light_brightness:
          name: Night Lights - Brightness
          description: >
            Brightness level (1-100%).

            **Typical:** 10-20% for night lighting.
          default: 20
          selector:
            number:
              min: 1.0
              max: 100.0
              mode: slider
              step: 1.0
              unit_of_measurement: "%"
        night_light_transition_on:
          name: Night Lights - Transition - ON
          description: "Fade-in time in seconds."
          default: 1
          selector:
            number:
              min: 0.0
              max: 5.0
              mode: slider
              step: 0.5
              unit_of_measurement: seconds
        night_light_transition_off:
          name: Night Lights - Transition - OFF
          description: "Fade-out time in seconds."
          default: 1
          selector:
            number:
              min: 0.0
              max: 30.0
              mode: slider
              step: 1.0
              unit_of_measurement: seconds
        night_light_crossover_delay:
          name: Cross Over - Time Delay
          description: >
            The time delay sets the duration the night lights stay active after the night light 
            condition is deactivated, before transitioning to normal lighting.
            
            This delay is especially useful when using the night lights state condition with a motion 
            sensor, as it adds a buffer period after the motion sensor clears before switching to 
            normal lighting.
            
            **Note:** This is different from "Night Lights - Time Delay" which controls how long lights 
            stay on after all triggers clear. This crossover delay only applies during mode transitions.
          default: 0
          selector:
            number:
              min: 0.0
              max: 300.0
              step: 1.0
              unit_of_measurement: seconds
              mode: slider
        include_night_light_color_control:
          name: Night Lights - Light Color Control
          description: "Color control type for night lights. Separate from daytime settings."
          default: disable_color_control
          selector:
            select:
              options:
                - label: Use Color Temperature
                  value: use_color_temperature
                - label: Use RGB Color
                  value: use_rgb_color
                - label: Use RGBW Color
                  value: use_rgbw_color
                - label: Use RGBWW Color
                  value: use_rgbww_color
                - label: Disable Color Control
                  value: disable_color_control
        night_light_color_temperature:
          name: Night Lights - Color Temperature
          description: "Color temperature in Kelvin. 2200-2700K = warm, 3500K+ = too cool for night."
          default: 2700
          selector:
            number:
              min: 2000.0
              max: 8000.0
              mode: slider
              step: 100.0
              unit_of_measurement: kelvin
        night_light_rgb_color:
          name: Night Lights - RGB Color
          description: "RGB color. Default: warm orange [255, 147, 41]."
          default: [255, 147, 41]
          selector:
            color_rgb: {}
        night_light_rgbw_color:
          name: Night Lights - RGBW Color
          description: "RGBW color [R, G, B, W]. Default: warm orange with no white [255, 147, 41, 0]."
          default: [255, 147, 41, 0]
          selector:
            object: {}
        night_light_rgbww_color:
          name: Night Lights - RGBWW Color
          description: "RGBWW color [R, G, B, CW, WW]. Default: warm orange with warm white [255, 147, 41, 0, 255]."
          default: [255, 147, 41, 0, 255]
          selector:
            object: {}
        night_light_effect:
          name: Night Lights - Light Effect
          description: >
            Specify a light effect for night lights (e.g., "colorloop", "fireplace").
            
            Effect names are device-specific. Leave blank if not using effects.
            
            Only applies if "Use Effect" is selected in Night Lights Control Options.
          default: ""
          selector:
            text: {}

    night_lights_night_glow:
      name: "Night Glow"
      icon: mdi:candle
      collapsed: true
      input:
        include_night_glow:
          name: Night Glow
          description: >
            Low-level ambient lighting when no triggers are active during night mode.

            During night mode, when all triggers are clear, instead of turning lights completely off,
            activates very dim "glow" lights for navigation.

            Only active during night mode conditions.
          default: night_glow_disabled
          selector:
            select:
              options:
                - label: Enable night glow
                  value: night_glow_enabled
                - label: Disable night glow
                  value: night_glow_disabled
        night_glow_lights:
          name: Night Glow - Lights
          description: >
            Lights, switches, scenes, or scripts for night glow.

            Can be same lights at lower brightness or different fixtures.
          default: {}
          selector:
            target:
              entity:
                - domain:
                    - light
                    - switch
                    - scene
                    - script
        include_night_glow_light_control:
          name: Night Glow - Light Control Options
          description: "Options for night glow lights."
          default: []
          selector:
            select:
              multiple: true
              options:
                - label: Use brightness
                  value: use_brightness
                - label: Use transition
                  value: use_transition
                - label: Use Effect
                  value: use_effect
        night_glow_light_brightness:
          name: Night Glow - Brightness
          description: >
            Brightness level (1-100%).

            Should be lower than night light brightness. **Typical:** 5-15%.
          default: 10
          selector:
            number:
              min: 1.0
              max: 100.0
              mode: slider
              step: 1.0
              unit_of_measurement: "%"
        night_glow_light_transition_on:
          name: Night Glow - Transition - ON
          description: "Fade-in time in seconds."
          default: 2
          selector:
            number:
              min: 0.0
              max: 5.0
              mode: slider
              step: 0.5
              unit_of_measurement: seconds
        night_glow_light_transition_off:
          name: Night Glow - Transition - OFF
          description: "Fade-out time in seconds."
          default: 2
          selector:
            number:
              min: 0.0
              max: 30.0
              mode: slider
              step: 1.0
              unit_of_measurement: seconds
        include_night_glow_light_color_control:
          name: Night Glow - Light Color Control
          description: "Color control type for night glow lights."
          default: disable_color_control
          selector:
            select:
              options:
                - label: Use Color Temperature
                  value: use_color_temperature
                - label: Use RGB Color
                  value: use_rgb_color
                - label: Use RGBW Color
                  value: use_rgbw_color
                - label: Use RGBWW Color
                  value: use_rgbww_color
                - label: Disable Color Control
                  value: disable_color_control
        night_glow_light_color_temperature:
          name: Night Glow - Color Temperature
          description: "Color temperature in Kelvin. 2000-2200K = very warm."
          default: 2200
          selector:
            number:
              min: 2000.0
              max: 8000.0
              mode: slider
              step: 100.0
              unit_of_measurement: kelvin
        night_glow_light_rgb_color:
          name: Night Glow - RGB Color
          description: "RGB color. Default: deep warm orange [255, 100, 0]."
          default: [255, 100, 0]
          selector:
            color_rgb: {}
        night_glow_light_rgbw_color:
          name: Night Glow - RGBW Color
          description: "RGBW color [R, G, B, W]. Default: deep warm orange [255, 100, 0, 0]."
          default: [255, 100, 0, 0]
          selector:
            object: {}
        night_glow_light_rgbww_color:
          name: Night Glow - RGBWW Color
          description: "RGBWW color [R, G, B, CW, WW]. Default: deep warm orange with warm white [255, 100, 0, 0, 150]."
          default: [255, 100, 0, 0, 150]
          selector:
            object: {}
        night_glow_light_effect:
          name: Night Glow - Light Effect
          description: >
            Specify a light effect for night glow (e.g., "candle", "fireplace").
            
            Effect names are device-specific. Leave blank if not using effects.
            
            Only applies if "Use Effect" is selected in Night Glow Control Options.
          default: ""
          selector:
            text: {}
    bypass_settings:
      name: "Bypass (Global)"
      icon: mdi:cog-pause-outline
      collapsed: true
      input:
        include_bypass:
          name: Use Bypass
          description: >
            Manual override switches that bypass the automation.

            **Three modes:**

              â€¢ **Turn the Lights ON** â€” Forces lights on, prevents automation from turning them off
              â€¢ **Turn the Lights OFF** â€” Forces lights off, prevents automation from turning them on
              â€¢ **Keep Current State** â€” Freezes lights in current state, disables automation

            **Applies to:** Both Simple Mode and Occupancy Mode.
          default: []
          selector:
            select:
              options:
                - label: 1 - Enable Bypass - Turn the Lights ON
                  value: bypass_enabled_turn_on
                - label: 2 - Enable Bypass - Turn the Lights OFF
                  value: bypass_enabled_turn_off
                - label: 3 - Enable Bypass - Keep the Lights Current State
                  value: bypass_enabled_stop
              multiple: true
        motion_bypass_lights_on:
          name: Bypass Switch - Turn the Lights ON
          description: >
            Switch(es) that force lights on and bypass automation.

            When any switch is on: lights turn on, automation cannot turn lights off.
          default: []
          selector:
            entity:
              multiple: true
        motion_bypass_lights_off:
          name: Bypass Switch - Turn the Lights OFF
          description: >
            Switch(es) that force lights off and bypass automation.

            When any switch is on: lights turn off, automation cannot turn lights on.
          default: []
          selector:
            entity:
              multiple: true
        motion_bypass_lights_stop:
          name: Bypass Switch - Keep the Lights Current State
          description: >
            Switch(es) that freeze lights in current state.

            When any switch is on: lights stay as they are, automation is disabled.
          default: []
          selector:
            entity:
              multiple: true
        bypass_time_delay:
          name: Bypass - Time Delay
          description: "Wait time before turning lights off in specific bypass scenarios. Rarely needed."
          default: 0
          selector:
            number:
              min: 0.0
              max: 10.0
              step: 0.25
              unit_of_measurement: minutes
              mode: slider
        include_bypass_auto_off:
          name: Bypass Auto OFF
          description: >
            Automatically turn off bypass switches after timeout.

            Prevents bypasses from staying active indefinitely. After timeout,
            bypass switches turn off and automation resumes normal operation.
          default: []
          selector:
            select:
              options:
                - label: A - Enable Auto OFF for Bypass Option 1 - Turn the Lights ON
                  value: bypass_auto_off_enabled_on
                - label: B - Enable Auto OFF for Bypass Option 2 - Turn the Lights OFF
                  value: bypass_auto_off_enabled_off
                - label: C - Enable Auto OFF for Bypass Option 3 - Keep the Lights Current State
                  value: bypass_auto_off_enabled_stop
              multiple: true
        bypass_auto_off_delay:
          name: Bypass Auto OFF - Time Delay
          description: >
            Wait time before automatically turning off bypass switches.
            
              **IMPORTANT:** This timer will be reset if any other automation trigger 
            fires (motion detected, door opened/closed, etc.). In rooms with frequent 
            activity, the bypass may remain active longer than this duration.
            
            To manually end bypass mode early, simply turn off the bypass switch.
          default: 60
          selector:
            number:
              min: 1.0
              max: 240.0
              step: 1.0
              unit_of_measurement: minutes
              mode: slider
    device_tracker_settings:
      name: "Device Tracker (Global)"
      icon: mdi:account-multiple-check-outline
      collapsed: true
      input:
        include_device_tracker:
          name: Use Device Tracker
          description: >
            Only run automation based on presence in a zone.

              â€¢ **Zone option** â€” Run when any person/device is in the selected zone
              â€¢ **Zone + People option** â€” Run only when specific people are in the zone
            
              **Unavailability:** If zone or person entities are unavailable, automation is allowed to run.

            **Applies to:** Both Simple Mode and Occupancy Mode.
          default: device_tracker_disabled
          selector:
            select:
              options:
                - label: Enable the zone option
                  value: zone_enabled
                - label: Enable the zone + people options
                  value: zone_people_enabled
                - label: Disable the device tracker options
                  value: device_tracker_disabled
        zone:
          name: Device Tracker - Zone
          description: >
            Zone to check for presence. Most common: zone.home
            
            Can be entered as 'zone.home' or just 'home' - both work correctly.
          default: ""
          selector:
            entity:
              filter:
                - domain: zone
        people:
          name: Device Tracker - People
          description: "Specific people to track in the zone. Only used with 'zone + people' option."
          default: []
          selector:
            entity:
              multiple: true
              filter:
                - domain: person

    illuminance:
      name: "Illuminance Sensor (Global)"
      icon: mdi:brightness-6
      collapsed: true
      input:
        use_illuminance:
          name: Enable Ambient Light Sensor
          description: >
            Prevent lights from turning on when there's already sufficient ambient light.
            
            **IMPORTANT:** If Dynamic Lighting Control is enabled with Lux mode, this same sensor
            is used for both dynamic lighting AND the threshold check. Configure carefully to avoid conflicts.
            
            **How it works:**
              - Measures room brightness with illuminance sensor
              - Only allows lights to turn on if brightness is below threshold
              - Lights can still turn off regardless of brightness level
              - Perfect for rooms with windows to save energy on sunny days

              **Applies to:** Both Simple Mode and Occupancy Mode.
          default: false
            is used for BOTH the threshold check AND dynamic brightness calculation. Ensure your
            settings don't conflict. For example, if threshold is 50 lux (don't turn on above 50)
            but dynamic lighting min is 50 lux, lights will never activate at 50 lux but would try
            to set minimum brightness if manually activated.
          default: false
          selector:
            boolean: {}
        illuminance_sensor:
          name: Illuminance Sensor
          description: >
            Sensor that measures ambient light in lux. Must have device_class: illuminance.
            
            **Note:** This sensor is also used for Dynamic Lighting Control when Lux mode is selected.
            
            **Unavailability:** If sensor becomes unavailable or reports unknown, the threshold check
            is skipped and lights may turn on regardless of ambient light.
          default: ""
          selector:
            entity:
              filter:
                domain: sensor
                device_class: illuminance
        illuminance_threshold:
          name: Illuminance Threshold
          description: >
            Lux threshold value. Behavior depends on mode below.

            **Typical values:** 20-40 = dim room, 50-100 = overcast day, 200+ = bright room
          default: 50
          selector:
            number:
              min: 0.0
              max: 2000.0
              unit_of_measurement: lux
              mode: slider
              step: 1.0
        illuminance_mode:
          name: Illuminance Mode
          description: >
            When to turn lights on based on threshold:

              â€¢ **Below threshold** â€” Turn lights on only when ambient light is below threshold (typical)
              â€¢ **Above threshold** â€” Turn lights on only when ambient light is above threshold
          default: below
          selector:
            select:
              options:
                - label: Below threshold
                  value: below
                - label: Above threshold
                  value: above
    override_mode:
      name: "Override Mode (Global)"
      icon: mdi:lock-open-variant
      collapsed: true
      input:
        use_override_mode:
          name: Use Override Mode
          description: >
            Enable manual override to force lights to a specific state and disable all automation.
            
            **Use cases:**
              - Cleaning: Force 100% bright, neutral white light
              - Detailed work: Ensure lights never dim or turn off
              - Finding something: Blast full light without waving at sensors
            
            **How it works:**
              - Toggle the override helper ON
              - Lights immediately go to override brightness/color
              - All automation logic is disabled (motion, timers, etc.)
              - Toggle OFF to resume normal automation
            
            **Perfect for temporary tasks that need consistent bright lighting.**

            **Applies to:** Both Simple Mode and Occupancy Mode.
          default: false
          selector:
            boolean: {}
        override_mode_helper:
          name: Override Mode Toggle
          description: >
            input_boolean helper to activate/deactivate override mode.
            
            **Setup:** Settings â†’ Helpers â†’ Toggle â†’ Name: "[Room] Override Mode"
            
            When ON: Lights forced to override settings, automation disabled
            When OFF: Normal automation resumes
            
            Can be controlled by physical switch, dashboard, or voice command.
          default: []
          selector:
            entity:
              filter:
                - domain: input_boolean
        override_mode_brightness:
          name: Override Mode Brightness
          description: >
            Brightness level when Override Mode is active.
            
            Typical: 100% for maximum visibility during cleaning or detailed tasks.
          default: 100
          selector:
            number:
              min: 1.0
              max: 100.0
              step: 1.0
              unit_of_measurement: "%"
              mode: slider
        override_mode_color_temp:
          name: Override Mode Color Temperature
          description: >
            Color temperature when Override Mode is active.
            
            Typical: 4500K = neutral white for clear visibility and task lighting.
            Only used if "Use Color Temperature" is selected in Light Color Control.
          default: 4500
          selector:
            number:
              min: 2000.0
              max: 8000.0
              step: 100.0
              unit_of_measurement: kelvin
              mode: slider
        override_mode_rgb_color:
          name: Override Mode RGB Color
          description: >
            RGB color when Override Mode is active.
            Default: Bright white [255, 255, 255]
            Only used if "Use RGB Color" is selected in Light Color Control.
          default: [255, 255, 255]
          selector:
            color_rgb: {}
        override_mode_rgbw_color:
          name: Override Mode RGBW Color
          description: >
            RGBW color when Override Mode is active [Red, Green, Blue, White].
            Default: Bright white [255, 255, 255, 255]
            Only used if "Use RGBW Color" is selected in Light Color Control.
          default: [255, 255, 255, 255]
          selector:
            object: {}
        override_mode_rgbww_color:
          name: Override Mode RGBWW Color
          description: >
            RGBWW color when Override Mode is active [Red, Green, Blue, Cool White, Warm White].
            Default: Bright neutral [255, 255, 255, 128, 128]
            Only used if "Use RGBWW Color" is selected in Light Color Control.
          default: [255, 255, 255, 128, 128]
          selector:
            object: {}
        override_mode_effect:
          name: Override Mode Light Effect
          description: >
            Specify a light effect for Override Mode (e.g., "colorloop").
            
            Effect names are device-specific. Leave blank if not using effects.
            
            Only applies if "Use Effect" is selected in Light Control Options.
          default: ""
          selector:
            text: {}

    state_control_settings:
      name: "State Control Condition (Global)"
      icon: mdi:toggle-switch-outline
      collapsed: true
      input:
        include_state_control:
          name: Use State Control
          description: >
            Only allow automation when another entity is in a specific state.

            If control entity is not in required state, automation won't turn lights on (but can still turn them off).
            
            **Unavailability:** If control entity is unavailable, automation is allowed to run.

            **Applies to:** Both Simple Mode and Occupancy Mode.
          default: state_control_disabled
          selector:
            select:
              options:
                - label: Enable State Control Option
                  value: state_control_enabled
                - label: Disable State Control Option
                  value: state_control_disabled
        state_control_activation_state:
          name: Activation State
          description: >
            Which state the control entity must be in:

              â€¢ **ON State** â€” Automation only runs when control entity is on
              â€¢ **OFF State** â€” Automation only runs when control entity is off
          default: "on"
          selector:
            select:
              options:
                - label: ON State
                  value: "on"
                - label: OFF State
                  value: "off"
        state_control_entity:
          name: Control Entity
          description: "Entity that controls whether automation can run. Any entity with on/off states."
          default: ""
          selector:
            entity: {}

    time_settings:
      name: "Time Restrictions (Global)"
      icon: mdi:clock-outline
      collapsed: true
      input:
        include_time:
          name: Use Time Restrictions
          description: >
            Restrict automation to specific times and days.

            Automation only turns lights on during the specified time window.
            Lights can still turn off outside this window.
            
            **Special case:** If start time equals end time (e.g., both 00:00:00), 
            automation runs 24 hours a day.

              **Applies to:** Both Simple Mode and Occupancy Mode.
          default: time_disabled
          selector:
            select:
              options:
                - label: Enable the time options
                  value: time_enabled
                - label: Disable the time options
                  value: time_disabled
        after_time:
          name: Start Time
          description: >
            Earliest time automation can turn on lights.

            For overnight ranges, this is the start time in the evening.
          default: "00:00:00"
          selector:
            time: {}
        before_time:
          name: End Time
          description: >
            Latest time automation can turn on lights.

            Can be before start time for overnight ranges (e.g., start 22:00, end 06:00).
          default: "00:00:00"
          selector:
            time: {}
        weekday_options:
          name: Weekdays
          description: "Days of the week automation can run."
          default:
            [mon, tue, wed, thu, fri, sat, sun]
          selector:
            select:
              multiple: true
              mode: list
              options:
                - { label: "Monday", value: "mon" }
                - { label: "Tuesday", value: "tue" }
                - { label: "Wednesday", value: "wed" }
                - { label: "Thursday", value: "thu" }
                - { label: "Friday", value: "fri" }
                - { label: "Saturday", value: "sat" }
                - { label: "Sunday", value: "sun" }

    power_recovery:
      name: "Power Outage Recovery"
      icon: mdi:power-plug-off
      collapsed: true
      input:
        use_power_recovery:
          name: Use Power Outage Recovery
          description: >
            Enable smart recovery after power outages or Home Assistant restarts.
            
            **The problem:** Many smart bulbs turn ON to default state after power loss.
            At 3 AM, power flickers, all your lights turn on and stay on.
            
            **The solution:** When Home Assistant starts, this checks room state:
              - If room is unoccupied (no motion, no occupancy), turns lights OFF
              - If bypass is active, respects bypass state
              - If room is occupied, leaves lights as they are
            
            **Use cases:**
              - Overnight power flicker: Lights auto-correct to OFF
              - Vacation power outage: House doesn't stay fully lit for days
              - HA restart: Lights return to correct state for room occupancy
            
            **Recommended:** Enable for all rooms to prevent unexpected light states.
          default: false
          selector:
            boolean: {}
        power_recovery_delay:
          name: Power Recovery Delay
          description: >
            Wait time after Home Assistant starts before running power recovery logic.
            
            Gives sensors time to initialize and report accurate states. If too short,
            recovery may run with unavailable sensor data. If too long, incorrect light
            states persist longer.
            
            **Typical:** 30-60 seconds for most systems.
          default: 30
          selector:
            number:
              min: 10.0
              max: 120.0
              step: 5.0
              unit_of_measurement: seconds
              mode: slider

    trace_settings:
          name: "Trace Settings (Debugging)"
          icon: mdi:graph-outline
          collapsed: true
          input:
            trace_limit:
              name: "Number of Traces to Store"
              description: >
                Set the number of automation runs to keep for debugging.
                Default is 5.
              selector:
                number:
                  min: 0
                  max: 50
                  step: 1
                  mode: slider
              default: 5

# ==============================================================================
# VARIABLES - Extract inputs and create computed values
# ==============================================================================
variables:
  operating_mode: !input operating_mode

  # --------------------------------------------------------------------------
  # AUTOMATION BEHAVIOR
  # --------------------------------------------------------------------------
  light_control_behavior: !input light_control_behavior

  allows_turn_on: >-
    {{ light_control_behavior in ['on_and_off', 'only_on'] }}

  allows_turn_off: >-
    {{ light_control_behavior in ['on_and_off', 'only_off'] }}

  # --------------------------------------------------------------------------
  # BASIC ENTITY REFERENCES
  # --------------------------------------------------------------------------
  trigger_sensor_entity: !input trigger_sensor
  light_control_type_var: !input light_control_type
  light_entity: !input light_switch
  on_scene_entity: !input on_scene
  off_scene_entity: !input off_scene
  boolean_scenes_scripts_entity: !input boolean_scenes_scripts
  time_delay_minutes: !input time_delay

  # --------------------------------------------------------------------------
  # NEW TRIGGER VARIABLES (v5.1.0)
  # --------------------------------------------------------------------------
  # Entity State Trigger
  entity_input_var: !input entity_input
  include_entity_state_list: !input include_entity_state
  include_entity_on: "{{ 'entity_on' in include_entity_state_list }}"
  include_entity_off: "{{ 'entity_off' in include_entity_state_list }}"
  
  # Push Button Trigger
  button_input_var: !input button_input
  include_button_list: !input include_button
  include_button_on: "{{ 'button_on' in include_button_list }}"
  include_button_off: "{{ 'button_off' in include_button_list }}"
  
  # Sun Elevation Trigger
  include_sun_list: !input include_sun
  include_sun_falling: "{{ 'sun_falling' in include_sun_list }}"
  include_sun_rising: "{{ 'sun_rising' in include_sun_list }}"
  sun_elevation_falling_var: !input sun_elevation
  sun_elevation_rising_var: !input sun_elevation_rising
  
  # Ambient Light Trigger
  include_ambient_list: !input include_ambient
  include_ambient_low: "{{ 'ambient_low' in include_ambient_list }}"
  include_ambient_high: "{{ 'ambient_high' in include_ambient_list }}"
  ambient_light_sensor_var: !input ambient_light_sensor
  ambient_light_low_var: !input ambient_light_value
  ambient_light_high_var: !input ambient_light_value_off
  
  # Time Trigger
  include_time_trigger_list: !input include_time_trigger
  include_time_on: "{{ 'time_on' in include_time_trigger_list }}"
  include_time_off: "{{ 'time_off' in include_time_trigger_list }}"
  time_on_var: !input time_trigger_on
  time_off_var: !input time_trigger_off


  # --------------------------------------------------------------------------
  # TURN OFF ONLY DEVICES
  # --------------------------------------------------------------------------
  use_turn_off_only_feature: !input use_turn_off_only
  turn_off_only_target: !input turn_off_only_entities
  has_turn_off_only_devices: >-
    {{ use_turn_off_only_feature and 
       turn_off_only_target is not none and
       turn_off_only_target != {} and 
       turn_off_only_target.entity_id is defined and
       turn_off_only_target.entity_id | select | list | length > 0 }}

  # --------------------------------------------------------------------------
  # DYNAMIC LIGHTING CONTROL
  # --------------------------------------------------------------------------
  use_dynamic_lighting_feature: !input use_dynamic_lighting
  brightness_mode_setting: !input brightness_mode
  color_temp_mode_setting: !input color_temp_mode
  
  # Sun elevation settings
  al_min_brightness_val: !input al_min_brightness
  al_max_brightness_val: !input al_max_brightness
  al_min_kelvin_val: !input al_min_kelvin
  al_max_kelvin_val: !input al_max_kelvin
  al_sunset_elevation_val: !input al_sunset_elevation
  al_noon_elevation_val: !input al_noon_elevation
  
  # Lux settings
  lux_min_brightness_val: !input lux_min_brightness_pct
  lux_max_brightness_val: !input lux_max_brightness_pct
  lux_for_min_brightness_val: !input lux_for_min_brightness
  lux_for_max_brightness_val: !input lux_for_max_brightness
  
  # Time-based settings
  morning_time_val: !input morning_time
  morning_brightness_val: !input morning_brightness
  morning_kelvin_val: !input morning_kelvin
  day_time_val: !input day_time
  day_brightness_val: !input day_brightness
  day_kelvin_val: !input day_kelvin
  evening_time_val: !input evening_time
  evening_brightness_val: !input evening_brightness
  evening_kelvin_val: !input evening_kelvin
  late_night_time_val: !input late_night_time
  late_night_brightness_val: !input late_night_brightness
  late_night_kelvin_val: !input late_night_kelvin

  # --------------------------------------------------------------------------
  # PRESENCE DETECTION (Still Mode)
  # --------------------------------------------------------------------------
  use_presence_detection_feature: !input use_presence_detection
  presence_detection_sensors_list: !input presence_detection_sensors
  
  presence_detection_active: >-
    {{ use_presence_detection_feature and 
       presence_detection_sensors_list is not none and 
       presence_detection_sensors_list | length > 0 and
       expand(presence_detection_sensors_list) | selectattr('state', 'in', ['on', 'playing', 'home', 'occupied', 'detected']) | list | length > 0 }}

  # --------------------------------------------------------------------------
  # OVERRIDE MODE - FIXED v5.0.2, ENHANCED v5.0.4
  # --------------------------------------------------------------------------
  use_override_mode_feature: !input use_override_mode
  override_mode_helper_list: !input override_mode_helper
  override_mode_helper_entity: "{{ override_mode_helper_list if override_mode_helper_list not in [none, '', []] else '' }}"
  override_mode_brightness_val: !input override_mode_brightness
  override_mode_color_temp_val: !input override_mode_color_temp
  override_mode_rgb_val: !input override_mode_rgb_color
  override_mode_rgbw_val: !input override_mode_rgbw_color
  override_mode_rgbww_val: !input override_mode_rgbww_color
  override_mode_effect_val: !input override_mode_effect
  
  override_mode_active: >-
    {{ use_override_mode_feature and 
       override_mode_helper_entity is not none and 
       override_mode_helper_entity != '' and
       states(override_mode_helper_entity) not in ['unavailable', 'unknown'] and
       is_state(override_mode_helper_entity, 'on') }}

  # --------------------------------------------------------------------------
  # POWER RECOVERY
  # --------------------------------------------------------------------------
  use_power_recovery_feature: !input use_power_recovery
  power_recovery_delay_seconds: !input power_recovery_delay

  # --------------------------------------------------------------------------
  # OCCUPANCY DETECTION
  # --------------------------------------------------------------------------
  motion_sensor_entity: !input motion_sensor
  door_sensor_entity: !input door_sensor
  occupancy_entity: !input occupancy_helper
  entering_entity: !input entering_helper
  entered_entity: !input entered_helper
  exiting_entity: !input exiting_helper

  # --------------------------------------------------------------------------
  # TIMING VALUES (for occupancy mode)
  # --------------------------------------------------------------------------
  entry_delay_seconds: !input entry_delay
  motion_timeout_seconds: !input motion_timeout
  motion_gap_timeout_seconds: !input motion_gap_timeout
  max_idle_minutes: !input max_idle_time

  # --------------------------------------------------------------------------
  # NIGHT LIGHTS SETTINGS
  # --------------------------------------------------------------------------
  use_night_lights: !input include_night_lights
  night_lights_conditions: !input night_lights_conditions
  night_lights_entity_state_list: !input night_lights_entity_state
  night_lights_after_time: !input night_lights_after_time
  night_lights_before_time: !input night_lights_before_time
  night_lights_sun_elevation_falling: !input night_lights_sun_elevation_falling
  night_lights_sun_elevation_rising_val: !input night_lights_sun_elevation_rising

  night_lights_target: !input night_lights
  night_boolean_scenes_scripts_entity: !input night_boolean_scenes_scripts
  night_time_delay_minutes: !input night_time_delay
  manual_control_turns_off_night_lights_var: !input manual_control_turns_off_night_lights

  # Night light control
  night_light_control_options: !input include_night_light_control
  night_light_brightness_pct: !input night_light_brightness
  night_light_transition_on_time: !input night_light_transition_on
  night_light_transition_off_time: !input night_light_transition_off
  night_light_crossover_delay_seconds: !input night_light_crossover_delay
  night_light_color_control: !input include_night_light_color_control
  night_light_color_temp: !input night_light_color_temperature
  night_light_rgb: !input night_light_rgb_color
  night_light_rgbw: !input night_light_rgbw_color
  night_light_rgbww: !input night_light_rgbww_color
  night_light_effect: !input night_light_effect

  # Night glow
  use_night_glow: !input include_night_glow
  night_glow_target: !input night_glow_lights
  night_glow_control_options: !input include_night_glow_light_control
  night_glow_brightness_pct: !input night_glow_light_brightness
  night_glow_transition_on_time: !input night_glow_light_transition_on
  night_glow_transition_off_time: !input night_glow_light_transition_off
  night_glow_color_control: !input include_night_glow_light_color_control
  night_glow_color_temp: !input night_glow_light_color_temperature
  night_glow_rgb: !input night_glow_light_rgb_color
  night_glow_rgbw: !input night_glow_light_rgbw_color
  night_glow_rgbww: !input night_glow_light_rgbww_color
  night_glow_effect: !input night_glow_light_effect

  # --------------------------------------------------------------------------
  # MANUAL CONTROL SETTINGS
  # --------------------------------------------------------------------------
  use_manual_control_feature: !input use_manual_control
  manual_control_entity_list: !input manual_control_helper
  manual_control_entity: "{{ manual_control_entity_list if manual_control_entity_list not in [none, '', []] else '' }}"
  manual_control_timeout_seconds: !input manual_control_timeout
  cooldown_entity_list: !input cooldown_helper
  cooldown_entity: "{{ cooldown_entity_list if cooldown_entity_list not in [none, '', []] else '' }}"
  manual_control_cooldown_seconds: !input manual_control_cooldown

  manual_control_simple_entity_list: !input manual_control_simple_helper
  manual_control_simple_entity: "{{ manual_control_simple_entity_list if manual_control_simple_entity_list not in [none, '', []] else '' }}"
  cooldown_simple_entity_list: !input cooldown_simple_helper
  cooldown_simple_entity: "{{ cooldown_simple_entity_list if cooldown_simple_entity_list not in [none, '', []] else '' }}"
  manual_control_simple_cooldown_seconds: !input manual_control_simple_cooldown

  # --------------------------------------------------------------------------
  # LIGHT CONTROL SETTINGS
  # --------------------------------------------------------------------------
  light_control_options: !input include_light_control
  light_brightness_pct: !input light_brightness
  light_transition_on_time: !input light_transition_on
  light_transition_off_time: !input light_transition_off
  light_color_control: !input include_light_color_control
  light_color_temp: !input light_color_temperature
  light_rgb: !input light_rgb_color
  light_rgbw: !input light_rgbw_color
  light_rgbww: !input light_rgbww_color
  light_effect: !input light_effect

  # --------------------------------------------------------------------------
  # ILLUMINANCE SETTINGS
  # --------------------------------------------------------------------------
  use_illuminance_sensor: !input use_illuminance
  illuminance_entity: !input illuminance_sensor
  illuminance_threshold_value: !input illuminance_threshold
  illuminance_comparison: !input illuminance_mode

  # --------------------------------------------------------------------------
  # BYPASS SETTINGS
  # --------------------------------------------------------------------------
  bypass_options_enabled: !input include_bypass
  bypass_switches_on: !input motion_bypass_lights_on
  bypass_switches_off: !input motion_bypass_lights_off
  bypass_switches_stop: !input motion_bypass_lights_stop
  bypass_time_delay_minutes: !input bypass_time_delay
  bypass_auto_off_options: !input include_bypass_auto_off
  bypass_auto_off_delay_minutes: !input bypass_auto_off_delay

  # --------------------------------------------------------------------------
  # ENTITY TYPE CHECKS
  # --------------------------------------------------------------------------
  has_light_entity: >-
    {{ light_entity is not none and 
       light_entity != {} and
       light_entity.entity_id is defined and 
       light_entity.entity_id | select | list | length > 0 }}

  has_scene_entity: "{{ on_scene_entity is not none and on_scene_entity != '' }}"
  has_off_scene: >-
    {{ off_scene_entity is not none and 
       off_scene_entity != [] and 
       off_scene_entity | select | list | length > 0 }}
  has_night_lights: >-
    {{ night_lights_target is not none and 
       night_lights_target != {} and
       night_lights_target.entity_id is defined and 
       night_lights_target.entity_id | select | list | length > 0 }}









  # --------------------------------------------------------------------------
  # COMPUTED: Light OFF Data
  # --------------------------------------------------------------------------
  light_off_data: >-
    {% set data = {} %}
    {% if 'use_transition' in light_control_options %}
      {% set data = dict(data, transition=light_transition_off_time) %}
    {% endif %}
    {{ data }}

  # --------------------------------------------------------------------------
  # STATE CONTROL
  # --------------------------------------------------------------------------
  use_state_control_condition: !input include_state_control
  state_control_entity_id: !input state_control_entity
  required_state: !input state_control_activation_state

  state_control_allows_light: >-
    {% if use_state_control_condition != 'state_control_enabled' %}
      true
    {% elif state_control_entity_id is none or state_control_entity_id == '' %}
      true
    {% elif states(state_control_entity_id) in ['unavailable', 'unknown'] %}
      true
    {% else %}
      {{ is_state(state_control_entity_id, required_state) }}
    {% endif %}

  # --------------------------------------------------------------------------
  # DEVICE TRACKER - FIXED v5.0.4
  # --------------------------------------------------------------------------
  use_device_tracker_check: !input include_device_tracker
  tracker_zone: !input zone
  tracker_people: !input people

  device_tracker_allows_light: >-
    {% if use_device_tracker_check == 'device_tracker_disabled' %}
      true
    {% elif tracker_zone is none or tracker_zone == '' %}
      true
    {% elif states(tracker_zone) in ['unavailable', 'unknown'] %}
      true
    {% else %}
      {% set zone_state_value = tracker_zone.split('.')[-1] %}
      {% set presence_detected = namespace(found=false) %}
      {% if use_device_tracker_check == 'zone_enabled' %}
        {% for entity in states.person %}
          {% if states(entity.entity_id) not in ['unavailable', 'unknown'] and is_state(entity.entity_id, zone_state_value) %}
            {% set presence_detected.found = true %}
          {% endif %}
        {% endfor %}
        {% if not presence_detected.found %}
          {% for entity in states.device_tracker %}
            {% if states(entity.entity_id) not in ['unavailable', 'unknown'] and is_state(entity.entity_id, zone_state_value) %}
              {% set presence_detected.found = true %}
            {% endif %}
          {% endfor %}
        {% endif %}
      {% elif use_device_tracker_check == 'zone_people_enabled' %}
        {% if tracker_people is none or tracker_people | length == 0 %}
          {% set presence_detected.found = true %}
        {% else %}
          {% set zone_friendly_name = state_attr(tracker_zone, 'friendly_name') %}
          {% for person_entity in tracker_people %}
            {% set person_state = states(person_entity) %}
            {# Check if person state matches zone entity ID, zone friendly name, OR zone name part #}
            {% set zone_name = tracker_zone.split('.')[-1] %}
            {% if person_state not in ['unavailable', 'unknown'] and (person_state == tracker_zone or person_state == zone_friendly_name or person_state == zone_name) %}
              {% set presence_detected.found = true %}
              {% break %} {# Exit loop early once a match is found #}
            {% endif %}
          {% endfor %}
        {% endif %}
      {% endif %}
      {{ presence_detected.found }}
    {% endif %}

  # --------------------------------------------------------------------------
  # TIME RESTRICTIONS - FIXED v5.0.4 for 24-hour case
  # --------------------------------------------------------------------------
  use_time_restrictions: !input include_time
  time_after: !input after_time
  time_before: !input before_time
  allowed_weekdays: !input weekday_options

  time_restriction_allows_light: >-
    {% if use_time_restrictions != 'time_enabled' %}
      true
    {% else %}
      {% set current_time = now().strftime('%H:%M:%S') %}
      {% set current_day = now().strftime('%a')|lower %}
      {% set day_ok = current_day in allowed_weekdays %}
      {% if time_after == time_before %}
        {% set time_ok = true %}
      {% elif time_after <= time_before %}
        {% set time_ok = current_time >= time_after and current_time <= time_before %}
      {% else %}
        {% set time_ok = current_time >= time_after or current_time <= time_before %}
      {% endif %}
      {{ time_ok and day_ok }}
    {% endif %}

  # --------------------------------------------------------------------------
  # COMPUTED: Bypass Active Checks
  # --------------------------------------------------------------------------
  any_bypass_on_active: >-
    {{ 'bypass_enabled_turn_on' in bypass_options_enabled and
       bypass_switches_on is not none and 
       bypass_switches_on | select | list | length > 0 and
       expand(bypass_switches_on) | selectattr('state', 'eq', 'on') | list | length > 0 }}

  any_bypass_off_active: >-
    {{ 'bypass_enabled_turn_off' in bypass_options_enabled and
       bypass_switches_off is not none and 
       bypass_switches_off | select | list | length > 0 and
       expand(bypass_switches_off) | selectattr('state', 'eq', 'on') | list | length > 0 }}

  any_bypass_stop_active: >-
    {{ 'bypass_enabled_stop' in bypass_options_enabled and
       bypass_switches_stop is not none and 
       bypass_switches_stop | select | list | length > 0 and
       expand(bypass_switches_stop) | selectattr('state', 'eq', 'on') | list | length > 0 }}

  any_bypass_active: >-
    {{ any_bypass_on_active or any_bypass_off_active or any_bypass_stop_active }}

  bypass_allows_lights_on: >-
    {{ not any_bypass_off_active and not any_bypass_stop_active }}

  bypass_allows_lights_off: >-
    {{ not any_bypass_on_active and not any_bypass_stop_active }}

  # --------------------------------------------------------------------------
  # COMPUTED: Night Lights Active Check
  # --------------------------------------------------------------------------
  night_lights_active: >-
    {% if use_night_lights != 'night_lights_enabled' or night_lights_conditions | length == 0 %}
      false
    {% else %}
      {% set conditions_met = namespace(value=true) %}

      {% if 'entity_state_enabled' in night_lights_conditions %}
        {% if night_lights_entity_state_list is none or night_lights_entity_state_list | length == 0 %}
          {% set conditions_met.value = false %}
        {% else %}
          {% set entity_state_ok = expand(night_lights_entity_state_list) | selectattr('state', 'eq', 'on') | list | length > 0 %}
          {% if not entity_state_ok %}
            {% set conditions_met.value = false %}
          {% endif %}
        {% endif %}
      {% endif %}

      {% if 'time_enabled' in night_lights_conditions and conditions_met.value %}
        {% set current_time = now().strftime('%H:%M:%S') %}
        {% if night_lights_after_time <= night_lights_before_time %}
          {% if not (current_time >= night_lights_after_time and current_time <= night_lights_before_time) %}
            {% set conditions_met.value = false %}
          {% endif %}
        {% else %}
          {% if not (current_time >= night_lights_after_time or current_time <= night_lights_before_time) %}
            {% set conditions_met.value = false %}
          {% endif %}
        {% endif %}
      {% endif %}

      {% if 'sun_enabled' in night_lights_conditions and conditions_met.value %}
        {% set sun_elevation = state_attr('sun.sun', 'elevation') %}
        {% if sun_elevation is not none %}
          {% set sun_is_rising = state_attr('sun.sun', 'rising') %}
          {% set sun_elev_float = sun_elevation | float(90) %}

          {% if sun_is_rising and (sun_elev_float > night_lights_sun_elevation_rising_val) %}
            {% set conditions_met.value = false %}
          {% elif not sun_is_rising and (sun_elev_float > night_lights_sun_elevation_falling) %}
            {% set conditions_met.value = false %}
          {% endif %}
        {% endif %}
      {% endif %}

      {{ conditions_met.value }}
    {% endif %}

  # --------------------------------------------------------------------------


  night_light_off_data: >-
    {% set data = {} %}
    {% if 'use_transition' in night_light_control_options %}
      {% set data = dict(data, transition=night_light_transition_off_time) %}
    {% endif %}
    {{ data }}

  # --------------------------------------------------------------------------
  # COMPUTED: Night Glow ON/OFF Data
  # --------------------------------------------------------------------------
  night_glow_on_data: >-
    {% set data = {} %}
    {% if 'use_brightness' in night_glow_control_options %}
      {% set data = dict(data, brightness_pct=night_glow_brightness_pct) %}
    {% endif %}
    {% if 'use_transition' in night_glow_control_options %}
      {% set data = dict(data, transition=night_glow_transition_on_time) %}
    {% endif %}
    {% if 'use_effect' in night_glow_control_options and night_glow_effect not in [none, ''] %}
      {% set data = dict(data, effect=night_glow_effect) %}
    {% endif %}
    {% if night_glow_color_control == 'use_color_temperature' %}
      {% set data = dict(data, kelvin=night_glow_color_temp) %}
    {% elif night_glow_color_control == 'use_rgb_color' %}
      {% set data = dict(data, rgb_color=night_glow_rgb) %}
    {% elif night_glow_color_control == 'use_rgbw_color' %}
      {% set data = dict(data, rgbw_color=night_glow_rgbw) %}
    {% elif night_glow_color_control == 'use_rgbww_color' %}
      {% set data = dict(data, rgbww_color=night_glow_rgbww) %}
    {% endif %}
    {{ data }}

  night_glow_off_data: >-
    {% set data = {} %}
    {% if 'use_transition' in night_glow_control_options %}
      {% set data = dict(data, transition=night_glow_transition_off_time) %}
    {% endif %}
    {{ data }}

  # --------------------------------------------------------------------------
  # COMPUTED: Cooldown Active Check
  # --------------------------------------------------------------------------
  in_cooldown: >-
    {% set cooldown_active = false %}
    {% if operating_mode == 'occupancy' and cooldown_entity is not none and cooldown_entity != '' %}
      {% if states(cooldown_entity) not in ['unavailable', 'unknown'] %}
        {% set cooldown_active = is_state(cooldown_entity, 'on') %}
      {% endif %}
    {% elif operating_mode == 'simple' and cooldown_simple_entity is not none and cooldown_simple_entity != '' %}
      {% if states(cooldown_simple_entity) not in ['unavailable', 'unknown'] %}
        {% set cooldown_active = is_state(cooldown_simple_entity, 'on') %}
      {% endif %}
    {% endif %}
    {{ cooldown_active }}

  # --------------------------------------------------------------------------
  # COMPUTED: Should Turn On Light
  # --------------------------------------------------------------------------
  # FIX v5.2.0: Simplified to only check environmental conditions
  # Master controls (cooldown, override, state_control, bypass) moved to master_controls_ok
  should_turn_on_light: >-
    {% set illuminance_ok = true %}
    {% if use_illuminance_sensor and illuminance_entity is not none and illuminance_entity != '' %}
      {% set sensor_state = states(illuminance_entity) %}
      {% if sensor_state not in ['unknown', 'unavailable', 'none'] %}
        {% set current_lux = sensor_state | float(-1) %}
        {% if current_lux >= 0 %}
          {% if illuminance_comparison == 'below' %}
            {% set illuminance_ok = current_lux < illuminance_threshold_value %}
          {% else %}
            {% set illuminance_ok = current_lux > illuminance_threshold_value %}
          {% endif %}
        {% endif %}
      {% endif %}
    {% endif %}
    {{ illuminance_ok and 
       device_tracker_allows_light and 
       time_restriction_allows_light }}

  # --------------------------------------------------------------------------
  # MASTER CONTROLS - FIX v5.2.0
  # --------------------------------------------------------------------------
  # Separates master override controls from environmental conditions
  # Master controls apply to ALL triggers (old and new)
  # These conditions block ALL automation actions when not met
  master_controls_ok: >-
    {{ not in_cooldown and 
       not override_mode_active and 
       state_control_allows_light and 
       bypass_allows_lights_on }}
  
  # FIX v5.2.7: Master controls for new triggers (no cooldown check)
  # New triggers (entity, button, sun, ambient, time) should NOT respect simple mode cooldown
  # Cooldown only applies to trigger_sensor behavior
  master_controls_for_new_triggers: >-
    {{ not override_mode_active and 
       state_control_allows_light and 
       bypass_allows_lights_on }}

  # --------------------------------------------------------------------------
  # COMPUTED: Multi-sensor state checks (for occupancy mode) - FIXED v5.0.4
  # --------------------------------------------------------------------------
  any_motion_on: >-
    {{ operating_mode == 'occupancy' and 
       motion_sensor_entity is not none and
       motion_sensor_entity | length > 0 and
       expand(motion_sensor_entity) | rejectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length > 0 }}

  all_motion_off: >-
    {{ operating_mode != 'occupancy' or 
       motion_sensor_entity is none or 
       motion_sensor_entity | length == 0 or
       expand(motion_sensor_entity) | selectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length == expand(motion_sensor_entity) | list | length }}

  any_door_open: >-
    {{ operating_mode == 'occupancy' and 
       door_sensor_entity is not none and
       door_sensor_entity | length > 0 and
       expand(door_sensor_entity) | rejectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length > 0 }}

  all_doors_closed: >-
    {{ operating_mode != 'occupancy' or 
       door_sensor_entity is none or 
       door_sensor_entity | length == 0 or
       expand(door_sensor_entity) | selectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length == expand(door_sensor_entity) | list | length }}

  # --------------------------------------------------------------------------
  # COMPUTED: Any trigger active (for simple mode) - FIXED v5.0.4
  # --------------------------------------------------------------------------
  any_trigger_active: >-
    {{ operating_mode == 'simple' and 
       trigger_sensor_entity is not none and
       trigger_sensor_entity | length > 0 and
       expand(trigger_sensor_entity) | rejectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length > 0 }}

  # --------------------------------------------------------------------------
  # NEW TRIGGER STATE CHECKS (v5.1.0)
  # --------------------------------------------------------------------------
  new_triggers_on: >-
    {% set entity_on = include_entity_on and entity_input_var != [] and entity_input_var is not none and is_state(entity_input_var, 'on') %}
    {% set sun_low = include_sun_falling and state_attr('sun.sun', 'elevation')|float(100) < sun_elevation_falling_var %}
    {% set lux_low = include_ambient_low and ambient_light_sensor_var != [] and ambient_light_sensor_var is not none and states(ambient_light_sensor_var)|float(999) < ambient_light_low_var %}
    {{ entity_on or sun_low or lux_low }}

  all_triggers_clear: >-
    {% set old_triggers_clear = operating_mode != 'simple' or trigger_sensor_entity is none or trigger_sensor_entity | length == 0 or expand(trigger_sensor_entity) | selectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length == expand(trigger_sensor_entity) | list | length %}
    {% set new_triggers_clear = not new_triggers_on %}
    {{ old_triggers_clear and new_triggers_clear }}

  # --------------------------------------------------------------------------
  # COMPUTED: Any light/scene is currently on
  # --------------------------------------------------------------------------
  is_any_light_on: >-
    {% set any_on = namespace(value=false) %}
    {% if has_light_entity %}
      {% if expand(light_entity.entity_id) | rejectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length > 0 %}
        {% set any_on.value = true %}
      {% endif %}
    {% endif %}
    {% if not any_on.value and boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' %}
      {% if states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] and is_state(boolean_scenes_scripts_entity, 'on') %}
        {% set any_on.value = true %}
      {% endif %}
    {% endif %}
    {{ any_on.value }}

# ==============================================================================
# TRIGGERS
# ==============================================================================
trigger:
  # Simple mode triggers
  - platform: state
    entity_id: !input trigger_sensor
    id: trigger_on
    to: "on"
  - platform: state
    entity_id: !input trigger_sensor
    id: trigger_off
    to: "off"

  # ============================================================================
  # NEW SIMPLE MODE TRIGGERS - ADVANCED TRIGGERS (v5.1.0)
  # ============================================================================
  
  # ----------------------------------------------------------------------------
  # Entity State Trigger
  # ----------------------------------------------------------------------------
  - platform: state
    entity_id: !input entity_input
    to: "on"
    id: entity_trigger_on
  
  - platform: state
    entity_id: !input entity_input
    to: "off"
    id: entity_trigger_off
  
  # ----------------------------------------------------------------------------
  # Push Button Trigger
  # ----------------------------------------------------------------------------
  - platform: state
    entity_id: !input button_input
    id: button_trigger_on
  
  - platform: state
    entity_id: !input button_input
    id: button_trigger_off
  
  # ----------------------------------------------------------------------------
  # Sun Elevation Trigger
  # ----------------------------------------------------------------------------
  - platform: numeric_state
    entity_id: sun.sun
    attribute: elevation
    below: !input sun_elevation
    id: sun_trigger_on
  
  - platform: numeric_state
    entity_id: sun.sun
    attribute: elevation
    above: !input sun_elevation_rising
    id: sun_trigger_off
  
  # ----------------------------------------------------------------------------
  # Ambient Light Trigger
  # ----------------------------------------------------------------------------
  - platform: numeric_state
    entity_id: !input ambient_light_sensor
    below: !input ambient_light_value
    id: ambient_trigger_on
  
  - platform: numeric_state
    entity_id: !input ambient_light_sensor
    above: !input ambient_light_value_off
    id: ambient_trigger_off
  
  # ----------------------------------------------------------------------------
  # Time Trigger
  # ----------------------------------------------------------------------------
  - platform: time
    at: !input time_trigger_on
    id: time_trigger_on
  
  - platform: time
    at: !input time_trigger_off
    id: time_trigger_off

  # Occupancy mode triggers
  - platform: state
    entity_id: !input motion_sensor
    id: motion_on
    from: "off"
    to: "on"
  - platform: state
    entity_id: !input motion_sensor
    id: motion_off
    from: "on"
    to: "off"
  - platform: state
    entity_id: !input door_sensor
    id: door_open
    from: "off"
    to: "on"
  - platform: state
    entity_id: !input door_sensor
    id: door_close
    from: "on"
    to: "off"

  # Manual control triggers - detect manual turn OFF
  - platform: state
    entity_id: !input manual_control_helper
    from: "on"
    to: "off"
    id: manual_control_off_occupancy
  - platform: state
    entity_id: !input manual_control_simple_helper
    from: "on"
    to: "off"
    id: manual_control_off_simple

  # FIX v5.0.10: Manual control trigger - detect manual turn ON
  - platform: state
    entity_id: !input manual_control_helper
    from: "off"
    to: "on"
    id: manual_control_activated

  # Time-based triggers for night mode transitions
  - platform: time
    at: !input night_lights_after_time
    id: night_mode_time_start
  - platform: time
    at: !input night_lights_before_time
    id: night_mode_time_end

  # State-based trigger for night mode entity
  - platform: state
    entity_id: !input night_lights_entity_state
    id: night_mode_entity_change

  # Override mode trigger
  - platform: state
    entity_id: !input override_mode_helper
    to: "on"
    id: override_mode_activated
  - platform: state
    entity_id: !input override_mode_helper
    to: "off"
    id: override_mode_deactivated

  # Home Assistant start trigger
  - platform: homeassistant
    event: start
    id: ha_start

# ==============================================================================
# TRIGGER VALIDATION CONDITIONS
# ==============================================================================
# Ensures only enabled features can trigger the automation and restart timers.
# This prevents disabled features from cancelling active delays and leaving 
# lights on unexpectedly.
# ==============================================================================
condition:
- condition: or
  conditions:
  
  # --------------------------------------------------------------------------
  # SIMPLE MODE - Basic Triggers
  # --------------------------------------------------------------------------
  - condition: and
    conditions:
    - condition: trigger
      id: trigger_on
    - '{{ operating_mode == "simple" }}'
  
  - condition: and
    conditions:
    - condition: trigger
      id: trigger_off
    - '{{ operating_mode == "simple" }}'
  
  # --------------------------------------------------------------------------
  # SIMPLE MODE - Entity State Trigger
  # --------------------------------------------------------------------------
  - condition: and
    conditions:
    - condition: trigger
      id: entity_trigger_on
    - '{{ operating_mode == "simple" and (include_entity_on or include_entity_off) }}'
  
  - condition: and
    conditions:
    - condition: trigger
      id: entity_trigger_off
    - '{{ operating_mode == "simple" and (include_entity_on or include_entity_off) }}'
  
  # --------------------------------------------------------------------------
  # SIMPLE MODE - Push Button Trigger
  # --------------------------------------------------------------------------
  - condition: and
    conditions:
    - condition: trigger
      id: button_trigger_on
    - '{{ operating_mode == "simple" and (include_button_on or include_button_off) }}'
  
  - condition: and
    conditions:
    - condition: trigger
      id: button_trigger_off
    - '{{ operating_mode == "simple" and (include_button_on or include_button_off) }}'
  
  # --------------------------------------------------------------------------
  # SIMPLE MODE - Sun Elevation Trigger
  # --------------------------------------------------------------------------
  - condition: and
    conditions:
    - condition: trigger
      id: sun_trigger_on
    - '{{ operating_mode == "simple" and (include_sun_falling or include_sun_rising) }}'
  
  - condition: and
    conditions:
    - condition: trigger
      id: sun_trigger_off
    - '{{ operating_mode == "simple" and (include_sun_falling or include_sun_rising) }}'
  
  # --------------------------------------------------------------------------
  # SIMPLE MODE - Ambient Light Trigger
  # --------------------------------------------------------------------------
  - condition: and
    conditions:
    - condition: trigger
      id: ambient_trigger_on
    - '{{ operating_mode == "simple" and (include_ambient_low or include_ambient_high) }}'
  
  - condition: and
    conditions:
    - condition: trigger
      id: ambient_trigger_off
    - '{{ operating_mode == "simple" and (include_ambient_low or include_ambient_high) }}'
  
  # --------------------------------------------------------------------------
  # SIMPLE MODE - Time Trigger
  # --------------------------------------------------------------------------
  - condition: and
    conditions:
    - condition: trigger
      id: time_trigger_on
    - '{{ operating_mode == "simple" and (include_time_on or include_time_off) }}'
  
  - condition: and
    conditions:
    - condition: trigger
      id: time_trigger_off
    - '{{ operating_mode == "simple" and (include_time_on or include_time_off) }}'
  
  # --------------------------------------------------------------------------
  # OCCUPANCY MODE - Motion Triggers
  # --------------------------------------------------------------------------
  - condition: and
    conditions:
    - condition: trigger
      id: motion_on
    - '{{ operating_mode == "occupancy" }}'
  
  - condition: and
    conditions:
    - condition: trigger
      id: motion_off
    - '{{ operating_mode == "occupancy" }}'
  
  # --------------------------------------------------------------------------
  # OCCUPANCY MODE - Door Triggers
  # --------------------------------------------------------------------------
  - condition: and
    conditions:
    - condition: trigger
      id: door_open
    - '{{ operating_mode == "occupancy" and door_sensor_entity not in [none, "", []] }}'
  
  - condition: and
    conditions:
    - condition: trigger
      id: door_close
    - '{{ operating_mode == "occupancy" and door_sensor_entity not in [none, "", []] }}'
  
  # --------------------------------------------------------------------------
  # MANUAL CONTROL - Occupancy Mode
  # --------------------------------------------------------------------------
  - condition: and
    conditions:
    - condition: trigger
      id: manual_control_off_occupancy
    - '{{ operating_mode == "occupancy" and use_manual_control_feature and manual_control_entity != "" }}'
  
  - condition: and
    conditions:
    - condition: trigger
      id: manual_control_activated
    - '{{ operating_mode == "occupancy" and use_manual_control_feature and manual_control_entity != "" }}'
  
  # --------------------------------------------------------------------------
  # MANUAL CONTROL - Simple Mode
  # --------------------------------------------------------------------------
  - condition: and
    conditions:
    - condition: trigger
      id: manual_control_off_simple
    - '{{ operating_mode == "simple" and manual_control_simple_entity != "" }}'
  
  # --------------------------------------------------------------------------
  # NIGHT MODE - Time-Based Triggers
  # --------------------------------------------------------------------------
  - condition: and
    conditions:
    - condition: trigger
      id: night_mode_time_start
    - '{{ use_night_lights == "night_lights_enabled" and "time_enabled" in night_lights_conditions }}'
  
  - condition: and
    conditions:
    - condition: trigger
      id: night_mode_time_end
    - '{{ use_night_lights == "night_lights_enabled" and "time_enabled" in night_lights_conditions }}'
  
  # --------------------------------------------------------------------------
  # NIGHT MODE - Entity State Trigger
  # --------------------------------------------------------------------------
  - condition: and
    conditions:
    - condition: trigger
      id: night_mode_entity_change
    - '{{ use_night_lights == "night_lights_enabled" and "entity_state_enabled" in night_lights_conditions }}'
  
  # --------------------------------------------------------------------------
  # OVERRIDE MODE - Activation/Deactivation
  # --------------------------------------------------------------------------
  - condition: and
    conditions:
    - condition: trigger
      id: override_mode_activated
    - '{{ use_override_mode_feature }}'
  
  - condition: and
    conditions:
    - condition: trigger
      id: override_mode_deactivated
    - '{{ use_override_mode_feature }}'
  
  # --------------------------------------------------------------------------
  # HOME ASSISTANT START - Always Enabled
  # --------------------------------------------------------------------------
  - condition: and
    conditions:
    - condition: trigger
      id: ha_start
    - '{{ true }}'

# ==============================================================================
# ACTIONS
# ==============================================================================
action:
  # ==============================================================================
  # POWER OUTAGE RECOVERY - Handle first to correct unexpected states
  # ==============================================================================
  - choose:
      - conditions:
          - condition: trigger
            id: ha_start
          - "{{ use_power_recovery_feature }}"
        sequence:
          - delay:
              seconds: "{{ power_recovery_delay_seconds }}"
          - choose:
              # If override mode is active, respect it
              - conditions:
                  - "{{ override_mode_active }}"
                sequence:
                  - stop: "Override mode active, respecting override state"
              # If any bypass is active, respect it
              - conditions:
                  - "{{ any_bypass_active }}"
                sequence:
                  - stop: "Bypass active, respecting bypass state"
            default:
              # Check if room should have lights off
              # v5.4.0: Real-time evaluation for all mode checks
              - if:
                  - condition: or
                    conditions:
                      # Simple mode: all triggers are clear
                      - condition: and
                        conditions:
                          - "{{ operating_mode == 'simple' }}"
                          - condition: template
                            value_template: >-
                              {% set old_triggers_clear = operating_mode != 'simple' or trigger_sensor_entity is none or trigger_sensor_entity | length == 0 or expand(trigger_sensor_entity) | selectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length == expand(trigger_sensor_entity) | list | length %}
                              {% set entity_on = include_entity_on and entity_input_var != [] and entity_input_var is not none and is_state(entity_input_var, 'on') %}
                              {% set sun_low = include_sun_falling and state_attr('sun.sun', 'elevation')|float(100) < sun_elevation_falling_var %}
                              {% set lux_low = include_ambient_low and ambient_light_sensor_var != [] and ambient_light_sensor_var is not none and states(ambient_light_sensor_var)|float(999) < ambient_light_low_var %}
                              {% set new_triggers_clear = not (entity_on or sun_low or lux_low) %}
                              {{ old_triggers_clear and new_triggers_clear }}
                      # Occupancy mode: room is not occupied
                      - condition: and
                        conditions:
                          - "{{ operating_mode == 'occupancy' }}"
                          - "{{ occupancy_entity is not none and occupancy_entity != '' }}"
                          - "{{ states(occupancy_entity) not in ['unavailable', 'unknown'] }}"
                          - "{{ is_state(occupancy_entity, 'off') }}"
                          - condition: template
                            value_template: >-
                              {{ operating_mode != 'occupancy' or 
                                 motion_sensor_entity is none or 
                                 motion_sensor_entity | length == 0 or
                                 expand(motion_sensor_entity) | selectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length == expand(motion_sensor_entity) | list | length }}
                          - condition: template
                            value_template: >-
                              {{ operating_mode != 'occupancy' or 
                                 door_sensor_entity is none or 
                                 door_sensor_entity | length == 0 or
                                 expand(door_sensor_entity) | selectattr('state', 'in', ['off', 'closed', 'unavailable', 'unknown']) | list | length == expand(door_sensor_entity) | list | length }}
                then:
                  # Turn off lights if they're on
                  - if:
                      - "{{ is_any_light_on }}"
                    then:
                      - if:
                          - "{{ (light_control_type_var == 'devices' or light_control_type_var == 'both') and has_light_entity }}"
                        then:
                          - service: homeassistant.turn_off
                            target: !input light_switch
                            data: "{{ light_off_data }}"
                      - if:
                          - "{{ (light_control_type_var == 'scenes' or light_control_type_var == 'both') and has_off_scene }}"
                        then:
                          - repeat:
                              for_each: !input off_scene
                              sequence:
                                - condition: template
                                  value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                                - service: homeassistant.turn_on
                                  target:
                                    entity_id: "{{ repeat.item }}"
                      - if:
                          - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                          - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                        then:
                          - service: input_boolean.turn_off
                            target:
                              entity_id: "{{ boolean_scenes_scripts_entity }}"
                      - if:
                          - "{{ has_turn_off_only_devices }}"
                        then:
                          - service: homeassistant.turn_off
                            target: !input turn_off_only_entities
          - stop: "Power recovery complete"

  # ==============================================================================
  # OVERRIDE MODE HANDLING - Checked after power recovery
  # ==============================================================================
  - choose:
      - conditions:
          - condition: trigger
            id: override_mode_activated
        sequence:
          - if:
              - "{{ has_light_entity }}"
            then:
              - variables:
                  current_override_light_data: >-
                    {% set data = {} %}
                    {% if 'use_brightness' in light_control_options %}
                      {% set data = dict(data, brightness_pct=override_mode_brightness_val) %}
                    {% endif %}
                    {% if 'use_transition' in light_control_options %}
                      {% set data = dict(data, transition=light_transition_on_time) %}
                    {% endif %}
                    {% if 'use_effect' in light_control_options and override_mode_effect_val not in [none, ''] %}
                      {% set data = dict(data, effect=override_mode_effect_val) %}
                    {% endif %}
                    {% if light_color_control == 'use_color_temperature' %}
                      {% set data = dict(data, kelvin=override_mode_color_temp_val) %}
                    {% elif light_color_control == 'use_rgb_color' %}
                      {% set data = dict(data, rgb_color=override_mode_rgb_val) %}
                    {% elif light_color_control == 'use_rgbw_color' %}
                      {% set data = dict(data, rgbw_color=override_mode_rgbw_val) %}
                    {% elif light_color_control == 'use_rgbww_color' %}
                      {% set data = dict(data, rgbww_color=override_mode_rgbww_val) %}
                    {% endif %}
                    {{ data }}
              
              - service: homeassistant.turn_on
                target: !input light_switch
                data: "{{ current_override_light_data }}"
          - if:
              - "{{ has_scene_entity }}"
            then:
              - condition: template
                value_template: "{{ states(on_scene_entity) not in ['unavailable', 'unknown'] }}"
              - service: homeassistant.turn_on
                target:
                  entity_id: "{{ on_scene_entity }}"
          - stop: "Override mode activated, lights forced on"
      
      - conditions:
          - condition: trigger
            id: override_mode_deactivated
        sequence:
          - delay:
              seconds: 2
          - stop: "Override mode deactivated, resuming normal automation"

  # ==============================================================================
  # MANUAL CONTROL COOLDOWN HANDLING
  # ==============================================================================
  - choose:
      # ============================================================================
      # MANUAL CONTROL: Occupancy mode - manual turn OFF detected
      # ============================================================================
      - conditions:
          - condition: trigger
            id: manual_control_off_occupancy
          - "{{ operating_mode == 'occupancy' }}"
          - "{{ use_manual_control_feature }}"
          - "{{ cooldown_entity is not none and cooldown_entity != '' }}"
        sequence:
          # Enter cooldown mode
          - condition: template
            value_template: "{{ states(cooldown_entity) not in ['unavailable', 'unknown'] }}"
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ cooldown_entity }}"

          # Reset all occupancy helpers immediately
          - if:
              - "{{ occupancy_entity is not none and occupancy_entity != '' }}"
              - "{{ states(occupancy_entity) not in ['unavailable', 'unknown'] }}"
            then:
              - service: input_boolean.turn_off
                target:
                  entity_id: "{{ occupancy_entity }}"
          - if:
              - "{{ entering_entity is not none and entering_entity != '' }}"
              - "{{ states(entering_entity) not in ['unavailable', 'unknown'] }}"
            then:
              - service: input_boolean.turn_off
                target:
                  entity_id: "{{ entering_entity }}"
          - if:
              - "{{ entered_entity is not none and entered_entity != '' }}"
              - "{{ states(entered_entity) not in ['unavailable', 'unknown'] }}"
            then:
              - service: input_boolean.turn_off
                target:
                  entity_id: "{{ entered_entity }}"
          - if:
              - "{{ exiting_entity is not none and exiting_entity != '' }}"
              - "{{ states(exiting_entity) not in ['unavailable', 'unknown'] }}"
            then:
              - service: input_boolean.turn_off
                target:
                  entity_id: "{{ exiting_entity }}"

          # Reset scene helper
          - if:
              - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
              - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
            then:
              - service: input_boolean.turn_off
                target:
                  entity_id: "{{ boolean_scenes_scripts_entity }}"

          # FIX v5.2.1: Turn off night lights if option enabled
          # Night lights turn off ANY time (not just during night mode window)
          # Independent from main lights control behavior
          - if:
              - "{{ manual_control_turns_off_night_lights_var }}"
              - "{{ has_night_lights }}"
            then:
              # Turn off night lights
              - if:
                  - "{{ night_lights_target is not none and night_lights_target != {} and night_lights_target.entity_id is defined and night_lights_target.entity_id | select | list | length > 0 }}"
                then:
                  - delay:
                      milliseconds: 500
                  - service: homeassistant.turn_off
                    target: !input night_lights
                    data:
                      transition: "{{ night_light_transition_off_time }}"
              
              # Turn off night glow
              - if:
                  - "{{ use_night_glow == 'night_glow_enabled' and night_glow_target is not none and night_glow_target != {} and night_glow_target.entity_id is defined and night_glow_target.entity_id | select | list | length > 0 }}"
                then:
                  - delay:
                      milliseconds: 500
                  - service: homeassistant.turn_off
                    target: !input night_glow_lights
                    data:
                      transition: "{{ night_glow_transition_off_time }}"
              
              # Reset night boolean helper
              - if:
                  - "{{ night_boolean_scenes_scripts_entity is not none and night_boolean_scenes_scripts_entity != '' }}"
                  - "{{ states(night_boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                then:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ night_boolean_scenes_scripts_entity }}"

          # Cooldown delay (user exits room)
          - delay:
              seconds: "{{ manual_control_cooldown_seconds }}"

          # Exit cooldown mode
          - condition: template
            value_template: "{{ states(cooldown_entity) not in ['unavailable', 'unknown'] }}"
          - service: input_boolean.turn_off
            target:
              entity_id: "{{ cooldown_entity }}"

      # ============================================================================
      # MANUAL CONTROL: Simple mode - manual turn OFF detected
      # ============================================================================
      - conditions:
          - condition: trigger
            id: manual_control_off_simple
          - "{{ operating_mode == 'simple' }}"
          - "{{ manual_control_simple_entity is not none and manual_control_simple_entity != '' }}"
          - "{{ cooldown_simple_entity is not none and cooldown_simple_entity != '' }}"
        sequence:
          # Enter cooldown mode
          - condition: template
            value_template: "{{ states(cooldown_simple_entity) not in ['unavailable', 'unknown'] }}"
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ cooldown_simple_entity }}"

          # Reset scene helper
          - if:
              - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
              - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
            then:
              - service: input_boolean.turn_off
                target:
                  entity_id: "{{ boolean_scenes_scripts_entity }}"

          # FIX v5.2.1: Turn off night lights if option enabled
          # Night lights turn off ANY time (not just during night mode window)
          # Independent from main lights control behavior
          - if:
              - "{{ manual_control_turns_off_night_lights_var }}"
              - "{{ has_night_lights }}"
            then:
              # Turn off night lights
              - if:
                  - "{{ night_lights_target is not none and night_lights_target != {} and night_lights_target.entity_id is defined and night_lights_target.entity_id | select | list | length > 0 }}"
                then:
                  - delay:
                      milliseconds: 500
                  - service: homeassistant.turn_off
                    target: !input night_lights
                    data:
                      transition: "{{ night_light_transition_off_time }}"
              
              # Turn off night glow
              - if:
                  - "{{ use_night_glow == 'night_glow_enabled' and night_glow_target is not none and night_glow_target != {} and night_glow_target.entity_id is defined and night_glow_target.entity_id | select | list | length > 0 }}"
                then:
                  - delay:
                      milliseconds: 500
                  - service: homeassistant.turn_off
                    target: !input night_glow_lights
                    data:
                      transition: "{{ night_glow_transition_off_time }}"
              
              # Reset night boolean helper
              - if:
                  - "{{ night_boolean_scenes_scripts_entity is not none and night_boolean_scenes_scripts_entity != '' }}"
                  - "{{ states(night_boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                then:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ night_boolean_scenes_scripts_entity }}"

          # Cooldown delay (user exits room)
          - delay:
              seconds: "{{ manual_control_simple_cooldown_seconds }}"

          # Exit cooldown mode
          - condition: template
            value_template: "{{ states(cooldown_simple_entity) not in ['unavailable', 'unknown'] }}"
          - service: input_boolean.turn_off
            target:
              entity_id: "{{ cooldown_simple_entity }}"

      # ============================================================================
      # FIX v5.0.10: MANUAL CONTROL: Manual turn ON timeout check
      # ============================================================================
      - conditions:
          - condition: trigger
            id: manual_control_activated
          - "{{ operating_mode == 'occupancy' }}"
          - "{{ use_manual_control_feature }}"
        sequence:
          # Wait for manual control timeout period
          - delay:
              seconds: "{{ manual_control_timeout_seconds }}"
          
          # Check if occupancy was never confirmed
          - condition: template
            value_template: >
              {{ occupancy_entity is not none and occupancy_entity != '' 
                 and states(occupancy_entity) not in ['unavailable', 'unknown']
                 and is_state(occupancy_entity, 'off') }}
          
          # Turn off lights if no occupancy detected
          - if:
              - "{{ allows_turn_off }}"
            then:
              - if:
                  - "{{ (light_control_type_var == 'devices' or light_control_type_var == 'both') and has_light_entity }}"
                then:
                  - service: homeassistant.turn_off
                    target: !input light_switch
                    data: "{{ light_off_data }}"
              - if:
                  - "{{ (light_control_type_var == 'scenes' or light_control_type_var == 'both') and has_off_scene }}"
                then:
                  - repeat:
                      for_each: !input off_scene
                      sequence:
                        - condition: template
                          value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                        - service: homeassistant.turn_on
                          target:
                            entity_id: "{{ repeat.item }}"
              - if:
                  - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                  - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                then:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ boolean_scenes_scripts_entity }}"

  # ==============================================================================
  # BYPASS HANDLING - Checked after cooldown and override
  # ==============================================================================
  - choose:
      # ============================================================================
      # BYPASS: Turn ON bypass activated
      # ============================================================================
      - conditions:
          - "{{ any_bypass_on_active }}"
          - "{{ not override_mode_active }}"
          - "{{ not (is_any_light_on and not bypass_allows_lights_on) }}"
        sequence:
          - if:
              - "{{ allows_turn_on }}"
            then:
              - if:
                  - "{{ (light_control_type_var == 'devices' or light_control_type_var == 'both') and has_light_entity }}"
                then:
                  - variables:
                      current_dynamic_brightness: >-
                        {% set clamp = namespace(value=0) %}
                        {% if not use_dynamic_lighting_feature or brightness_mode_setting == 'fixed' %}
                          {% set clamp.value = light_brightness_pct %}
                        {% elif brightness_mode_setting in ['sun_elevation', 'sun_elevation_inverted'] %}
                          {% set sun_elev = state_attr('sun.sun', 'elevation') | float(0) %}
                          {% set min_elev = al_sunset_elevation_val | float(-6) %}
                          {% set max_elev = al_noon_elevation_val | float(60) %}
                          {% set min_bright = al_min_brightness_val | float(20) %}
                          {% set max_bright = al_max_brightness_val | float(100) %}
                          {% if brightness_mode_setting == 'sun_elevation' %}
                            {% if sun_elev <= min_elev %}
                              {% set clamp.value = min_bright %}
                            {% elif sun_elev >= max_elev %}
                              {% set clamp.value = max_bright %}
                            {% else %}
                              {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                              {% set clamp.value = min_bright + (ratio * (max_bright - min_bright)) %}
                            {% endif %}
                          {% else %}
                            {% if sun_elev <= min_elev %}
                              {% set clamp.value = max_bright %}
                            {% elif sun_elev >= max_elev %}
                              {% set clamp.value = min_bright %}
                            {% else %}
                              {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                              {% set clamp.value = max_bright - (ratio * (max_bright - min_bright)) %}
                            {% endif %}
                          {% endif %}
                        {% elif brightness_mode_setting == 'time_based' %}
                          {% set current_time = now().strftime('%H:%M:%S') %}
                          {% if current_time >= late_night_time_val or current_time < morning_time_val %}
                            {% set clamp.value = late_night_brightness_val %}
                          {% elif current_time >= morning_time_val and current_time < day_time_val %}
                            {% set clamp.value = morning_brightness_val %}
                          {% elif current_time >= day_time_val and current_time < evening_time_val %}
                            {% set clamp.value = day_brightness_val %}
                          {% else %}
                            {% set clamp.value = evening_brightness_val %}
                          {% endif %}
                        {% elif brightness_mode_setting in ['lux', 'lux_inverted'] %}
                          {% if not use_illuminance_sensor or illuminance_entity is none or illuminance_entity == '' %}
                            {% set clamp.value = light_brightness_pct %}
                          {% else %}
                            {% set lux_state = states(illuminance_entity) %}
                            {% if lux_state in ['unknown', 'unavailable', 'none'] %}
                              {% set clamp.value = light_brightness_pct %}
                            {% else %}
                              {% set current_lux = lux_state | float(0) %}
                              {% set min_lux = lux_for_min_brightness_val | float(50) %}
                              {% set max_lux = lux_for_max_brightness_val | float(300) %}
                              {% set min_bright = lux_min_brightness_val | float(10) %}
                              {% set max_bright = lux_max_brightness_val | float(100) %}
                              {% if brightness_mode_setting == 'lux' %}
                                {% if current_lux <= min_lux %}
                                  {% set clamp.value = min_bright %}
                                {% elif current_lux >= max_lux %}
                                  {% set clamp.value = max_bright %}
                                {% else %}
                                  {% set ratio = (current_lux - min_lux) / (max_lux - min_lux) %}
                                  {% set clamp.value = min_bright + (ratio * (max_bright - min_bright)) %}
                                {% endif %}
                              {% else %}
                                {% if current_lux <= min_lux %}
                                  {% set clamp.value = max_bright %}
                                {% elif current_lux >= max_lux %}
                                  {% set clamp.value = min_bright %}
                                {% else %}
                                  {% set ratio = (current_lux - min_lux) / (max_lux - min_lux) %}
                                  {% set clamp.value = max_bright - (ratio * (max_bright - min_bright)) %}
                                {% endif %}
                              {% endif %}
                            {% endif %}
                          {% endif %}
                        {% else %}
                          {% set clamp.value = light_brightness_pct %}
                        {% endif %}
                        {{ ([1, clamp.value | int, 100] | sort)[1] }}
                      
                      current_dynamic_color_temp: >-
                        {% set clamp = namespace(value=0) %}
                        {% if not use_dynamic_lighting_feature or color_temp_mode_setting == 'fixed' %}
                          {% set clamp.value = light_color_temp %}
                        {% elif color_temp_mode_setting == 'sun_elevation' %}
                          {% set sun_elev = state_attr('sun.sun', 'elevation') | float(0) %}
                          {% set min_elev = al_sunset_elevation_val | float(-6) %}
                          {% set max_elev = al_noon_elevation_val | float(60) %}
                          {% set min_kelvin = al_min_kelvin_val | float(2700) %}
                          {% set max_kelvin = al_max_kelvin_val | float(5000) %}
                          {% if sun_elev <= min_elev %}
                            {% set clamp.value = min_kelvin %}
                          {% elif sun_elev >= max_elev %}
                            {% set clamp.value = max_kelvin %}
                          {% else %}
                            {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                            {% set clamp.value = min_kelvin + (ratio * (max_kelvin - min_kelvin)) %}
                          {% endif %}
                        {% elif color_temp_mode_setting == 'time_based' %}
                          {% set current_time = now().strftime('%H:%M:%S') %}
                          {% if current_time >= late_night_time_val or current_time < morning_time_val %}
                            {% set clamp.value = late_night_kelvin_val %}
                          {% elif current_time >= morning_time_val and current_time < day_time_val %}
                            {% set clamp.value = morning_kelvin_val %}
                          {% elif current_time >= day_time_val and current_time < evening_time_val %}
                            {% set clamp.value = day_kelvin_val %}
                          {% else %}
                            {% set clamp.value = evening_kelvin_val %}
                          {% endif %}
                        {% else %}
                          {% set clamp.value = light_color_temp %}
                        {% endif %}
                        {{ ([2000, clamp.value | int, 8000] | sort)[1] }}
                      
                      current_light_data: >-
                        {% set data = {} %}
                        {% if 'use_brightness' in light_control_options %}
                          {% set data = dict(data, brightness_pct=current_dynamic_brightness) %}
                        {% endif %}
                        {% if 'use_transition' in light_control_options %}
                          {% set data = dict(data, transition=light_transition_on_time) %}
                        {% endif %}
                        {% if 'use_effect' in light_control_options and light_effect not in [none, ''] %}
                          {% set data = dict(data, effect=light_effect) %}
                        {% endif %}
                        {% if light_color_control == 'use_color_temperature' %}
                          {% set data = dict(data, kelvin=current_dynamic_color_temp) %}
                        {% elif light_color_control == 'use_rgb_color' %}
                          {% set data = dict(data, rgb_color=light_rgb) %}
                        {% elif light_color_control == 'use_rgbw_color' %}
                          {% set data = dict(data, rgbw_color=light_rgbw) %}
                        {% elif light_color_control == 'use_rgbww_color' %}
                          {% set data = dict(data, rgbww_color=light_rgbww) %}
                        {% endif %}
                        {{ data }}
                  
                  - service: homeassistant.turn_on
                    target: !input light_switch
                    data: "{{ current_light_data }}"
              - if:
                  - "{{ (light_control_type_var == 'scenes' or light_control_type_var == 'both') and has_scene_entity }}"
                then:
                  - condition: template
                    value_template: "{{ states(on_scene_entity) not in ['unavailable', 'unknown'] }}"
                  - service: homeassistant.turn_on
                    target:
                      entity_id: "{{ on_scene_entity }}"
                  - if:
                      - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                      - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                    then:
                      - service: input_boolean.turn_on
                        target:
                          entity_id: "{{ boolean_scenes_scripts_entity }}"
          - if:
              - "{{ 'bypass_auto_off_enabled_on' in bypass_auto_off_options and bypass_switches_on is not none and bypass_switches_on | select | list | length > 0 }}"
            then:
              - delay:
                  minutes: "{{ bypass_auto_off_delay_minutes }}"
              - repeat:
                  for_each: "{{ bypass_switches_on }}"
                  sequence:
                    - condition: template
                      value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                    - service: homeassistant.turn_off
                      target:
                        entity_id: "{{ repeat.item }}"

      # ============================================================================
      # BYPASS: Turn OFF bypass activated
      # ============================================================================
      - conditions:
          - "{{ any_bypass_off_active }}"
          - "{{ not override_mode_active }}"
        sequence:
          - if:
              - "{{ allows_turn_off }}"
            then:
              - if:
                  - "{{ (light_control_type_var == 'devices' or light_control_type_var == 'both') and has_light_entity }}"
                then:
                  - delay:
                      milliseconds: 500
                  - service: homeassistant.turn_off
                    target: !input light_switch
                    data: "{{ light_off_data }}"
              - if:
                  - "{{ (light_control_type_var == 'scenes' or light_control_type_var == 'both') and has_off_scene }}"
                then:
                  - delay:
                      milliseconds: 500
                  - repeat:
                      for_each: !input off_scene
                      sequence:
                        - condition: template
                          value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                        - service: homeassistant.turn_on
                          target:
                            entity_id: "{{ repeat.item }}"
              - if:
                  - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                  - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                then:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ boolean_scenes_scripts_entity }}"
              # Turn off any turn-off-only devices
              - if:
                  - "{{ has_turn_off_only_devices }}"
                then:
                  - service: homeassistant.turn_off
                    target: !input turn_off_only_entities
          - if:
              - "{{ 'bypass_auto_off_enabled_off' in bypass_auto_off_options and bypass_switches_off is not none and bypass_switches_off | select | list | length > 0 }}"
            then:
              - delay:
                  minutes: "{{ bypass_auto_off_delay_minutes }}"
              - repeat:
                  for_each: "{{ bypass_switches_off }}"
                  sequence:
                    - condition: template
                      value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                    - service: homeassistant.turn_off
                      target:
                        entity_id: "{{ repeat.item }}"

      # ============================================================================
      # BYPASS: Keep state bypass activated
      # ============================================================================
      - conditions:
          - "{{ any_bypass_stop_active }}"
          - "{{ not override_mode_active }}"
        sequence:
          - if:
              - "{{ 'bypass_auto_off_enabled_stop' in bypass_auto_off_options and bypass_switches_stop is not none and bypass_switches_stop | select | list | length > 0 }}"
            then:
              - delay:
                  minutes: "{{ bypass_auto_off_delay_minutes }}"
              - repeat:
                  for_each: "{{ bypass_switches_stop }}"
                  sequence:
                    - condition: template
                      value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                    - service: homeassistant.turn_off
                      target:
                        entity_id: "{{ repeat.item }}"

      # ============================================================================
      # NIGHT MODE: Transition triggers - Only when lights are already on
      # ============================================================================
      - conditions:
          - condition: trigger
            id:
              - night_mode_time_start
              - night_mode_time_end
              - night_mode_entity_change
          - "{{ is_any_light_on }}"
          - "{{ use_night_lights == 'night_lights_enabled' }}"
          - "{{ not override_mode_active }}"
          - "{{ not any_bypass_active }}"
        sequence:
          # Add crossover delay if exiting night mode and delay is enabled
          - if:
              - "{{ not night_lights_active }}"  # Exiting night mode to normal lights
              - "{{ 'use_crossover_delay' in night_light_control_options }}"
              - "{{ night_light_crossover_delay_seconds > 0 }}"
            then:
              - delay:
                  seconds: "{{ night_light_crossover_delay_seconds }}"
          
          - choose:
              # ======================================================================
              # ENTERING NIGHT MODE: night_lights_active = true
              # ======================================================================
              - conditions:
                  - "{{ night_lights_active and allows_turn_on }}"
                sequence:
                  - choose:
                      # Use crossover adjust: turn off main lights before turning on night lights
                      - conditions:
                          - "{{ 'use_crossover_adjust' in night_light_control_options }}"
                        sequence:
                          # Turn off main lights first if using devices
                          - if:
                              - "{{ (light_control_type_var == 'devices' or light_control_type_var == 'both') and has_light_entity }}"
                            then:
                              - delay:
                                  milliseconds: 500
                              - service: homeassistant.turn_off
                                target: !input light_switch
                                data: "{{ light_off_data }}"
                          # Turn off main scenes if using scenes
                          - if:
                              - "{{ (light_control_type_var == 'scenes' or light_control_type_var == 'both') and has_off_scene }}"
                            then:
                              - delay:
                                  milliseconds: 500
                              - repeat:
                                  for_each: !input off_scene
                                  sequence:
                                    - condition: template
                                      value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                                    - service: homeassistant.turn_on
                                      target:
                                        entity_id: "{{ repeat.item }}"
                          # Reset main scene helper
                          - if:
                              - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                              - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                            then:
                              - service: input_boolean.turn_off
                                target:
                                  entity_id: "{{ boolean_scenes_scripts_entity }}"
                          # Now turn on night lights
                          - if:
                              - "{{ night_lights_target is not none and night_lights_target != {} and night_lights_target.entity_id is defined and night_lights_target.entity_id | select | list | length > 0 }}"
                            then:
                              - variables:
                                  current_night_light_data: >-
                                    {% set data = {} %}
                                    {% if 'use_brightness' in night_light_control_options %}
                                      {% set data = dict(data, brightness_pct=night_light_brightness_pct) %}
                                    {% endif %}
                                    {% if 'use_transition' in night_light_control_options %}
                                      {% set data = dict(data, transition=night_light_transition_on_time) %}
                                    {% endif %}
                                    {% if 'use_effect' in night_light_control_options and night_light_effect not in [none, ''] %}
                                      {% set data = dict(data, effect=night_light_effect) %}
                                    {% endif %}
                                    {% if night_light_color_control == 'use_color_temperature' %}
                                      {% set data = dict(data, kelvin=night_light_color_temp) %}
                                    {% elif night_light_color_control == 'use_rgb_color' %}
                                      {% set data = dict(data, rgb_color=night_light_rgb) %}
                                    {% elif night_light_color_control == 'use_rgbw_color' %}
                                      {% set data = dict(data, rgbw_color=night_light_rgbw) %}
                                    {% elif night_light_color_control == 'use_rgbww_color' %}
                                      {% set data = dict(data, rgbww_color=night_light_rgbww) %}
                                    {% endif %}
                                    {{ data }}
                              
                              - service: homeassistant.turn_on
                                target: !input night_lights
                                data: "{{ current_night_light_data }}"
                    default:
                      # Original behavior: just turn on night lights (may leave both on if different lights)
                      - if:
                          - "{{ night_lights_target is not none and night_lights_target != {} and night_lights_target.entity_id is defined and night_lights_target.entity_id | select | list | length > 0 }}"
                        then:
                          - variables:
                              current_night_light_data: >-
                                {% set data = {} %}
                                {% if 'use_brightness' in night_light_control_options %}
                                  {% set data = dict(data, brightness_pct=night_light_brightness_pct) %}
                                {% endif %}
                                {% if 'use_transition' in night_light_control_options %}
                                  {% set data = dict(data, transition=night_light_transition_on_time) %}
                                {% endif %}
                                {% if 'use_effect' in night_light_control_options and night_light_effect not in [none, ''] %}
                                  {% set data = dict(data, effect=night_light_effect) %}
                                {% endif %}
                                {% if night_light_color_control == 'use_color_temperature' %}
                                  {% set data = dict(data, kelvin=night_light_color_temp) %}
                                {% elif night_light_color_control == 'use_rgb_color' %}
                                  {% set data = dict(data, rgb_color=night_light_rgb) %}
                                {% elif night_light_color_control == 'use_rgbw_color' %}
                                  {% set data = dict(data, rgbw_color=night_light_rgbw) %}
                                {% elif night_light_color_control == 'use_rgbww_color' %}
                                  {% set data = dict(data, rgbww_color=night_light_rgbww) %}
                                {% endif %}
                                {{ data }}
                          
                          - service: homeassistant.turn_on
                            target: !input night_lights
                            data: "{{ current_night_light_data }}"
            default:
              # ======================================================================
              # EXITING NIGHT MODE: night_lights_active = false
              # ======================================================================
              - if:
                  - "{{ allows_turn_on }}"
                then:
                  - choose:
                      # Use crossover adjust: turn off night lights before turning on main lights
                      - conditions:
                          - "{{ 'use_crossover_adjust' in night_light_control_options }}"
                        sequence:
                          # Turn off night lights first
                          - if:
                              - "{{ night_lights_target is not none and night_lights_target != {} and night_lights_target.entity_id is defined and night_lights_target.entity_id | select | list | length > 0 }}"
                            then:
                              - delay:
                                  milliseconds: 500
                              - service: homeassistant.turn_off
                                target: !input night_lights
                                data: "{{ night_light_off_data }}"
                          # Reset night scene helper
                          - if:
                              - "{{ night_boolean_scenes_scripts_entity is not none and night_boolean_scenes_scripts_entity != '' }}"
                              - "{{ states(night_boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                            then:
                              - service: input_boolean.turn_off
                                target:
                                  entity_id: "{{ night_boolean_scenes_scripts_entity }}"
                          # Now turn on main lights
                          - if:
                              - "{{ (light_control_type_var == 'devices' or light_control_type_var == 'both') and has_light_entity }}"
                            then:
                              - variables:
                                  current_dynamic_brightness: >-
                                    {% set clamp = namespace(value=0) %}
                                    {% if not use_dynamic_lighting_feature or brightness_mode_setting == 'fixed' %}
                                      {% set clamp.value = light_brightness_pct %}
                                    {% elif brightness_mode_setting in ['sun_elevation', 'sun_elevation_inverted'] %}
                                      {% set sun_elev = state_attr('sun.sun', 'elevation') | float(0) %}
                                      {% set min_elev = al_sunset_elevation_val | float(-6) %}
                                      {% set max_elev = al_noon_elevation_val | float(60) %}
                                      {% set min_bright = al_min_brightness_val | float(20) %}
                                      {% set max_bright = al_max_brightness_val | float(100) %}
                                      {% if brightness_mode_setting == 'sun_elevation' %}
                                        {% if sun_elev <= min_elev %}
                                          {% set clamp.value = min_bright %}
                                        {% elif sun_elev >= max_elev %}
                                          {% set clamp.value = max_bright %}
                                        {% else %}
                                          {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                                          {% set clamp.value = min_bright + (ratio * (max_bright - min_bright)) %}
                                        {% endif %}
                                      {% else %}
                                        {% if sun_elev <= min_elev %}
                                          {% set clamp.value = max_bright %}
                                        {% elif sun_elev >= max_elev %}
                                          {% set clamp.value = min_bright %}
                                        {% else %}
                                          {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                                          {% set clamp.value = max_bright - (ratio * (max_bright - min_bright)) %}
                                        {% endif %}
                                      {% endif %}
                                    {% elif brightness_mode_setting == 'time_based' %}
                                      {% set current_time = now().strftime('%H:%M:%S') %}
                                      {% if current_time >= late_night_time_val or current_time < morning_time_val %}
                                        {% set clamp.value = late_night_brightness_val %}
                                      {% elif current_time >= morning_time_val and current_time < day_time_val %}
                                        {% set clamp.value = morning_brightness_val %}
                                      {% elif current_time >= day_time_val and current_time < evening_time_val %}
                                        {% set clamp.value = day_brightness_val %}
                                      {% else %}
                                        {% set clamp.value = evening_brightness_val %}
                                      {% endif %}
                                    {% elif brightness_mode_setting in ['lux', 'lux_inverted'] %}
                                      {% if not use_illuminance_sensor or illuminance_entity is none or illuminance_entity == '' %}
                                        {% set clamp.value = light_brightness_pct %}
                                      {% else %}
                                        {% set lux_state = states(illuminance_entity) %}
                                        {% if lux_state in ['unknown', 'unavailable', 'none'] %}
                                          {% set clamp.value = light_brightness_pct %}
                                        {% else %}
                                          {% set current_lux = lux_state | float(0) %}
                                          {% set min_lux = lux_for_min_brightness_val | float(50) %}
                                          {% set max_lux = lux_for_max_brightness_val | float(300) %}
                                          {% set min_bright = lux_min_brightness_val | float(10) %}
                                          {% set max_bright = lux_max_brightness_val | float(100) %}
                                          {% if brightness_mode_setting == 'lux' %}
                                            {% if current_lux <= min_lux %}
                                              {% set clamp.value = min_bright %}
                                            {% elif current_lux >= max_lux %}
                                              {% set clamp.value = max_bright %}
                                            {% else %}
                                              {% set ratio = (current_lux - min_lux) / (max_lux - min_lux) %}
                                              {% set clamp.value = min_bright + (ratio * (max_bright - min_bright)) %}
                                            {% endif %}
                                          {% else %}
                                            {% if current_lux <= min_lux %}
                                              {% set clamp.value = max_bright %}
                                            {% elif current_lux >= max_lux %}
                                              {% set clamp.value = min_bright %}
                                            {% else %}
                                              {% set ratio = (current_lux - min_lux) / (max_lux - min_lux) %}
                                              {% set clamp.value = max_bright - (ratio * (max_bright - min_bright)) %}
                                            {% endif %}
                                          {% endif %}
                                        {% endif %}
                                      {% endif %}
                                    {% else %}
                                      {% set clamp.value = light_brightness_pct %}
                                    {% endif %}
                                    {{ ([1, clamp.value | int, 100] | sort)[1] }}
                                  
                                  current_dynamic_color_temp: >-
                                    {% set clamp = namespace(value=0) %}
                                    {% if not use_dynamic_lighting_feature or color_temp_mode_setting == 'fixed' %}
                                      {% set clamp.value = light_color_temp %}
                                    {% elif color_temp_mode_setting == 'sun_elevation' %}
                                      {% set sun_elev = state_attr('sun.sun', 'elevation') | float(0) %}
                                      {% set min_elev = al_sunset_elevation_val | float(-6) %}
                                      {% set max_elev = al_noon_elevation_val | float(60) %}
                                      {% set min_kelvin = al_min_kelvin_val | float(2700) %}
                                      {% set max_kelvin = al_max_kelvin_val | float(5000) %}
                                      {% if sun_elev <= min_elev %}
                                        {% set clamp.value = min_kelvin %}
                                      {% elif sun_elev >= max_elev %}
                                        {% set clamp.value = max_kelvin %}
                                      {% else %}
                                        {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                                        {% set clamp.value = min_kelvin + (ratio * (max_kelvin - min_kelvin)) %}
                                      {% endif %}
                                    {% elif color_temp_mode_setting == 'time_based' %}
                                      {% set current_time = now().strftime('%H:%M:%S') %}
                                      {% if current_time >= late_night_time_val or current_time < morning_time_val %}
                                        {% set clamp.value = late_night_kelvin_val %}
                                      {% elif current_time >= morning_time_val and current_time < day_time_val %}
                                        {% set clamp.value = morning_kelvin_val %}
                                      {% elif current_time >= day_time_val and current_time < evening_time_val %}
                                        {% set clamp.value = day_kelvin_val %}
                                      {% else %}
                                        {% set clamp.value = evening_kelvin_val %}
                                      {% endif %}
                                    {% else %}
                                      {% set clamp.value = light_color_temp %}
                                    {% endif %}
                                    {{ ([2000, clamp.value | int, 8000] | sort)[1] }}
                                  
                                  current_light_data: >-
                                    {% set data = {} %}
                                    {% if 'use_brightness' in light_control_options %}
                                      {% set data = dict(data, brightness_pct=current_dynamic_brightness) %}
                                    {% endif %}
                                    {% if 'use_transition' in light_control_options %}
                                      {% set data = dict(data, transition=light_transition_on_time) %}
                                    {% endif %}
                                    {% if 'use_effect' in light_control_options and light_effect not in [none, ''] %}
                                      {% set data = dict(data, effect=light_effect) %}
                                    {% endif %}
                                    {% if light_color_control == 'use_color_temperature' %}
                                      {% set data = dict(data, kelvin=current_dynamic_color_temp) %}
                                    {% elif light_color_control == 'use_rgb_color' %}
                                      {% set data = dict(data, rgb_color=light_rgb) %}
                                    {% elif light_color_control == 'use_rgbw_color' %}
                                      {% set data = dict(data, rgbw_color=light_rgbw) %}
                                    {% elif light_color_control == 'use_rgbww_color' %}
                                      {% set data = dict(data, rgbww_color=light_rgbww) %}
                                    {% endif %}
                                    {{ data }}
                              
                              - service: homeassistant.turn_on
                                target: !input light_switch
                                data: "{{ current_light_data }}"
                          - if:
                              - "{{ (light_control_type_var == 'scenes' or light_control_type_var == 'both') and has_scene_entity }}"
                            then:
                              - condition: template
                                value_template: "{{ states(on_scene_entity) not in ['unavailable', 'unknown'] }}"
                              - service: homeassistant.turn_on
                                target:
                                  entity_id: "{{ on_scene_entity }}"
                    default:
                      # Original behavior: just turn on main lights (may leave both on if different lights)
                      - if:
                          - "{{ (light_control_type_var == 'devices' or light_control_type_var == 'both') and has_light_entity }}"
                        then:
                          - variables:
                              current_dynamic_brightness: >-
                                {% set clamp = namespace(value=0) %}
                                {% if not use_dynamic_lighting_feature or brightness_mode_setting == 'fixed' %}
                                  {% set clamp.value = light_brightness_pct %}
                                {% elif brightness_mode_setting in ['sun_elevation', 'sun_elevation_inverted'] %}
                                  {% set sun_elev = state_attr('sun.sun', 'elevation') | float(0) %}
                                  {% set min_elev = al_sunset_elevation_val | float(-6) %}
                                  {% set max_elev = al_noon_elevation_val | float(60) %}
                                  {% set min_bright = al_min_brightness_val | float(20) %}
                                  {% set max_bright = al_max_brightness_val | float(100) %}
                                  {% if brightness_mode_setting == 'sun_elevation' %}
                                    {% if sun_elev <= min_elev %}
                                      {% set clamp.value = min_bright %}
                                    {% elif sun_elev >= max_elev %}
                                      {% set clamp.value = max_bright %}
                                    {% else %}
                                      {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                                      {% set clamp.value = min_bright + (ratio * (max_bright - min_bright)) %}
                                    {% endif %}
                                  {% else %}
                                    {% if sun_elev <= min_elev %}
                                      {% set clamp.value = max_bright %}
                                    {% elif sun_elev >= max_elev %}
                                      {% set clamp.value = min_bright %}
                                    {% else %}
                                      {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                                      {% set clamp.value = max_bright - (ratio * (max_bright - min_bright)) %}
                                    {% endif %}
                                  {% endif %}
                                {% elif brightness_mode_setting == 'time_based' %}
                                  {% set current_time = now().strftime('%H:%M:%S') %}
                                  {% if current_time >= late_night_time_val or current_time < morning_time_val %}
                                    {% set clamp.value = late_night_brightness_val %}
                                  {% elif current_time >= morning_time_val and current_time < day_time_val %}
                                    {% set clamp.value = morning_brightness_val %}
                                  {% elif current_time >= day_time_val and current_time < evening_time_val %}
                                    {% set clamp.value = day_brightness_val %}
                                  {% else %}
                                    {% set clamp.value = evening_brightness_val %}
                                  {% endif %}
                                {% elif brightness_mode_setting in ['lux', 'lux_inverted'] %}
                                  {% if not use_illuminance_sensor or illuminance_entity is none or illuminance_entity == '' %}
                                    {% set clamp.value = light_brightness_pct %}
                                  {% else %}
                                    {% set lux_state = states(illuminance_entity) %}
                                    {% if lux_state in ['unknown', 'unavailable', 'none'] %}
                                      {% set clamp.value = light_brightness_pct %}
                                    {% else %}
                                      {% set current_lux = lux_state | float(0) %}
                                      {% set min_lux = lux_for_min_brightness_val | float(50) %}
                                      {% set max_lux = lux_for_max_brightness_val | float(300) %}
                                      {% set min_bright = lux_min_brightness_val | float(10) %}
                                      {% set max_bright = lux_max_brightness_val | float(100) %}
                                      {% if brightness_mode_setting == 'lux' %}
                                        {% if current_lux <= min_lux %}
                                          {% set clamp.value = min_bright %}
                                        {% elif current_lux >= max_lux %}
                                          {% set clamp.value = max_bright %}
                                        {% else %}
                                          {% set ratio = (current_lux - min_lux) / (max_lux - min_lux) %}
                                          {% set clamp.value = min_bright + (ratio * (max_bright - min_bright)) %}
                                        {% endif %}
                                      {% else %}
                                        {% if current_lux <= min_lux %}
                                          {% set clamp.value = max_bright %}
                                        {% elif current_lux >= max_lux %}
                                          {% set clamp.value = min_bright %}
                                        {% else %}
                                          {% set ratio = (current_lux - min_lux) / (max_lux - min_lux) %}
                                          {% set clamp.value = max_bright - (ratio * (max_bright - min_bright)) %}
                                        {% endif %}
                                      {% endif %}
                                    {% endif %}
                                  {% endif %}
                                {% else %}
                                  {% set clamp.value = light_brightness_pct %}
                                {% endif %}
                                {{ ([1, clamp.value | int, 100] | sort)[1] }}
                              
                              current_dynamic_color_temp: >-
                                {% set clamp = namespace(value=0) %}
                                {% if not use_dynamic_lighting_feature or color_temp_mode_setting == 'fixed' %}
                                  {% set clamp.value = light_color_temp %}
                                {% elif color_temp_mode_setting == 'sun_elevation' %}
                                  {% set sun_elev = state_attr('sun.sun', 'elevation') | float(0) %}
                                  {% set min_elev = al_sunset_elevation_val | float(-6) %}
                                  {% set max_elev = al_noon_elevation_val | float(60) %}
                                  {% set min_kelvin = al_min_kelvin_val | float(2700) %}
                                  {% set max_kelvin = al_max_kelvin_val | float(5000) %}
                                  {% if sun_elev <= min_elev %}
                                    {% set clamp.value = min_kelvin %}
                                  {% elif sun_elev >= max_elev %}
                                    {% set clamp.value = max_kelvin %}
                                  {% else %}
                                    {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                                    {% set clamp.value = min_kelvin + (ratio * (max_kelvin - min_kelvin)) %}
                                  {% endif %}
                                {% elif color_temp_mode_setting == 'time_based' %}
                                  {% set current_time = now().strftime('%H:%M:%S') %}
                                  {% if current_time >= late_night_time_val or current_time < morning_time_val %}
                                    {% set clamp.value = late_night_kelvin_val %}
                                  {% elif current_time >= morning_time_val and current_time < day_time_val %}
                                    {% set clamp.value = morning_kelvin_val %}
                                  {% elif current_time >= day_time_val and current_time < evening_time_val %}
                                    {% set clamp.value = day_kelvin_val %}
                                  {% else %}
                                    {% set clamp.value = evening_kelvin_val %}
                                  {% endif %}
                                {% else %}
                                  {% set clamp.value = light_color_temp %}
                                {% endif %}
                                {{ ([2000, clamp.value | int, 8000] | sort)[1] }}
                              
                              current_light_data: >-
                                {% set data = {} %}
                                {% if 'use_brightness' in light_control_options %}
                                  {% set data = dict(data, brightness_pct=current_dynamic_brightness) %}
                                {% endif %}
                                {% if 'use_transition' in light_control_options %}
                                  {% set data = dict(data, transition=light_transition_on_time) %}
                                {% endif %}
                                {% if 'use_effect' in light_control_options and light_effect not in [none, ''] %}
                                  {% set data = dict(data, effect=light_effect) %}
                                {% endif %}
                                {% if light_color_control == 'use_color_temperature' %}
                                  {% set data = dict(data, kelvin=current_dynamic_color_temp) %}
                                {% elif light_color_control == 'use_rgb_color' %}
                                  {% set data = dict(data, rgb_color=light_rgb) %}
                                {% elif light_color_control == 'use_rgbw_color' %}
                                  {% set data = dict(data, rgbw_color=light_rgbw) %}
                                {% elif light_color_control == 'use_rgbww_color' %}
                                  {% set data = dict(data, rgbww_color=light_rgbww) %}
                                {% endif %}
                                {{ data }}
                          
                          - service: homeassistant.turn_on
                            target: !input light_switch
                            data: "{{ current_light_data }}"
                      - if:
                          - "{{ (light_control_type_var == 'scenes' or light_control_type_var == 'both') and has_scene_entity }}"
                        then:
                          - condition: template
                            value_template: "{{ states(on_scene_entity) not in ['unavailable', 'unknown'] }}"
                          - service: homeassistant.turn_on
                            target:
                              entity_id: "{{ on_scene_entity }}"

  # ==============================================================================
  # MAIN AUTOMATION LOGIC - Only runs if no bypass, override, or cooldown triggers matched
  # ==============================================================================
  - choose:
      # ============================================================================
      # BRANCH: Occupancy Detection Enabled
      # ============================================================================
      - conditions:
          - "{{ operating_mode == 'occupancy' }}"
          - "{{ not any_bypass_active }}"
          - "{{ not override_mode_active }}"
          - "{{ not in_cooldown }}"
          - "{{ state_control_allows_light }}"
        sequence:
          - choose:
              # ========================================================================
              # TRIGGER: door_open (occupancy mode)
              # ========================================================================
              - conditions:
                  - condition: trigger
                    id: door_open
                sequence:
                  - if:
                      - "{{ should_turn_on_light }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ night_lights_active }}"
                            sequence:
                              - if:
                                  - "{{ allows_turn_on }}"
                                then:
                                  - if:
                                      - "{{ night_lights_target is not none and night_lights_target != {} and night_lights_target.entity_id is defined and night_lights_target.entity_id | select | list | length > 0 }}"
                                    then:
                                      - variables:
                                          current_night_light_data: >-
                                            {% set data = {} %}
                                            {% if 'use_brightness' in night_light_control_options %}
                                              {% set data = dict(data, brightness_pct=night_light_brightness_pct) %}
                                            {% endif %}
                                            {% if 'use_transition' in night_light_control_options %}
                                              {% set data = dict(data, transition=night_light_transition_on_time) %}
                                            {% endif %}
                                            {% if 'use_effect' in night_light_control_options and night_light_effect not in [none, ''] %}
                                              {% set data = dict(data, effect=night_light_effect) %}
                                            {% endif %}
                                            {% if night_light_color_control == 'use_color_temperature' %}
                                              {% set data = dict(data, kelvin=night_light_color_temp) %}
                                            {% elif night_light_color_control == 'use_rgb_color' %}
                                              {% set data = dict(data, rgb_color=night_light_rgb) %}
                                            {% elif night_light_color_control == 'use_rgbw_color' %}
                                              {% set data = dict(data, rgbw_color=night_light_rgbw) %}
                                            {% elif night_light_color_control == 'use_rgbww_color' %}
                                              {% set data = dict(data, rgbww_color=night_light_rgbww) %}
                                            {% endif %}
                                            {{ data }}
                                      
                                      - service: homeassistant.turn_on
                                        target: !input night_lights
                                        data: "{{ current_night_light_data }}"
                                  - if:
                                      - "{{ night_boolean_scenes_scripts_entity is not none and night_boolean_scenes_scripts_entity != '' }}"
                                      - "{{ states(night_boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                    then:
                                      - service: input_boolean.turn_on
                                        target:
                                          entity_id: "{{ night_boolean_scenes_scripts_entity }}"
                        default:
                          - if:
                              - "{{ allows_turn_on }}"
                            then:
                              - if:
                                  - "{{ (light_control_type_var == 'devices' or light_control_type_var == 'both') and has_light_entity }}"
                                then:
                  - variables:
                      current_dynamic_brightness: >-
                        {% set clamp = namespace(value=0) %}
                        {% if not use_dynamic_lighting_feature or brightness_mode_setting == 'fixed' %}
                          {% set clamp.value = light_brightness_pct %}
                        {% elif brightness_mode_setting in ['sun_elevation', 'sun_elevation_inverted'] %}
                          {% set sun_elev = state_attr('sun.sun', 'elevation') | float(0) %}
                          {% set min_elev = al_sunset_elevation_val | float(-6) %}
                          {% set max_elev = al_noon_elevation_val | float(60) %}
                          {% set min_bright = al_min_brightness_val | float(20) %}
                          {% set max_bright = al_max_brightness_val | float(100) %}
                          {% if brightness_mode_setting == 'sun_elevation' %}
                            {% if sun_elev <= min_elev %}
                              {% set clamp.value = min_bright %}
                            {% elif sun_elev >= max_elev %}
                              {% set clamp.value = max_bright %}
                            {% else %}
                              {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                              {% set clamp.value = min_bright + (ratio * (max_bright - min_bright)) %}
                            {% endif %}
                          {% else %}
                            {% if sun_elev <= min_elev %}
                              {% set clamp.value = max_bright %}
                            {% elif sun_elev >= max_elev %}
                              {% set clamp.value = min_bright %}
                            {% else %}
                              {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                              {% set clamp.value = max_bright - (ratio * (max_bright - min_bright)) %}
                            {% endif %}
                          {% endif %}
                        {% elif brightness_mode_setting == 'time_based' %}
                          {% set current_time = now().strftime('%H:%M:%S') %}
                          {% if current_time >= late_night_time_val or current_time < morning_time_val %}
                            {% set clamp.value = late_night_brightness_val %}
                          {% elif current_time >= morning_time_val and current_time < day_time_val %}
                            {% set clamp.value = morning_brightness_val %}
                          {% elif current_time >= day_time_val and current_time < evening_time_val %}
                            {% set clamp.value = day_brightness_val %}
                          {% else %}
                            {% set clamp.value = evening_brightness_val %}
                          {% endif %}
                        {% elif brightness_mode_setting in ['lux', 'lux_inverted'] %}
                          {% if not use_illuminance_sensor or illuminance_entity is none or illuminance_entity == '' %}
                            {% set clamp.value = light_brightness_pct %}
                          {% else %}
                            {% set lux_state = states(illuminance_entity) %}
                            {% if lux_state in ['unknown', 'unavailable', 'none'] %}
                              {% set clamp.value = light_brightness_pct %}
                            {% else %}
                              {% set current_lux = lux_state | float(0) %}
                              {% set min_lux = lux_for_min_brightness_val | float(50) %}
                              {% set max_lux = lux_for_max_brightness_val | float(300) %}
                              {% set min_bright = lux_min_brightness_val | float(10) %}
                              {% set max_bright = lux_max_brightness_val | float(100) %}
                              {% if brightness_mode_setting == 'lux' %}
                                {% if current_lux <= min_lux %}
                                  {% set clamp.value = min_bright %}
                                {% elif current_lux >= max_lux %}
                                  {% set clamp.value = max_bright %}
                                {% else %}
                                  {% set ratio = (current_lux - min_lux) / (max_lux - min_lux) %}
                                  {% set clamp.value = min_bright + (ratio * (max_bright - min_bright)) %}
                                {% endif %}
                              {% else %}
                                {% if current_lux <= min_lux %}
                                  {% set clamp.value = max_bright %}
                                {% elif current_lux >= max_lux %}
                                  {% set clamp.value = min_bright %}
                                {% else %}
                                  {% set ratio = (current_lux - min_lux) / (max_lux - min_lux) %}
                                  {% set clamp.value = max_bright - (ratio * (max_bright - min_bright)) %}
                                {% endif %}
                              {% endif %}
                            {% endif %}
                          {% endif %}
                        {% else %}
                          {% set clamp.value = light_brightness_pct %}
                        {% endif %}
                        {{ ([1, clamp.value | int, 100] | sort)[1] }}
                      
                      current_dynamic_color_temp: >-
                        {% set clamp = namespace(value=0) %}
                        {% if not use_dynamic_lighting_feature or color_temp_mode_setting == 'fixed' %}
                          {% set clamp.value = light_color_temp %}
                        {% elif color_temp_mode_setting == 'sun_elevation' %}
                          {% set sun_elev = state_attr('sun.sun', 'elevation') | float(0) %}
                          {% set min_elev = al_sunset_elevation_val | float(-6) %}
                          {% set max_elev = al_noon_elevation_val | float(60) %}
                          {% set min_kelvin = al_min_kelvin_val | float(2700) %}
                          {% set max_kelvin = al_max_kelvin_val | float(5000) %}
                          {% if sun_elev <= min_elev %}
                            {% set clamp.value = min_kelvin %}
                          {% elif sun_elev >= max_elev %}
                            {% set clamp.value = max_kelvin %}
                          {% else %}
                            {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                            {% set clamp.value = min_kelvin + (ratio * (max_kelvin - min_kelvin)) %}
                          {% endif %}
                        {% elif color_temp_mode_setting == 'time_based' %}
                          {% set current_time = now().strftime('%H:%M:%S') %}
                          {% if current_time >= late_night_time_val or current_time < morning_time_val %}
                            {% set clamp.value = late_night_kelvin_val %}
                          {% elif current_time >= morning_time_val and current_time < day_time_val %}
                            {% set clamp.value = morning_kelvin_val %}
                          {% elif current_time >= day_time_val and current_time < evening_time_val %}
                            {% set clamp.value = day_kelvin_val %}
                          {% else %}
                            {% set clamp.value = evening_kelvin_val %}
                          {% endif %}
                        {% else %}
                          {% set clamp.value = light_color_temp %}
                        {% endif %}
                        {{ ([2000, clamp.value | int, 8000] | sort)[1] }}
                      
                      current_light_data: >-
                        {% set data = {} %}
                        {% if 'use_brightness' in light_control_options %}
                          {% set data = dict(data, brightness_pct=current_dynamic_brightness) %}
                        {% endif %}
                        {% if 'use_transition' in light_control_options %}
                          {% set data = dict(data, transition=light_transition_on_time) %}
                        {% endif %}
                        {% if 'use_effect' in light_control_options and light_effect not in [none, ''] %}
                          {% set data = dict(data, effect=light_effect) %}
                        {% endif %}
                        {% if light_color_control == 'use_color_temperature' %}
                          {% set data = dict(data, kelvin=current_dynamic_color_temp) %}
                        {% elif light_color_control == 'use_rgb_color' %}
                          {% set data = dict(data, rgb_color=light_rgb) %}
                        {% elif light_control == 'use_rgbw_color' %}
                          {% set data = dict(data, rgbw_color=light_rgbw) %}
                        {% elif light_color_control == 'use_rgbww_color' %}
                          {% set data = dict(data, rgbww_color=light_rgbww) %}
                        {% endif %}
                        {{ data }}
                  

                                  - service: homeassistant.turn_on
                                    target: !input light_switch
                                    data: "{{ current_light_data }}"
                              - if:
                                  - "{{ (light_control_type_var == 'scenes' or light_control_type_var == 'both') and has_scene_entity }}"
                                then:
                                  - condition: template
                                    value_template: "{{ states(on_scene_entity) not in ['unavailable', 'unknown'] }}"
                                  - service: homeassistant.turn_on
                                    target:
                                      entity_id: "{{ on_scene_entity }}"
                                  - if:
                                      - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                                      - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                    then:
                                      - service: input_boolean.turn_on
                                        target:
                                          entity_id: "{{ boolean_scenes_scripts_entity }}"
                  - choose:
                      - conditions:
                          - "{{ occupancy_entity is not none and occupancy_entity != '' }}"
                          - "{{ states(occupancy_entity) not in ['unavailable', 'unknown'] }}"
                          - "{{ is_state(occupancy_entity, 'on') }}"
                        sequence:
                          - if:
                              - "{{ exiting_entity is not none and exiting_entity != '' }}"
                              - "{{ states(exiting_entity) not in ['unavailable', 'unknown'] }}"
                            then:
                              - service: input_boolean.turn_on
                                target:
                                  entity_id: "{{ exiting_entity }}"
                          # Check still mode before turning off
                          # v5.4.0: Real-time evaluation
                          - if:
                              - condition: template
                                value_template: >-
                                  {% set all_motion_off = operating_mode != 'occupancy' or motion_sensor_entity is none or motion_sensor_entity | length == 0 or expand(motion_sensor_entity) | selectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length == expand(motion_sensor_entity) | list | length %}
                                  {{ all_motion_off and not presence_detection_active }}
                            then:
                              - choose:
                                  - conditions:
                                      - "{{ night_lights_active and has_night_lights }}"
                                    sequence:
                                      # --- START: NIGHT MODE BUG FIX v5.0.8 ---
                                      # Turn off main lights if they exist
                                      - if:
                                          - "{{ has_light_entity }}"
                                        then:
                                          - delay:
                                              milliseconds: 500
                                          - service: homeassistant.turn_off
                                            target: !input light_switch
                                            data: "{{ light_off_data }}"
                                      # Reset main scene helper
                                      - if:
                                          - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                                          - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                        then:
                                          - service: input_boolean.turn_off
                                            target:
                                              entity_id: "{{ boolean_scenes_scripts_entity }}"
                                      # --- END: NIGHT MODE BUG FIX v5.0.8 ---
                                      # Now turn off night lights
                                      - if:
                                          - "{{ has_night_lights }}"
                                        then:
                                          - delay:
                                              milliseconds: 500
                                          - service: homeassistant.turn_off
                                            target: !input night_lights
                                            data: "{{ night_light_off_data }}"
                                      - if:
                                          - "{{ has_off_scene }}"
                                        then:
                                          - delay:
                                              milliseconds: 500
                                          - repeat:
                                              for_each: !input off_scene
                                              sequence:
                                                - condition: template
                                                  value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                                                - service: homeassistant.turn_on
                                                  target:
                                                    entity_id: "{{ repeat.item }}"
                                      - if:
                                          - "{{ night_boolean_scenes_scripts_entity is not none and night_boolean_scenes_scripts_entity != '' }}"
                                          - "{{ states(night_boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                        then:
                                          - service: input_boolean.turn_off
                                            target:
                                              entity_id: "{{ night_boolean_scenes_scripts_entity }}"
                                default:
                                  - if:
                                      - "{{ has_light_entity }}"
                                    then:
                                      - delay:
                                          milliseconds: 500
                                      - service: homeassistant.turn_off
                                        target: !input light_switch
                                        data: "{{ light_off_data }}"
                                  - if:
                                      - "{{ has_off_scene }}"
                                    then:
                                      - delay:
                                          milliseconds: 500
                                      - repeat:
                                          for_each: !input off_scene
                                          sequence:
                                            - condition: template
                                              value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                                            - service: homeassistant.turn_on
                                              target:
                                                entity_id: "{{ repeat.item }}"
                                  - if:
                                      - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                                      - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                    then:
                                      - service: input_boolean.turn_off
                                        target:
                                          entity_id: "{{ boolean_scenes_scripts_entity }}"
                              - if:
                                  - "{{ has_turn_off_only_devices }}"
                                then:
                                  - service: homeassistant.turn_off
                                    target: !input turn_off_only_entities
                              - if:
                                  - "{{ use_manual_control_feature and manual_control_entity is not none and manual_control_entity != '' }}"
                                  - "{{ states(manual_control_entity) not in ['unavailable', 'unknown'] }}"
                                then:
                                  - service: input_boolean.turn_off
                                    target:
                                      entity_id: "{{ manual_control_entity }}"
                              - if:
                                  - "{{ occupancy_entity is not none and occupancy_entity != '' }}"
                                  - "{{ states(occupancy_entity) not in ['unavailable', 'unknown'] }}"
                                then:
                                  - service: input_boolean.turn_off
                                    target:
                                      entity_id: "{{ occupancy_entity }}"
                              - if:
                                  - "{{ exiting_entity is not none and exiting_entity != '' }}"
                                  - "{{ states(exiting_entity) not in ['unavailable', 'unknown'] }}"
                                then:
                                  - service: input_boolean.turn_off
                                    target:
                                      entity_id: "{{ exiting_entity }}"
                      - conditions:
                          - condition: or
                            conditions:
                              - "{{ occupancy_entity is none or occupancy_entity == '' }}"
                              - "{{ states(occupancy_entity) in ['unavailable', 'unknown'] }}"
                              - "{{ is_state(occupancy_entity, 'off') }}"
                        sequence:
                          - if:
                              - "{{ entering_entity is not none and entering_entity != '' }}"
                              - "{{ states(entering_entity) not in ['unavailable', 'unknown'] }}"
                            then:
                              - service: input_boolean.turn_on
                                target:
                                  entity_id: "{{ entering_entity }}"
                          - delay:
                              seconds: "{{ entry_delay_seconds }}"
                          # v5.4.0: Real-time evaluation
                          - if:
                              - condition: template
                                value_template: >-
                                  {{ operating_mode != 'occupancy' or motion_sensor_entity is none or motion_sensor_entity | length == 0 or expand(motion_sensor_entity) | selectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length == expand(motion_sensor_entity) | list | length }}
                            then:
                              - choose:
                                  - conditions:
                                      - "{{ night_lights_active and has_night_lights }}"
                                    sequence:
                                      - if:
                                          - "{{ has_night_lights }}"
                                        then:
                                          - delay:
                                              milliseconds: 500
                                          - service: homeassistant.turn_off
                                            target: !input night_lights
                                            data: "{{ night_light_off_data }}"
                                      - if:
                                          - "{{ has_off_scene }}"
                                        then:
                                          - delay:
                                              milliseconds: 500
                                          - repeat:
                                              for_each: !input off_scene
                                              sequence:
                                                - condition: template
                                                  value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                                                - service: homeassistant.turn_on
                                                  target:
                                                    entity_id: "{{ repeat.item }}"
                                      - if:
                                          - "{{ night_boolean_scenes_scripts_entity is not none and night_boolean_scenes_scripts_entity != '' }}"
                                          - "{{ states(night_boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                        then:
                                          - service: input_boolean.turn_off
                                            target:
                                              entity_id: "{{ night_boolean_scenes_scripts_entity }}"
                                default:
                                  - if:
                                      - "{{ has_light_entity }}"
                                    then:
                                      - delay:
                                          milliseconds: 500
                                      - service: homeassistant.turn_off
                                        target: !input light_switch
                                        data: "{{ light_off_data }}"
                                  - if:
                                      - "{{ has_off_scene }}"
                                    then:
                                      - delay:
                                          milliseconds: 500
                                      - repeat:
                                          for_each: !input off_scene
                                          sequence:
                                            - condition: template
                                              value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                                            - service: homeassistant.turn_on
                                              target:
                                                entity_id: "{{ repeat.item }}"
                                  - if:
                                      - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                                      - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                    then:
                                      - service: input_boolean.turn_off
                                        target:
                                          entity_id: "{{ boolean_scenes_scripts_entity }}"
                              - if:
                                  - "{{ has_turn_off_only_devices }}"
                                then:
                                  - service: homeassistant.turn_off
                                    target: !input turn_off_only_entities
                              - if:
                                  - "{{ use_manual_control_feature and manual_control_entity is not none and manual_control_entity != '' }}"
                                  - "{{ states(manual_control_entity) not in ['unavailable', 'unknown'] }}"
                                then:
                                  - service: input_boolean.turn_off
                                    target:
                                      entity_id: "{{ manual_control_entity }}"
                              - if:
                                  - "{{ entering_entity is not none and entering_entity != '' }}"
                                  - "{{ states(entering_entity) not in ['unavailable', 'unknown'] }}"
                                then:
                                  - service: input_boolean.turn_off
                                    target:
                                      entity_id: "{{ entering_entity }}"

              # ========================================================================
              
              # ========================================================================
              # TRIGGER: motion_on (occupancy mode) - FIXED LOGIC
              # ========================================================================
              - conditions:
                  - condition: trigger
                    id: motion_on
                sequence:
                  # If EITHER entering helper is on OR door is open, mark as entered
                  # This handles both: normal sequence (door open -> entering -> motion)
                  # AND edge case (door already open -> motion detected)
                  - if:
                      - condition: or
                        conditions:
                          - "{{ is_state(entering_entity, 'on') }}"
                          - "{{ any_door_open }}"
                    then:
                      # Turn on entered helper
                      - if:
                          - "{{ entered_entity is not none and entered_entity != '' }}"
                          - "{{ states(entered_entity) not in ['unavailable', 'unknown'] }}"
                        then:
                          - service: input_boolean.turn_on
                            target:
                              entity_id: "{{ entered_entity }}"
                      # Turn off entering helper if it was on
                      - if:
                          - "{{ entering_entity is not none and entering_entity != '' }}"
                          - "{{ states(entering_entity) not in ['unavailable', 'unknown'] }}"
                        then:
                          - service: input_boolean.turn_off
                            target:
                              entity_id: "{{ entering_entity }}"
                      # Turn off exiting helper if door is open (re-entry detected)
                      - if:
                          - "{{ any_door_open and exiting_entity is not none and exiting_entity != '' }}"
                          - "{{ states(exiting_entity) not in ['unavailable', 'unknown'] }}"
                        then:
                          - service: input_boolean.turn_off
                            target:
                              entity_id: "{{ exiting_entity }}"
                  
                  # If door is open and should turn on lights, do so
                  - if:
                      - "{{ any_door_open and should_turn_on_light }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ night_lights_active }}"
                            sequence:
                              - if:
                                  - "{{ allows_turn_on }}"
                                then:
                                  - if:
                                      - "{{ night_lights_target is not none and night_lights_target != {} and night_lights_target.entity_id is defined and night_lights_target.entity_id | select | list | length > 0 }}"
                                    then:
                  - variables:
                      current_night_light_data: >-
                        {% set data = {} %}
                        {% if 'use_brightness' in night_light_control_options %}
                          {% set data = dict(data, brightness_pct=night_light_brightness_pct) %}
                        {% endif %}
                        {% if 'use_transition' in night_light_control_options %}
                          {% set data = dict(data, transition=night_light_transition_on_time) %}
                        {% endif %}
                        {% if 'use_effect' in night_light_control_options and night_light_effect not in [none, ''] %}
                          {% set data = dict(data, effect=night_light_effect) %}
                        {% endif %}
                        {% if night_light_color_control == 'use_color_temperature' %}
                          {% set data = dict(data, kelvin=night_light_color_temp) %}
                        {% elif night_light_color_control == 'use_rgb_color' %}
                          {% set data = dict(data, rgb_color=night_light_rgb) %}
                        {% elif night_light_color_control == 'use_rgbw_color' %}
                          {% set data = dict(data, rgbw_color=night_light_rgbw) %}
                        {% elif night_light_color_control == 'use_rgbww_color' %}
                          {% set data = dict(data, rgbww_color=night_light_rgbww) %}
                        {% endif %}
                        {{ data }}
                  

                                      - service: homeassistant.turn_on
                                        target: !input night_lights
                                        data: "{{ current_night_light_data }}"
                                  - if:
                                      - "{{ night_boolean_scenes_scripts_entity is not none and night_boolean_scenes_scripts_entity != '' }}"
                                      - "{{ states(night_boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                    then:
                                      - service: input_boolean.turn_on
                                        target:
                                          entity_id: "{{ night_boolean_scenes_scripts_entity }}"
                        default:
                          - if:
                              - "{{ allows_turn_on }}"
                            then:
                              - if:
                                  - "{{ (light_control_type_var == 'devices' or light_control_type_var == 'both') and has_light_entity }}"
                                then:
                  - variables:
                      current_dynamic_brightness: >-
                        {% set clamp = namespace(value=0) %}
                        {% if not use_dynamic_lighting_feature or brightness_mode_setting == 'fixed' %}
                          {% set clamp.value = light_brightness_pct %}
                        {% elif brightness_mode_setting in ['sun_elevation', 'sun_elevation_inverted'] %}
                          {% set sun_elev = state_attr('sun.sun', 'elevation') | float(0) %}
                          {% set min_elev = al_sunset_elevation_val | float(-6) %}
                          {% set max_elev = al_noon_elevation_val | float(60) %}
                          {% set min_bright = al_min_brightness_val | float(20) %}
                          {% set max_bright = al_max_brightness_val | float(100) %}
                          {% if brightness_mode_setting == 'sun_elevation' %}
                            {% if sun_elev <= min_elev %}
                              {% set clamp.value = min_bright %}
                            {% elif sun_elev >= max_elev %}
                              {% set clamp.value = max_bright %}
                            {% else %}
                              {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                              {% set clamp.value = min_bright + (ratio * (max_bright - min_bright)) %}
                            {% endif %}
                          {% else %}
                            {% if sun_elev <= min_elev %}
                              {% set clamp.value = max_bright %}
                            {% elif sun_elev >= max_elev %}
                              {% set clamp.value = min_bright %}
                            {% else %}
                              {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                              {% set clamp.value = max_bright - (ratio * (max_bright - min_bright)) %}
                            {% endif %}
                          {% endif %}
                        {% elif brightness_mode_setting == 'time_based' %}
                          {% set current_time = now().strftime('%H:%M:%S') %}
                          {% if current_time >= late_night_time_val or current_time < morning_time_val %}
                            {% set clamp.value = late_night_brightness_val %}
                          {% elif current_time >= morning_time_val and current_time < day_time_val %}
                            {% set clamp.value = morning_brightness_val %}
                          {% elif current_time >= day_time_val and current_time < evening_time_val %}
                            {% set clamp.value = day_brightness_val %}
                          {% else %}
                            {% set clamp.value = evening_brightness_val %}
                          {% endif %}
                        {% elif brightness_mode_setting in ['lux', 'lux_inverted'] %}
                          {% if not use_illuminance_sensor or illuminance_entity is none or illuminance_entity == '' %}
                            {% set clamp.value = light_brightness_pct %}
                          {% else %}
                            {% set lux_state = states(illuminance_entity) %}
                            {% if lux_state in ['unknown', 'unavailable', 'none'] %}
                              {% set clamp.value = light_brightness_pct %}
                            {% else %}
                              {% set current_lux = lux_state | float(0) %}
                              {% set min_lux = lux_for_min_brightness_val | float(50) %}
                              {% set max_lux = lux_for_max_brightness_val | float(300) %}
                              {% set min_bright = lux_min_brightness_val | float(10) %}
                              {% set max_bright = lux_max_brightness_val | float(100) %}
                              {% if brightness_mode_setting == 'lux' %}
                                {% if current_lux <= min_lux %}
                                  {% set clamp.value = min_bright %}
                                {% elif current_lux >= max_lux %}
                                  {% set clamp.value = max_bright %}
                                {% else %}
                                  {% set ratio = (current_lux - min_lux) / (max_lux - min_lux) %}
                                  {% set clamp.value = min_bright + (ratio * (max_bright - min_bright)) %}
                                {% endif %}
                              {% else %}
                                {% if current_lux <= min_lux %}
                                  {% set clamp.value = max_bright %}
                                {% elif current_lux >= max_lux %}
                                  {% set clamp.value = min_bright %}
                                {% else %}
                                  {% set ratio = (current_lux - min_lux) / (max_lux - min_lux) %}
                                  {% set clamp.value = max_bright - (ratio * (max_bright - min_bright)) %}
                                {% endif %}
                              {% endif %}
                            {% endif %}
                          {% endif %}
                        {% else %}
                          {% set clamp.value = light_brightness_pct %}
                        {% endif %}
                        {{ ([1, clamp.value | int, 100] | sort)[1] }}
                      
                      current_dynamic_color_temp: >-
                        {% set clamp = namespace(value=0) %}
                        {% if not use_dynamic_lighting_feature or color_temp_mode_setting == 'fixed' %}
                          {% set clamp.value = light_color_temp %}
                        {% elif color_temp_mode_setting == 'sun_elevation' %}
                          {% set sun_elev = state_attr('sun.sun', 'elevation') | float(0) %}
                          {% set min_elev = al_sunset_elevation_val | float(-6) %}
                          {% set max_elev = al_noon_elevation_val | float(60) %}
                          {% set min_kelvin = al_min_kelvin_val | float(2700) %}
                          {% set max_kelvin = al_max_kelvin_val | float(5000) %}
                          {% if sun_elev <= min_elev %}
                            {% set clamp.value = min_kelvin %}
                          {% elif sun_elev >= max_elev %}
                            {% set clamp.value = max_kelvin %}
                          {% else %}
                            {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                            {% set clamp.value = min_kelvin + (ratio * (max_kelvin - min_kelvin)) %}
                          {% endif %}
                        {% elif color_temp_mode_setting == 'time_based' %}
                          {% set current_time = now().strftime('%H:%M:%S') %}
                          {% if current_time >= late_night_time_val or current_time < morning_time_val %}
                            {% set clamp.value = late_night_kelvin_val %}
                          {% elif current_time >= morning_time_val and current_time < day_time_val %}
                            {% set clamp.value = morning_kelvin_val %}
                          {% elif current_time >= day_time_val and current_time < evening_time_val %}
                            {% set clamp.value = day_kelvin_val %}
                          {% else %}
                            {% set clamp.value = evening_kelvin_val %}
                          {% endif %}
                        {% else %}
                          {% set clamp.value = light_color_temp %}
                        {% endif %}
                        {{ ([2000, clamp.value | int, 8000] | sort)[1] }}
                      
                      current_light_data: >-
                        {% set data = {} %}
                        {% if 'use_brightness' in light_control_options %}
                          {% set data = dict(data, brightness_pct=current_dynamic_brightness) %}
                        {% endif %}
                        {% if 'use_transition' in light_control_options %}
                          {% set data = dict(data, transition=light_transition_on_time) %}
                        {% endif %}
                        {% if 'use_effect' in light_control_options and light_effect not in [none, ''] %}
                          {% set data = dict(data, effect=light_effect) %}
                        {% endif %}
                        {% if light_color_control == 'use_color_temperature' %}
                          {% set data = dict(data, kelvin=current_dynamic_color_temp) %}
                        {% elif light_color_control == 'use_rgb_color' %}
                          {% set data = dict(data, rgb_color=light_rgb) %}
                        {% elif light_control == 'use_rgbw_color' %}
                          {% set data = dict(data, rgbw_color=light_rgbw) %}
                        {% elif light_color_control == 'use_rgbww_color' %}
                          {% set data = dict(data, rgbww_color=light_rgbww) %}
                        {% endif %}
                        {{ data }}
                  

                                  - service: homeassistant.turn_on
                                    target: !input light_switch
                                    data: "{{ current_light_data }}"
                              - if:
                                  - "{{ (light_control_type_var == 'scenes' or light_control_type_var == 'both') and has_scene_entity }}"
                                then:
                                  - condition: template
                                    value_template: "{{ states(on_scene_entity) not in ['unavailable', 'unknown'] }}"
                                  - service: homeassistant.turn_on
                                    target:
                                      entity_id: "{{ on_scene_entity }}"
                                  - if:
                                      - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                                      - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                    then:
                                      - service: input_boolean.turn_on
                                        target:
                                          entity_id: "{{ boolean_scenes_scripts_entity }}"

              


              # ========================================================================
              # TRIGGER: door_close (occupancy mode)
              # ========================================================================
              - conditions:
                  - condition: trigger
                    id: door_close
                sequence:
                  # If entered helper is on, mark as occupied
                  - if:
                      - "{{ entered_entity is not none and entered_entity != '' }}"
                      - "{{ states(entered_entity) not in ['unavailable', 'unknown'] }}"
                      - "{{ is_state(entered_entity, 'on') }}"
                    then:
                      - if:
                          - "{{ occupancy_entity is not none and occupancy_entity != '' }}"
                          - "{{ states(occupancy_entity) not in ['unavailable', 'unknown'] }}"
                        then:
                          - service: input_boolean.turn_on
                            target:
                              entity_id: "{{ occupancy_entity }}"
                      - if:
                          - "{{ entered_entity is not none and entered_entity != '' }}"
                          - "{{ states(entered_entity) not in ['unavailable', 'unknown'] }}"
                        then:
                          - service: input_boolean.turn_off
                            target:
                              entity_id: "{{ entered_entity }}"
                      # Turn off exiting helper if it's on (person didn't actually leave)
                      - if:
                          - "{{ exiting_entity is not none and exiting_entity != '' }}"
                          - "{{ states(exiting_entity) not in ['unavailable', 'unknown'] }}"
                        then:
                          - service: input_boolean.turn_off
                            target:
                              entity_id: "{{ exiting_entity }}"
                  
                  # If entering helper is on but no motion, turn off lights
                  # v5.4.0: Real-time evaluation
                  - if:
                      - "{{ entering_entity is not none and entering_entity != '' }}"
                      - "{{ states(entering_entity) not in ['unavailable', 'unknown'] }}"
                      - "{{ is_state(entering_entity, 'on') }}"
                      - condition: template
                        value_template: >-
                          {% set all_motion_off = operating_mode != 'occupancy' or motion_sensor_entity is none or motion_sensor_entity | length == 0 or expand(motion_sensor_entity) | selectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length == expand(motion_sensor_entity) | list | length %}
                          {{ all_motion_off and not presence_detection_active }}
                    then:
                      - delay:
                          seconds: "{{ motion_timeout_seconds }}"
                      # v5.4.0: Real-time evaluation
                      - if:
                          - condition: template
                            value_template: >-
                              {% set all_motion_off = operating_mode != 'occupancy' or motion_sensor_entity is none or motion_sensor_entity | length == 0 or expand(motion_sensor_entity) | selectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length == expand(motion_sensor_entity) | list | length %}
                              {{ all_motion_off and not presence_detection_active }}
                        then:
                          - if:
                              - "{{ allows_turn_off }}"
                            then:
                              - choose:
                                  - conditions:
                                      - "{{ night_lights_active and has_night_lights }}"
                                    sequence:
                                      # --- START: NIGHT MODE BUG FIX v5.0.8 ---
                                      # Turn off main lights if they exist
                                      - if:
                                          - "{{ has_light_entity }}"
                                        then:
                                          - delay:
                                              milliseconds: 500
                                          - service: homeassistant.turn_off
                                            target: !input light_switch
                                            data: "{{ light_off_data }}"
                                      # Activate off-scene if it exists
                                      - if:
                                          - "{{ has_off_scene }}"
                                        then:
                                          - delay:
                                              milliseconds: 500
                                          - repeat:
                                              for_each: !input off_scene
                                              sequence:
                                                - condition: template
                                                  value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                                                - service: homeassistant.turn_on
                                                  target:
                                                    entity_id: "{{ repeat.item }}"
                                      # Reset both scene helpers
                                      - if:
                                          - "{{ night_boolean_scenes_scripts_entity is not none and night_boolean_scenes_scripts_entity != '' }}"
                                          - "{{ states(night_boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                        then:
                                          - service: input_boolean.turn_off
                                            target:
                                              entity_id: "{{ night_boolean_scenes_scripts_entity }}"
                                      - if:
                                          - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                                          - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                        then:
                                          - service: input_boolean.turn_off
                                            target:
                                              entity_id: "{{ boolean_scenes_scripts_entity }}"
                                      # --- END: NIGHT MODE BUG FIX v5.0.8 ---
                                      # Now turn off night lights
                                      - if:
                                          - "{{ has_night_lights }}"
                                        then:
                                          - delay:
                                              milliseconds: 500
                                          - service: homeassistant.turn_off
                                            target: !input night_lights
                                            data: "{{ night_light_off_data }}"
                                default:
                                  - if:
                                      - "{{ has_light_entity }}"
                                    then:
                                      - delay:
                                          milliseconds: 500
                                      - service: homeassistant.turn_off
                                        target: !input light_switch
                                        data: "{{ light_off_data }}"
                              - if:
                                  - "{{ has_turn_off_only_devices }}"
                                then:
                                  - service: homeassistant.turn_off
                                    target: !input turn_off_only_entities
                          - if:
                              - "{{ entering_entity is not none and entering_entity != '' }}"
                              - "{{ states(entering_entity) not in ['unavailable', 'unknown'] }}"
                            then:
                              - service: input_boolean.turn_off
                                target:
                                  entity_id: "{{ entering_entity }}"
                  
                  # If exiting helper is on, finalize exit
                  - if:
                      - "{{ exiting_entity is not none and exiting_entity != '' }}"
                      - "{{ states(exiting_entity) not in ['unavailable', 'unknown'] }}"
                      - "{{ is_state(exiting_entity, 'on') }}"
                    then:
                      # IMMEDIATE still mode check - if someone is still present, skip exit
                      # This prevents lights from turning off while someone is sitting
                      - if:
                          - "{{ not presence_detection_active }}"
                        then:
                          # No immediate presence detected
                          # Wait for presence detection gap timeout
                          # This allows checking if someone remained behind (multi-person room)
                          - delay:
                              seconds: "{{ motion_gap_timeout_seconds }}"
                          
                          # Check if still mode sensors detect remaining presence (after gap)
                          - if:
                              - "{{ not presence_detection_active }}"
                            then:
                              # No presence detected â†’ Complete the exit and turn off lights
                              - if:
                                  - "{{ allows_turn_off }}"
                                then:
                                  - choose:
                                      - conditions:
                                          - "{{ night_lights_active and has_night_lights }}"
                                        sequence:
                                          # --- START: NIGHT MODE BUG FIX v5.0.8 ---
                                          # Turn off main lights if they exist
                                          - if:
                                              - "{{ has_light_entity }}"
                                            then:
                                              - delay:
                                                  milliseconds: 500
                                              - service: homeassistant.turn_off
                                                target: !input light_switch
                                                data: "{{ light_off_data }}"
                                          # Activate off-scene if it exists
                                          - if:
                                              - "{{ has_off_scene }}"
                                            then:
                                              - delay:
                                                  milliseconds: 500
                                              - repeat:
                                                  for_each: !input off_scene
                                                  sequence:
                                                    - condition: template
                                                      value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                                                    - service: homeassistant.turn_on
                                                      target:
                                                        entity_id: "{{ repeat.item }}"
                                          # Reset both scene helpers
                                          - if:
                                              - "{{ night_boolean_scenes_scripts_entity is not none and night_boolean_scenes_scripts_entity != '' }}"
                                              - "{{ states(night_boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                            then:
                                              - service: input_boolean.turn_off
                                                target:
                                                  entity_id: "{{ night_boolean_scenes_scripts_entity }}"
                                          - if:
                                              - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                                              - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                            then:
                                              - service: input_boolean.turn_off
                                                target:
                                                  entity_id: "{{ boolean_scenes_scripts_entity }}"
                                          # --- END: NIGHT MODE BUG FIX v5.0.8 ---
                                          # Now turn off night lights
                                          - if:
                                              - "{{ has_night_lights }}"
                                            then:
                                              - delay:
                                                  milliseconds: 500
                                              - service: homeassistant.turn_off
                                                target: !input night_lights
                                                data: "{{ night_light_off_data }}"
                                    default:
                                      - if:
                                          - "{{ has_light_entity }}"
                                        then:
                                          - delay:
                                              milliseconds: 500
                                          - service: homeassistant.turn_off
                                            target: !input light_switch
                                            data: "{{ light_off_data }}"
                                  - if:
                                      - "{{ has_turn_off_only_devices }}"
                                    then:
                                      - service: homeassistant.turn_off
                                        target: !input turn_off_only_entities
                              # Clear occupancy and exiting helpers
                              - if:
                                  - "{{ occupancy_entity is not none and occupancy_entity != '' }}"
                                  - "{{ states(occupancy_entity) not in ['unavailable', 'unknown'] }}"
                                then:
                                  - service: input_boolean.turn_off
                                    target:
                                      entity_id: "{{ occupancy_entity }}"
                              - if:
                                  - "{{ exiting_entity is not none and exiting_entity != '' }}"
                                  - "{{ states(exiting_entity) not in ['unavailable', 'unknown'] }}"
                                then:
                                  - service: input_boolean.turn_off
                                    target:
                                      entity_id: "{{ exiting_entity }}"
                        else:
                          # Still mode sensors active â†’ Someone remained behind
                          # Just clear exiting helper, keep occupancy/lights ON
                          - if:
                              - "{{ exiting_entity is not none and exiting_entity != '' }}"
                              - "{{ states(exiting_entity) not in ['unavailable', 'unknown'] }}"
                            then:
                              - service: input_boolean.turn_off
                                target:
                                  entity_id: "{{ exiting_entity }}"

              # ========================================================================
              # TRIGGER: motion_off (occupancy mode) - FIXED LOGIC
              # ========================================================================
              - conditions:
                  - condition: trigger
                    id: motion_off
                sequence:
                  # Use choose block to handle entered state properly (v4.2.1 logic)
                  - choose:
                      # If entered state is active, start gap timeout
                      - conditions:
                          - "{{ entered_entity is not none and entered_entity != '' }}"
                          - "{{ is_state(entered_entity, 'on') }}"
                        sequence:
                          - delay:
                              seconds: "{{ motion_gap_timeout_seconds }}"
                          # v5.4.0: Real-time evaluation
                          - if:
                              - condition: template
                                value_template: >-
                                  {% set all_motion_off = operating_mode != 'occupancy' or motion_sensor_entity is none or motion_sensor_entity | length == 0 or expand(motion_sensor_entity) | selectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length == expand(motion_sensor_entity) | list | length %}
                                  {{ all_motion_off and not presence_detection_active }}
                            then:
                              - if:
                                  - "{{ allows_turn_off }}"
                                then:
                                  - choose:
                                      - conditions:
                                          - "{{ night_lights_active and has_night_lights }}"
                                        sequence:
                                          # --- START: NIGHT MODE BUG FIX v5.0.8 ---
                                          # Turn off main lights if they exist
                                          - if:
                                              - "{{ has_light_entity }}"
                                            then:
                                              - delay:
                                                  milliseconds: 500
                                              - service: homeassistant.turn_off
                                                target: !input light_switch
                                                data: "{{ light_off_data }}"
                                          # Activate off-scene if it exists
                                          - if:
                                              - "{{ has_off_scene }}"
                                            then:
                                              - delay:
                                                  milliseconds: 500
                                              - repeat:
                                                  for_each: !input off_scene
                                                  sequence:
                                                    - condition: template
                                                      value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                                                    - service: homeassistant.turn_on
                                                      target:
                                                        entity_id: "{{ repeat.item }}"
                                          # Reset both scene helpers
                                          - if:
                                              - "{{ night_boolean_scenes_scripts_entity is not none and night_boolean_scenes_scripts_entity != '' }}"
                                              - "{{ states(night_boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                            then:
                                              - service: input_boolean.turn_off
                                                target:
                                                  entity_id: "{{ night_boolean_scenes_scripts_entity }}"
                                          - if:
                                              - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                                              - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                            then:
                                              - service: input_boolean.turn_off
                                                target:
                                                  entity_id: "{{ boolean_scenes_scripts_entity }}"
                                          # --- END: NIGHT MODE BUG FIX v5.0.8 ---
                                          # Now turn off night lights
                                          - if:
                                              - "{{ has_night_lights }}"
                                            then:
                                              - delay:
                                                  milliseconds: 500
                                              - service: homeassistant.turn_off
                                                target: !input night_lights
                                                data: "{{ night_light_off_data }}"
                                    default:
                                      - if:
                                          - "{{ has_light_entity }}"
                                        then:
                                          - delay:
                                              milliseconds: 500
                                          - service: homeassistant.turn_off
                                            target: !input light_switch
                                            data: "{{ light_off_data }}"
                                  - if:
                                      - "{{ has_turn_off_only_devices }}"
                                    then:
                                      - service: homeassistant.turn_off
                                        target: !input turn_off_only_entities
                              - if:
                                  - "{{ entered_entity is not none and entered_entity != '' }}"
                                  - "{{ states(entered_entity) not in ['unavailable', 'unknown'] }}"
                                then:
                                  - service: input_boolean.turn_off
                                    target:
                                      entity_id: "{{ entered_entity }}"
                  
                  # If room is occupied, check if exit is in progress - FIXED v5.0.11
                  - if:
                      - "{{ occupancy_entity is not none and occupancy_entity != '' }}"
                      - "{{ states(occupancy_entity) not in ['unavailable', 'unknown'] }}"
                      - "{{ is_state(occupancy_entity, 'on') }}"
                    then:
                      # Check if exit is in progress (door open or exiting_helper active)
                      - choose:
                          # Exit in progress - use short timeout
                          - conditions:
                              - condition: template
                                value_template: >
                                  {{ (exiting_entity is not none and exiting_entity != '' and is_state(exiting_entity, 'on')) or any_door_open }}
                            sequence:
                              - delay:
                                  seconds: "{{ motion_gap_timeout_seconds }}"
                              # v5.4.0: Real-time evaluation
                              - if:
                                  - condition: template
                                    value_template: >-
                                      {% set all_motion_off = operating_mode != 'occupancy' or motion_sensor_entity is none or motion_sensor_entity | length == 0 or expand(motion_sensor_entity) | selectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length == expand(motion_sensor_entity) | list | length %}
                                      {{ all_motion_off and not presence_detection_active }}
                                then:
                                  - if:
                                      - "{{ allows_turn_off }}"
                                    then:
                                      - choose:
                                          - conditions:
                                              - "{{ night_lights_active and has_night_lights }}"
                                            sequence:
                                              # --- START: NIGHT MODE BUG FIX v5.0.8 ---
                                              # Turn off main lights if they exist
                                              - if:
                                                  - "{{ has_light_entity }}"
                                                then:
                                                  - delay:
                                                      milliseconds: 500
                                                  - service: homeassistant.turn_off
                                                    target: !input light_switch
                                                    data: "{{ light_off_data }}"
                                              # Activate off-scene if it exists
                                              - if:
                                                  - "{{ has_off_scene }}"
                                                then:
                                                  - delay:
                                                      milliseconds: 500
                                                  - repeat:
                                                      for_each: !input off_scene
                                                      sequence:
                                                        - condition: template
                                                          value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                                                        - service: homeassistant.turn_on
                                                          target:
                                                            entity_id: "{{ repeat.item }}"
                                              # Reset both scene helpers
                                              - if:
                                                  - "{{ night_boolean_scenes_scripts_entity is not none and night_boolean_scenes_scripts_entity != '' }}"
                                                  - "{{ states(night_boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                                then:
                                                  - service: input_boolean.turn_off
                                                    target:
                                                      entity_id: "{{ night_boolean_scenes_scripts_entity }}"
                                              - if:
                                                  - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                                                  - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                                then:
                                                  - service: input_boolean.turn_off
                                                    target:
                                                      entity_id: "{{ boolean_scenes_scripts_entity }}"
                                              # --- END: NIGHT MODE BUG FIX v5.0.8 ---
                                              # Now turn off night lights
                                              - if:
                                                  - "{{ has_night_lights }}"
                                                then:
                                                  - delay:
                                                      milliseconds: 500
                                                  - service: homeassistant.turn_off
                                                    target: !input night_lights
                                                    data: "{{ night_light_off_data }}"
                                        default:
                                          - if:
                                              - "{{ has_light_entity }}"
                                            then:
                                              - delay:
                                                  milliseconds: 500
                                              - service: homeassistant.turn_off
                                                target: !input light_switch
                                                data: "{{ light_off_data }}"
                                      - if:
                                          - "{{ has_turn_off_only_devices }}"
                                        then:
                                          - service: homeassistant.turn_off
                                            target: !input turn_off_only_entities
                                  # Reset helpers after exit (both occupancy and exiting)
                                  - if:
                                      - "{{ occupancy_entity is not none and occupancy_entity != '' }}"
                                      - "{{ states(occupancy_entity) not in ['unavailable', 'unknown'] }}"
                                    then:
                                      - service: input_boolean.turn_off
                                        target:
                                          entity_id: "{{ occupancy_entity }}"
                                  - if:
                                      - "{{ exiting_entity is not none and exiting_entity != '' }}"
                                      - "{{ states(exiting_entity) not in ['unavailable', 'unknown'] }}"
                                    then:
                                      - service: input_boolean.turn_off
                                        target:
                                          entity_id: "{{ exiting_entity }}"
                                else:
                                  # Still mode sensors active â†’ Someone remained behind
                                  # Just clear exiting helper, keep occupancy/lights ON
                                  - if:
                                      - "{{ exiting_entity is not none and exiting_entity != '' }}"
                                      - "{{ states(exiting_entity) not in ['unavailable', 'unknown'] }}"
                                    then:
                                      - service: input_boolean.turn_off
                                        target:
                                          entity_id: "{{ exiting_entity }}"
                        default:
                          # Door closed - use long timeout
                          - delay:
                              minutes: "{{ max_idle_minutes }}"
                          # v5.4.0: Real-time evaluation
                          - if:
                              - condition: template
                                value_template: >-
                                  {% set all_motion_off = operating_mode != 'occupancy' or motion_sensor_entity is none or motion_sensor_entity | length == 0 or expand(motion_sensor_entity) | selectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length == expand(motion_sensor_entity) | list | length %}
                                  {{ all_motion_off and not presence_detection_active }}
                            then:
                              - if:
                                  - "{{ allows_turn_off }}"
                                then:
                                  - choose:
                                      - conditions:
                                          - "{{ night_lights_active and has_night_lights }}"
                                        sequence:
                                          # --- START: NIGHT MODE BUG FIX v5.0.8 ---
                                          # Turn off main lights if they exist
                                          - if:
                                              - "{{ has_light_entity }}"
                                            then:
                                              - delay:
                                                  milliseconds: 500
                                              - service: homeassistant.turn_off
                                                target: !input light_switch
                                                data: "{{ light_off_data }}"
                                          # Activate off-scene if it exists
                                          - if:
                                              - "{{ has_off_scene }}"
                                            then:
                                              - delay:
                                                  milliseconds: 500
                                              - repeat:
                                                  for_each: !input off_scene
                                                  sequence:
                                                    - condition: template
                                                      value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                                                    - service: homeassistant.turn_on
                                                      target:
                                                        entity_id: "{{ repeat.item }}"
                                          # Reset both scene helpers
                                          - if:
                                              - "{{ night_boolean_scenes_scripts_entity is not none and night_boolean_scenes_scripts_entity != '' }}"
                                              - "{{ states(night_boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                            then:
                                              - service: input_boolean.turn_off
                                                target:
                                                  entity_id: "{{ night_boolean_scenes_scripts_entity }}"
                                          - if:
                                              - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                                              - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                            then:
                                              - service: input_boolean.turn_off
                                                target:
                                                  entity_id: "{{ boolean_scenes_scripts_entity }}"
                                          # --- END: NIGHT MODE BUG FIX v5.0.8 ---
                                          # Now turn off night lights
                                          - if:
                                              - "{{ has_night_lights }}"
                                            then:
                                              - delay:
                                                  milliseconds: 500
                                              - service: homeassistant.turn_off
                                                target: !input night_lights
                                                data: "{{ night_light_off_data }}"
                                    default:
                                      - if:
                                          - "{{ has_light_entity }}"
                                        then:
                                          - delay:
                                              milliseconds: 500
                                          - service: homeassistant.turn_off
                                            target: !input light_switch
                                            data: "{{ light_off_data }}"
                                  - if:
                                      - "{{ has_turn_off_only_devices }}"
                                    then:
                                      - service: homeassistant.turn_off
                                        target: !input turn_off_only_entities
                              # Reset occupancy helper after timeout
                              - if:
                                  - "{{ occupancy_entity is not none and occupancy_entity != '' }}"
                                  - "{{ states(occupancy_entity) not in ['unavailable', 'unknown'] }}"
                                then:
                                  - service: input_boolean.turn_off
                                    target:
                                      entity_id: "{{ occupancy_entity }}"


      # ============================================================================
      # BRANCH: Simple Mode
      # ============================================================================
      - conditions:
          - "{{ operating_mode == 'simple' }}"
          - "{{ not any_bypass_active }}"
          - "{{ not override_mode_active }}"
          # FIX v5.2.7: Removed "not in_cooldown" from here
          # - Cooldown still checked for trigger_sensor via master_controls_ok
          # - New triggers should NOT be blocked by cooldown (checked via master_controls_for_new_triggers)
        sequence:
          - choose:
              # ========================================================================
              # TRIGGER: Any trigger ON (simple mode)
              # ========================================================================
              - conditions:
                  - condition: trigger
                    id: trigger_on
                sequence:
                  - if:
                      - "{{ master_controls_ok and should_turn_on_light }}"
                    then:
                      - choose:
                          - conditions:
                              - "{{ night_lights_active }}"
                            sequence:
                              - if:
                                  - "{{ allows_turn_on }}"
                                then:
                                  - if:
                                      - "{{ use_night_glow == 'night_glow_enabled' and night_glow_target is not none and night_glow_target != {} and night_glow_target.entity_id is defined and night_glow_target.entity_id | select | list | length > 0 }}"
                                    then:
                                      - if:
                                          - "{{ allows_turn_off }}"
                                        then:
                                          - delay:
                                              milliseconds: 500
                                          - service: homeassistant.turn_off
                                            target: !input night_glow_lights
                                            data: "{{ night_glow_off_data }}"
                                  - if:
                                      - "{{ night_lights_target is not none and night_lights_target != {} and night_lights_target.entity_id is defined and night_lights_target.entity_id | select | list | length > 0 }}"
                                    then:
                  - variables:
                      current_night_light_data: >-
                        {% set data = {} %}
                        {% if 'use_brightness' in night_light_control_options %}
                          {% set data = dict(data, brightness_pct=night_light_brightness_pct) %}
                        {% endif %}
                        {% if 'use_transition' in night_light_control_options %}
                          {% set data = dict(data, transition=night_light_transition_on_time) %}
                        {% endif %}
                        {% if 'use_effect' in night_light_control_options and night_light_effect not in [none, ''] %}
                          {% set data = dict(data, effect=night_light_effect) %}
                        {% endif %}
                        {% if night_light_color_control == 'use_color_temperature' %}
                          {% set data = dict(data, kelvin=night_light_color_temp) %}
                        {% elif night_light_color_control == 'use_rgb_color' %}
                          {% set data = dict(data, rgb_color=night_light_rgb) %}
                        {% elif night_light_color_control == 'use_rgbw_color' %}
                          {% set data = dict(data, rgbw_color=night_light_rgbw) %}
                        {% elif night_light_color_control == 'use_rgbww_color' %}
                          {% set data = dict(data, rgbww_color=night_light_rgbww) %}
                        {% endif %}
                        {{ data }}
                  

                                      - service: homeassistant.turn_on
                                        target: !input night_lights
                                        data: "{{ current_night_light_data }}"
                                  - if:
                                      - "{{ night_boolean_scenes_scripts_entity is not none and night_boolean_scenes_scripts_entity != '' }}"
                                      - "{{ states(night_boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                    then:
                                      - service: input_boolean.turn_on
                                        target:
                                          entity_id: "{{ night_boolean_scenes_scripts_entity }}"
                        default:
                          - if:
                              - "{{ allows_turn_on }}"
                            then:
                              - if:
                                  - "{{ (light_control_type_var == 'devices' or light_control_type_var == 'both') and has_light_entity }}"
                                then:
                  - variables:
                      current_dynamic_brightness: >-
                        {% set clamp = namespace(value=0) %}
                        {% if not use_dynamic_lighting_feature or brightness_mode_setting == 'fixed' %}
                          {% set clamp.value = light_brightness_pct %}
                        {% elif brightness_mode_setting in ['sun_elevation', 'sun_elevation_inverted'] %}
                          {% set sun_elev = state_attr('sun.sun', 'elevation') | float(0) %}
                          {% set min_elev = al_sunset_elevation_val | float(-6) %}
                          {% set max_elev = al_noon_elevation_val | float(60) %}
                          {% set min_bright = al_min_brightness_val | float(20) %}
                          {% set max_bright = al_max_brightness_val | float(100) %}
                          {% if brightness_mode_setting == 'sun_elevation' %}
                            {% if sun_elev <= min_elev %}
                              {% set clamp.value = min_bright %}
                            {% elif sun_elev >= max_elev %}
                              {% set clamp.value = max_bright %}
                            {% else %}
                              {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                              {% set clamp.value = min_bright + (ratio * (max_bright - min_bright)) %}
                            {% endif %}
                          {% else %}
                            {% if sun_elev <= min_elev %}
                              {% set clamp.value = max_bright %}
                            {% elif sun_elev >= max_elev %}
                              {% set clamp.value = min_bright %}
                            {% else %}
                              {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                              {% set clamp.value = max_bright - (ratio * (max_bright - min_bright)) %}
                            {% endif %}
                          {% endif %}
                        {% elif brightness_mode_setting == 'time_based' %}
                          {% set current_time = now().strftime('%H:%M:%S') %}
                          {% if current_time >= late_night_time_val or current_time < morning_time_val %}
                            {% set clamp.value = late_night_brightness_val %}
                          {% elif current_time >= morning_time_val and current_time < day_time_val %}
                            {% set clamp.value = morning_brightness_val %}
                          {% elif current_time >= day_time_val and current_time < evening_time_val %}
                            {% set clamp.value = day_brightness_val %}
                          {% else %}
                            {% set clamp.value = evening_brightness_val %}
                          {% endif %}
                        {% elif brightness_mode_setting in ['lux', 'lux_inverted'] %}
                          {% if not use_illuminance_sensor or illuminance_entity is none or illuminance_entity == '' %}
                            {% set clamp.value = light_brightness_pct %}
                          {% else %}
                            {% set lux_state = states(illuminance_entity) %}
                            {% if lux_state in ['unknown', 'unavailable', 'none'] %}
                              {% set clamp.value = light_brightness_pct %}
                            {% else %}
                              {% set current_lux = lux_state | float(0) %}
                              {% set min_lux = lux_for_min_brightness_val | float(50) %}
                              {% set max_lux = lux_for_max_brightness_val | float(300) %}
                              {% set min_bright = lux_min_brightness_val | float(10) %}
                              {% set max_bright = lux_max_brightness_val | float(100) %}
                              {% if brightness_mode_setting == 'lux' %}
                                {% if current_lux <= min_lux %}
                                  {% set clamp.value = min_bright %}
                                {% elif current_lux >= max_lux %}
                                  {% set clamp.value = max_bright %}
                                {% else %}
                                  {% set ratio = (current_lux - min_lux) / (max_lux - min_lux) %}
                                  {% set clamp.value = min_bright + (ratio * (max_bright - min_bright)) %}
                                {% endif %}
                              {% else %}
                                {% if current_lux <= min_lux %}
                                  {% set clamp.value = max_bright %}
                                {% elif current_lux >= max_lux %}
                                  {% set clamp.value = min_bright %}
                                {% else %}
                                  {% set ratio = (current_lux - min_lux) / (max_lux - min_lux) %}
                                  {% set clamp.value = max_bright - (ratio * (max_bright - min_bright)) %}
                                {% endif %}
                              {% endif %}
                            {% endif %}
                          {% endif %}
                        {% else %}
                          {% set clamp.value = light_brightness_pct %}
                        {% endif %}
                        {{ ([1, clamp.value | int, 100] | sort)[1] }}
                      
                      current_dynamic_color_temp: >-
                        {% set clamp = namespace(value=0) %}
                        {% if not use_dynamic_lighting_feature or color_temp_mode_setting == 'fixed' %}
                          {% set clamp.value = light_color_temp %}
                        {% elif color_temp_mode_setting == 'sun_elevation' %}
                          {% set sun_elev = state_attr('sun.sun', 'elevation') | float(0) %}
                          {% set min_elev = al_sunset_elevation_val | float(-6) %}
                          {% set max_elev = al_noon_elevation_val | float(60) %}
                          {% set min_kelvin = al_min_kelvin_val | float(2700) %}
                          {% set max_kelvin = al_max_kelvin_val | float(5000) %}
                          {% if sun_elev <= min_elev %}
                            {% set clamp.value = min_kelvin %}
                          {% elif sun_elev >= max_elev %}
                            {% set clamp.value = max_kelvin %}
                          {% else %}
                            {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                            {% set clamp.value = min_kelvin + (ratio * (max_kelvin - min_kelvin)) %}
                          {% endif %}
                        {% elif color_temp_mode_setting == 'time_based' %}
                          {% set current_time = now().strftime('%H:%M:%S') %}
                          {% if current_time >= late_night_time_val or current_time < morning_time_val %}
                            {% set clamp.value = late_night_kelvin_val %}
                          {% elif current_time >= morning_time_val and current_time < day_time_val %}
                            {% set clamp.value = morning_kelvin_val %}
                          {% elif current_time >= day_time_val and current_time < evening_time_val %}
                            {% set clamp.value = day_kelvin_val %}
                          {% else %}
                            {% set clamp.value = evening_kelvin_val %}
                          {% endif %}
                        {% else %}
                          {% set clamp.value = light_color_temp %}
                        {% endif %}
                        {{ ([2000, clamp.value | int, 8000] | sort)[1] }}
                      
                      current_light_data: >-
                        {% set data = {} %}
                        {% if 'use_brightness' in light_control_options %}
                          {% set data = dict(data, brightness_pct=current_dynamic_brightness) %}
                        {% endif %}
                        {% if 'use_transition' in light_control_options %}
                          {% set data = dict(data, transition=light_transition_on_time) %}
                        {% endif %}
                        {% if 'use_effect' in light_control_options and light_effect not in [none, ''] %}
                          {% set data = dict(data, effect=light_effect) %}
                        {% endif %}
                        {% if light_color_control == 'use_color_temperature' %}
                          {% set data = dict(data, kelvin=current_dynamic_color_temp) %}
                        {% elif light_color_control == 'use_rgb_color' %}
                          {% set data = dict(data, rgb_color=light_rgb) %}
                        {% elif light_control == 'use_rgbw_color' %}
                          {% set data = dict(data, rgbw_color=light_rgbw) %}
                        {% elif light_color_control == 'use_rgbww_color' %}
                          {% set data = dict(data, rgbww_color=light_rgbww) %}
                        {% endif %}
                        {{ data }}
                  

                                  - service: homeassistant.turn_on
                                    target: !input light_switch
                                    data: "{{ current_light_data }}"
                              - if:
                                  - "{{ (light_control_type_var == 'scenes' or light_control_type_var == 'both') and has_scene_entity }}"
                                then:
                                  - condition: template
                                    value_template: "{{ states(on_scene_entity) not in ['unavailable', 'unknown'] }}"
                                  - service: homeassistant.turn_on
                                    target:
                                      entity_id: "{{ on_scene_entity }}"
                                  - if:
                                      - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                                      - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                    then:
                                      - service: input_boolean.turn_on
                                        target:
                                          entity_id: "{{ boolean_scenes_scripts_entity }}"

              # ========================================================================
              # TRIGGER: New Triggers ON (v5.1.0) - Entity/Button/Sun/Ambient/Time
              # ========================================================================
              - conditions:
                  - condition: trigger
                    id:
                      - entity_trigger_on
                      - button_trigger_on
                      - sun_trigger_on
                      - ambient_trigger_on
                      - time_trigger_on
                sequence:
                  # BUG FIX v5.2.7: Check if triggered feature is actually enabled
                  # Without this check, triggers fire even when feature is disabled
                  - if:
                      - condition: template
                        value_template: >-
                          {{
                            (trigger.id == 'entity_trigger_on' and include_entity_on) or
                            (trigger.id == 'button_trigger_on' and include_button_on) or
                            (trigger.id == 'sun_trigger_on' and include_sun_falling and state_attr('sun.sun', 'rising') == false) or
                            (trigger.id == 'ambient_trigger_on' and include_ambient_low) or
                            (trigger.id == 'time_trigger_on' and include_time_on)
                          }}
                    then:
                      # Check master controls (skip environmental conditions AND cooldown) - FIX v5.2.7
                      # New triggers should NOT respect simple mode cooldown
                      - if:
                          - "{{ not master_controls_for_new_triggers }}"
                        then:
                          - stop: "Master controls blocked activation"
                      
                      # Check if lights should turn on
                      - if:
                          - "{{ allows_turn_on }}"
                        then:
                          - choose:
                              - conditions:
                                  - "{{ night_lights_active }}"
                                sequence:
                                  - if:
                                      - "{{ use_night_glow == 'night_glow_enabled' and night_glow_target is not none and night_glow_target != {} and night_glow_target.entity_id is defined and night_glow_target.entity_id | select | list | length > 0 }}"
                                    then:
                                      - if:
                                          - "{{ allows_turn_off }}"
                                        then:
                                          - delay:
                                              milliseconds: 500
                                          - service: homeassistant.turn_off
                                            target: !input night_glow_lights
                                            data: "{{ night_glow_off_data }}"
                                  - if:
                                      - "{{ night_lights_target is not none and night_lights_target != {} and night_lights_target.entity_id is defined and night_lights_target.entity_id | select | list | length > 0 }}"
                                    then:
                  - variables:
                      current_night_light_data: >-
                        {% set data = {} %}
                        {% if 'use_brightness' in night_light_control_options %}
                          {% set data = dict(data, brightness_pct=night_light_brightness_pct) %}
                        {% endif %}
                        {% if 'use_transition' in night_light_control_options %}
                          {% set data = dict(data, transition=night_light_transition_on_time) %}
                        {% endif %}
                        {% if 'use_effect' in night_light_control_options and night_light_effect not in [none, ''] %}
                          {% set data = dict(data, effect=night_light_effect) %}
                        {% endif %}
                        {% if night_light_color_control == 'use_color_temperature' %}
                          {% set data = dict(data, kelvin=night_light_color_temp) %}
                        {% elif night_light_color_control == 'use_rgb_color' %}
                          {% set data = dict(data, rgb_color=night_light_rgb) %}
                        {% elif night_light_color_control == 'use_rgbw_color' %}
                          {% set data = dict(data, rgbw_color=night_light_rgbw) %}
                        {% elif night_light_color_control == 'use_rgbww_color' %}
                          {% set data = dict(data, rgbww_color=night_light_rgbww) %}
                        {% endif %}
                        {{ data }}
                  

                                      - service: homeassistant.turn_on
                                        target: !input night_lights
                                        data: "{{ current_night_light_data }}"
                                  - if:
                                      - "{{ night_boolean_scenes_scripts_entity is not none and night_boolean_scenes_scripts_entity != '' }}"
                                      - "{{ states(night_boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                    then:
                                      - service: input_boolean.turn_on
                                        target:
                                          entity_id: "{{ night_boolean_scenes_scripts_entity }}"
                            default:
                              - if:
                                  - "{{ (light_control_type_var == 'devices' or light_control_type_var == 'both') and has_light_entity }}"
                                then:
                  - variables:
                      current_dynamic_brightness: >-
                        {% set clamp = namespace(value=0) %}
                        {% if not use_dynamic_lighting_feature or brightness_mode_setting == 'fixed' %}
                          {% set clamp.value = light_brightness_pct %}
                        {% elif brightness_mode_setting in ['sun_elevation', 'sun_elevation_inverted'] %}
                          {% set sun_elev = state_attr('sun.sun', 'elevation') | float(0) %}
                          {% set min_elev = al_sunset_elevation_val | float(-6) %}
                          {% set max_elev = al_noon_elevation_val | float(60) %}
                          {% set min_bright = al_min_brightness_val | float(20) %}
                          {% set max_bright = al_max_brightness_val | float(100) %}
                          {% if brightness_mode_setting == 'sun_elevation' %}
                            {% if sun_elev <= min_elev %}
                              {% set clamp.value = min_bright %}
                            {% elif sun_elev >= max_elev %}
                              {% set clamp.value = max_bright %}
                            {% else %}
                              {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                              {% set clamp.value = min_bright + (ratio * (max_bright - min_bright)) %}
                            {% endif %}
                          {% else %}
                            {% if sun_elev <= min_elev %}
                              {% set clamp.value = max_bright %}
                            {% elif sun_elev >= max_elev %}
                              {% set clamp.value = min_bright %}
                            {% else %}
                              {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                              {% set clamp.value = max_bright - (ratio * (max_bright - min_bright)) %}
                            {% endif %}
                          {% endif %}
                        {% elif brightness_mode_setting == 'time_based' %}
                          {% set current_time = now().strftime('%H:%M:%S') %}
                          {% if current_time >= late_night_time_val or current_time < morning_time_val %}
                            {% set clamp.value = late_night_brightness_val %}
                          {% elif current_time >= morning_time_val and current_time < day_time_val %}
                            {% set clamp.value = morning_brightness_val %}
                          {% elif current_time >= day_time_val and current_time < evening_time_val %}
                            {% set clamp.value = day_brightness_val %}
                          {% else %}
                            {% set clamp.value = evening_brightness_val %}
                          {% endif %}
                        {% elif brightness_mode_setting in ['lux', 'lux_inverted'] %}
                          {% if not use_illuminance_sensor or illuminance_entity is none or illuminance_entity == '' %}
                            {% set clamp.value = light_brightness_pct %}
                          {% else %}
                            {% set lux_state = states(illuminance_entity) %}
                            {% if lux_state in ['unknown', 'unavailable', 'none'] %}
                              {% set clamp.value = light_brightness_pct %}
                            {% else %}
                              {% set current_lux = lux_state | float(0) %}
                              {% set min_lux = lux_for_min_brightness_val | float(50) %}
                              {% set max_lux = lux_for_max_brightness_val | float(300) %}
                              {% set min_bright = lux_min_brightness_val | float(10) %}
                              {% set max_bright = lux_max_brightness_val | float(100) %}
                              {% if brightness_mode_setting == 'lux' %}
                                {% if current_lux <= min_lux %}
                                  {% set clamp.value = min_bright %}
                                {% elif current_lux >= max_lux %}
                                  {% set clamp.value = max_bright %}
                                {% else %}
                                  {% set ratio = (current_lux - min_lux) / (max_lux - min_lux) %}
                                  {% set clamp.value = min_bright + (ratio * (max_bright - min_bright)) %}
                                {% endif %}
                              {% else %}
                                {% if current_lux <= min_lux %}
                                  {% set clamp.value = max_bright %}
                                {% elif current_lux >= max_lux %}
                                  {% set clamp.value = min_bright %}
                                {% else %}
                                  {% set ratio = (current_lux - min_lux) / (max_lux - min_lux) %}
                                  {% set clamp.value = max_bright - (ratio * (max_bright - min_bright)) %}
                                {% endif %}
                              {% endif %}
                            {% endif %}
                          {% endif %}
                        {% else %}
                          {% set clamp.value = light_brightness_pct %}
                        {% endif %}
                        {{ ([1, clamp.value | int, 100] | sort)[1] }}
                      
                      current_dynamic_color_temp: >-
                        {% set clamp = namespace(value=0) %}
                        {% if not use_dynamic_lighting_feature or color_temp_mode_setting == 'fixed' %}
                          {% set clamp.value = light_color_temp %}
                        {% elif color_temp_mode_setting == 'sun_elevation' %}
                          {% set sun_elev = state_attr('sun.sun', 'elevation') | float(0) %}
                          {% set min_elev = al_sunset_elevation_val | float(-6) %}
                          {% set max_elev = al_noon_elevation_val | float(60) %}
                          {% set min_kelvin = al_min_kelvin_val | float(2700) %}
                          {% set max_kelvin = al_max_kelvin_val | float(5000) %}
                          {% if sun_elev <= min_elev %}
                            {% set clamp.value = min_kelvin %}
                          {% elif sun_elev >= max_elev %}
                            {% set clamp.value = max_kelvin %}
                          {% else %}
                            {% set ratio = (sun_elev - min_elev) / (max_elev - min_elev) %}
                            {% set clamp.value = min_kelvin + (ratio * (max_kelvin - min_kelvin)) %}
                          {% endif %}
                        {% elif color_temp_mode_setting == 'time_based' %}
                          {% set current_time = now().strftime('%H:%M:%S') %}
                          {% if current_time >= late_night_time_val or current_time < morning_time_val %}
                            {% set clamp.value = late_night_kelvin_val %}
                          {% elif current_time >= morning_time_val and current_time < day_time_val %}
                            {% set clamp.value = morning_kelvin_val %}
                          {% elif current_time >= day_time_val and current_time < evening_time_val %}
                            {% set clamp.value = day_kelvin_val %}
                          {% else %}
                            {% set clamp.value = evening_kelvin_val %}
                          {% endif %}
                        {% else %}
                          {% set clamp.value = light_color_temp %}
                        {% endif %}
                        {{ ([2000, clamp.value | int, 8000] | sort)[1] }}
                      
                      current_light_data: >-
                        {% set data = {} %}
                        {% if 'use_brightness' in light_control_options %}
                          {% set data = dict(data, brightness_pct=current_dynamic_brightness) %}
                        {% endif %}
                        {% if 'use_transition' in light_control_options %}
                          {% set data = dict(data, transition=light_transition_on_time) %}
                        {% endif %}
                        {% if 'use_effect' in light_control_options and light_effect not in [none, ''] %}
                          {% set data = dict(data, effect=light_effect) %}
                        {% endif %}
                        {% if light_color_control == 'use_color_temperature' %}
                          {% set data = dict(data, kelvin=current_dynamic_color_temp) %}
                        {% elif light_color_control == 'use_rgb_color' %}
                          {% set data = dict(data, rgb_color=light_rgb) %}
                        {% elif light_control == 'use_rgbw_color' %}
                          {% set data = dict(data, rgbw_color=light_rgbw) %}
                        {% elif light_color_control == 'use_rgbww_color' %}
                          {% set data = dict(data, rgbww_color=light_rgbww) %}
                        {% endif %}
                        {{ data }}
                  

                                  - service: homeassistant.turn_on
                                    target: !input light_switch
                                    data: "{{ current_light_data }}"
                              - if:
                                  - "{{ (light_control_type_var == 'scenes' or light_control_type_var == 'both') and has_scene_entity }}"
                                then:
                                  - condition: template
                                    value_template: "{{ states(on_scene_entity) not in ['unavailable', 'unknown'] }}"
                                  - service: homeassistant.turn_on
                                    target:
                                      entity_id: "{{ on_scene_entity }}"
                                  - if:
                                      - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                                      - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                    then:
                                      - service: input_boolean.turn_on
                                        target:
                                          entity_id: "{{ boolean_scenes_scripts_entity }}"
                    else:
                      - stop: "Trigger fired but feature not enabled"

              # ========================================================================
              # TRIGGER: Any trigger OFF (simple mode) - ENHANCED v5.0.4
              # ========================================================================
              - conditions:
                  - condition: trigger
                    id: trigger_off
                sequence:
                  # v5.4.0: Real-time evaluation - check actual sensor states, not cached variable
                  - wait_template: >-
                      {% set old_triggers_clear = operating_mode != 'simple' or trigger_sensor_entity is none or trigger_sensor_entity | length == 0 or expand(trigger_sensor_entity) | selectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length == expand(trigger_sensor_entity) | list | length %}
                      {% set entity_on = include_entity_on and entity_input_var != [] and entity_input_var is not none and is_state(entity_input_var, 'on') %}
                      {% set sun_low = include_sun_falling and state_attr('sun.sun', 'elevation')|float(100) < sun_elevation_falling_var %}
                      {% set lux_low = include_ambient_low and ambient_light_sensor_var != [] and ambient_light_sensor_var is not none and states(ambient_light_sensor_var)|float(999) < ambient_light_low_var %}
                      {% set new_triggers_clear = not (entity_on or sun_low or lux_low) %}
                      {{ old_triggers_clear and new_triggers_clear }}
                    timeout:
                      seconds: 5
                    continue_on_timeout: true
                  - delay:
                      minutes: >
                        {% if night_lights_active %}
                          {{ night_time_delay_minutes }}
                        {% else %}
                          {{ time_delay_minutes }}
                        {% endif %}
                  # Check still mode before turning off
                  # v5.4.0: Real-time evaluation
                  - if:
                      - condition: template
                        value_template: >-
                          {% set old_triggers_clear = operating_mode != 'simple' or trigger_sensor_entity is none or trigger_sensor_entity | length == 0 or expand(trigger_sensor_entity) | selectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length == expand(trigger_sensor_entity) | list | length %}
                          {% set entity_on = include_entity_on and entity_input_var != [] and entity_input_var is not none and is_state(entity_input_var, 'on') %}
                          {% set sun_low = include_sun_falling and state_attr('sun.sun', 'elevation')|float(100) < sun_elevation_falling_var %}
                          {% set lux_low = include_ambient_low and ambient_light_sensor_var != [] and ambient_light_sensor_var is not none and states(ambient_light_sensor_var)|float(999) < ambient_light_low_var %}
                          {% set new_triggers_clear = not (entity_on or sun_low or lux_low) %}
                          {% set all_triggers_clear = old_triggers_clear and new_triggers_clear %}
                          {{ all_triggers_clear and not presence_detection_active }}
                    then:
                      - choose:
                          - conditions:
                              - "{{ night_lights_active }}"
                            sequence:
                              - if:
                                  - "{{ allows_turn_off }}"
                                then:
                                  # --- START: NIGHT MODE BUG FIX v5.0.8 ---
                                  # Turn off main lights if they exist
                                  - if:
                                      - "{{ (light_control_type_var == 'devices' or light_control_type_var == 'both') and has_light_entity }}"
                                    then:
                                      - delay:
                                          milliseconds: 500
                                      - service: homeassistant.turn_off
                                        target: !input light_switch
                                        data: "{{ light_off_data }}"
                                  # Activate off-scene if it exists
                                  - if:
                                      - "{{ (light_control_type_var == 'scenes' or light_control_type_var == 'both') and has_off_scene }}"
                                    then:
                                      - delay:
                                          milliseconds: 500
                                      - repeat:
                                          for_each: !input off_scene
                                          sequence:
                                            - condition: template
                                              value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                                            - service: homeassistant.turn_on
                                              target:
                                                entity_id: "{{ repeat.item }}"
                                  # Reset main scene helper
                                  - if:
                                      - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                                      - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                    then:
                                      - service: input_boolean.turn_off
                                        target:
                                          entity_id: "{{ boolean_scenes_scripts_entity }}"
                                  # --- END: NIGHT MODE BUG FIX v5.0.8 ---
                                  # Now turn off night lights
                                  - if:
                                      - "{{ night_lights_target is not none and night_lights_target != {} and night_lights_target.entity_id is defined and night_lights_target.entity_id | select | list | length > 0 }}"
                                    then:
                                      - delay:
                                          milliseconds: 500
                                      - service: homeassistant.turn_off
                                        target: !input night_lights
                                        data: "{{ night_light_off_data }}"
                                  - if:
                                      - "{{ night_boolean_scenes_scripts_entity is not none and night_boolean_scenes_scripts_entity != '' }}"
                                      - "{{ states(night_boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                    then:
                                      - service: input_boolean.turn_off
                                        target:
                                          entity_id: "{{ night_boolean_scenes_scripts_entity }}"
                              # FIXED v5.0.4: Only activate night glow if lights were previously on
                              - if:
                                  - "{{ allows_turn_on and is_any_light_on and use_night_glow == 'night_glow_enabled' and night_glow_target is not none and night_glow_target != {} and night_glow_target.entity_id is defined and night_glow_target.entity_id | select | list | length > 0 }}"
                                then:
                                  - service: homeassistant.turn_on
                                    target: !input night_glow_lights
                                    data: "{{ night_glow_on_data }}"
                        default:
                          - if:
                              - "{{ allows_turn_off }}"
                            then:
                              - if:
                                  - "{{ (light_control_type_var == 'devices' or light_control_type_var == 'both') and has_light_entity }}"
                                then:
                                  - delay:
                                      milliseconds: 500
                                  - service: homeassistant.turn_off
                                    target: !input light_switch
                                    data: "{{ light_off_data }}"
                              - if:
                                  - "{{ (light_control_type_var == 'scenes' or light_control_type_var == 'both') and has_off_scene }}"
                                then:
                                  - delay:
                                      milliseconds: 500
                                  - repeat:
                                      for_each: !input off_scene
                                      sequence:
                                        - condition: template
                                          value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                                        - service: homeassistant.turn_on
                                          target:
                                            entity_id: "{{ repeat.item }}"
                              - if:
                                  - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                                  - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                then:
                                  - service: input_boolean.turn_off
                                    target:
                                      entity_id: "{{ boolean_scenes_scripts_entity }}"
                      - if:
                          - "{{ allows_turn_off }}"
                        then:
                          - if:
                              - "{{ has_turn_off_only_devices }}"
                            then:
                              - service: homeassistant.turn_off
                                target: !input turn_off_only_entities
                      - if:
                          - "{{ allows_turn_off and manual_control_simple_entity is not none and manual_control_simple_entity != '' }}"
                          - "{{ states(manual_control_simple_entity) not in ['unavailable', 'unknown'] }}"
                        then:
                          - service: input_boolean.turn_off
                            target:
                              entity_id: "{{ manual_control_simple_entity }}"

              # ========================================================================
              # TRIGGER: New Triggers OFF (v5.1.0) - Entity/Button/Sun/Ambient/Time
              # ========================================================================
              - conditions:
                  - condition: trigger
                    id:
                      - entity_trigger_off
                      - button_trigger_off
                      - sun_trigger_off
                      - ambient_trigger_off
                      - time_trigger_off
                sequence:
                  # BUG FIX v5.2.7: Check if triggered feature is actually enabled
                  # Without this check, triggers fire even when feature is disabled
                  - if:
                      - condition: template
                        value_template: >-
                          {{
                            (trigger.id == 'entity_trigger_off' and include_entity_off) or
                            (trigger.id == 'button_trigger_off' and include_button_off) or
                            (trigger.id == 'sun_trigger_off' and include_sun_rising and state_attr('sun.sun', 'rising') == true) or
                            (trigger.id == 'ambient_trigger_off' and include_ambient_high) or
                            (trigger.id == 'time_trigger_off' and include_time_off)
                          }}
                    then:
                      # Check if ALL triggers are clear (no time delay for new triggers)
                      # v5.4.0: Real-time evaluation
                      - wait_template: >-
                          {% set old_triggers_clear = operating_mode != 'simple' or trigger_sensor_entity is none or trigger_sensor_entity | length == 0 or expand(trigger_sensor_entity) | selectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length == expand(trigger_sensor_entity) | list | length %}
                          {% set entity_on = include_entity_on and entity_input_var != [] and entity_input_var is not none and is_state(entity_input_var, 'on') %}
                          {% set sun_low = include_sun_falling and state_attr('sun.sun', 'elevation')|float(100) < sun_elevation_falling_var %}
                          {% set lux_low = include_ambient_low and ambient_light_sensor_var != [] and ambient_light_sensor_var is not none and states(ambient_light_sensor_var)|float(999) < ambient_light_low_var %}
                          {% set new_triggers_clear = not (entity_on or sun_low or lux_low) %}
                          {{ old_triggers_clear and new_triggers_clear }}
                        timeout:
                          seconds: 5
                        continue_on_timeout: true
                      
                      # Check still mode before turning off
                      # v5.4.0: Real-time evaluation
                      - if:
                          - condition: template
                            value_template: >-
                              {% set old_triggers_clear = operating_mode != 'simple' or trigger_sensor_entity is none or trigger_sensor_entity | length == 0 or expand(trigger_sensor_entity) | selectattr('state', 'in', ['off', 'unavailable', 'unknown']) | list | length == expand(trigger_sensor_entity) | list | length %}
                              {% set entity_on = include_entity_on and entity_input_var != [] and entity_input_var is not none and is_state(entity_input_var, 'on') %}
                              {% set sun_low = include_sun_falling and state_attr('sun.sun', 'elevation')|float(100) < sun_elevation_falling_var %}
                              {% set lux_low = include_ambient_low and ambient_light_sensor_var != [] and ambient_light_sensor_var is not none and states(ambient_light_sensor_var)|float(999) < ambient_light_low_var %}
                              {% set new_triggers_clear = not (entity_on or sun_low or lux_low) %}
                              {% set all_triggers_clear = old_triggers_clear and new_triggers_clear %}
                              {{ all_triggers_clear and not presence_detection_active }}
                        then:
                          - choose:
                              - conditions:
                                  - "{{ night_lights_active }}"
                                sequence:
                                  - if:
                                      - "{{ allows_turn_off }}"
                                    then:
                                      # Turn off main lights if they exist
                                      - if:
                                          - "{{ (light_control_type_var == 'devices' or light_control_type_var == 'both') and has_light_entity }}"
                                        then:
                                          - delay:
                                              milliseconds: 500
                                          - service: homeassistant.turn_off
                                            target: !input light_switch
                                            data: "{{ light_off_data }}"
                                      # Activate off-scene if it exists
                                      - if:
                                          - "{{ (light_control_type_var == 'scenes' or light_control_type_var == 'both') and has_off_scene }}"
                                        then:
                                          - delay:
                                              milliseconds: 500
                                          - repeat:
                                              for_each: !input off_scene
                                              sequence:
                                                - condition: template
                                                  value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                                                - service: homeassistant.turn_on
                                                  target:
                                                    entity_id: "{{ repeat.item }}"
                                  # Reset main scene helper
                                  - if:
                                      - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                                      - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                    then:
                                      - service: input_boolean.turn_off
                                        target:
                                          entity_id: "{{ boolean_scenes_scripts_entity }}"
                                  # Turn off night lights
                                  - if:
                                      - "{{ night_lights_target is not none and night_lights_target != {} and night_lights_target.entity_id is defined and night_lights_target.entity_id | select | list | length > 0 }}"
                                    then:
                                      - delay:
                                          milliseconds: 500
                                      - service: homeassistant.turn_off
                                        target: !input night_lights
                                        data: "{{ night_light_off_data }}"
                                  - if:
                                      - "{{ night_boolean_scenes_scripts_entity is not none and night_boolean_scenes_scripts_entity != '' }}"
                                      - "{{ states(night_boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                    then:
                                      - service: input_boolean.turn_off
                                        target:
                                          entity_id: "{{ night_boolean_scenes_scripts_entity }}"
                              # Activate night glow if lights were previously on
                              - conditions:
                                  - "{{ allows_turn_on and is_any_light_on and use_night_glow == 'night_glow_enabled' and night_glow_target is not none and night_glow_target != {} and night_glow_target.entity_id is defined and night_glow_target.entity_id | select | list | length > 0 }}"
                                sequence:
                                  - service: homeassistant.turn_on
                                    target: !input night_glow_lights
                                    data: "{{ night_glow_on_data }}"
                            default:
                              - if:
                                  - "{{ allows_turn_off }}"
                                then:
                                  - if:
                                      - "{{ (light_control_type_var == 'devices' or light_control_type_var == 'both') and has_light_entity }}"
                                    then:
                                      - delay:
                                          milliseconds: 500
                                      - service: homeassistant.turn_off
                                        target: !input light_switch
                                        data: "{{ light_off_data }}"
                                  - if:
                                      - "{{ (light_control_type_var == 'scenes' or light_control_type_var == 'both') and has_off_scene }}"
                                    then:
                                      - delay:
                                          milliseconds: 500
                                      - repeat:
                                          for_each: !input off_scene
                                          sequence:
                                            - condition: template
                                              value_template: "{{ states(repeat.item) not in ['unavailable', 'unknown'] }}"
                                            - service: homeassistant.turn_on
                                              target:
                                                entity_id: "{{ repeat.item }}"
                                  - if:
                                      - "{{ boolean_scenes_scripts_entity is not none and boolean_scenes_scripts_entity != '' }}"
                                      - "{{ states(boolean_scenes_scripts_entity) not in ['unavailable', 'unknown'] }}"
                                    then:
                                      - service: input_boolean.turn_off
                                        target:
                                          entity_id: "{{ boolean_scenes_scripts_entity }}"
                      - if:
                          - "{{ allows_turn_off }}"
                        then:
                          - if:
                              - "{{ has_turn_off_only_devices }}"
                            then:
                              - service: homeassistant.turn_off
                                target: !input turn_off_only_entities
                      - if:
                          - "{{ allows_turn_off and manual_control_simple_entity is not none and manual_control_simple_entity != '' }}"
                          - "{{ states(manual_control_simple_entity) not in ['unavailable', 'unknown'] }}"
                        then:
                          - service: input_boolean.turn_off
                            target:
                              entity_id: "{{ manual_control_simple_entity }}"
                    else:
                      - stop: "Trigger fired but feature not enabled"

trace:
  stored_traces: !input trace_limit

mode: restart
max_exceeded: silent
